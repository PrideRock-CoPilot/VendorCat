name: Canonical CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["main"]

env:
  PYTHON_VERSION: "3.11"
  PYTHONPATH: "src"
  DJANGO_SETTINGS_MODULE: "vendorcatalog_rebuild.settings"
  VC_RUNTIME_PROFILE: "local"
  VC_LOCAL_DUCKDB_PATH: "src/.local/vendorcatalog-ci.duckdb"

jobs:
  quality:
    name: Lint + Type + Guards
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-rebuild.txt

      - name: Ruff
        run: python -m ruff check scripts/runtime tests_rebuild/guards

      - name: Mypy
        run: python -m mypy --config-file mypy-rebuild.ini scripts/runtime tests_rebuild/guards

      - name: Schema contract validation
        run: python scripts/runtime/validate_schema.py

      - name: SQL coverage validation
        run: python scripts/runtime/validate_sql_coverage.py

      - name: Architecture guards
        run: python -m pytest -q tests_rebuild/guards

  test:
    name: Canonical tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-rebuild.txt

      - name: Collect tests
        run: python -m pytest --collect-only -q tests_rebuild

      - name: Run test suite
        run: python -m pytest tests_rebuild --cov=apps --cov=vendorcatalog_rebuild --cov-report=term-missing

  playwright-smoke:
    name: Playwright Chromium Smoke
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-rebuild.txt
          python -m playwright install --with-deps chromium

      - name: Launch browser smoke
        run: |
          python - <<'PY'
          from playwright.sync_api import sync_playwright

          with sync_playwright() as p:
              browser = p.chromium.launch(headless=True)
              page = browser.new_page()
              page.goto("data:text/html,<title>VendorCatalog Smoke</title><h1>ok</h1>")
              assert "VendorCatalog Smoke" in page.title()
              browser.close()
          PY
