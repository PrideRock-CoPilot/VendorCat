{% extends "base.html" %}
{% block content %}
<section class="card section-divider terms-card">
  <div class="section-header">
    <div>
      <h1>{{ terms.title }}</h1>
      <p class="muted">
        Effective Date: <strong>{{ terms.effective_date }}</strong>
        | Version: <strong>{{ terms.version }}</strong>
      </p>
    </div>
  </div>

  <div class="flash info">
    This application is for internal proof-of-concept use only and is not approved for enterprise production data.
  </div>

  <div id="terms-scroll-box" class="terms-scroll-box" tabindex="0" aria-label="Terms and conditions scroll area">
    {% for section in terms.sections %}
    <p>{{ section }}</p>
    {% endfor %}
  </div>

  <form method="post" action="/access/terms/accept" id="terms-accept-form" class="terms-accept-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <input type="hidden" name="next" value="{{ next_path }}">
    <input type="hidden" name="terms_version" value="{{ terms.version }}">
    <input type="hidden" name="scrolled_to_end" id="scrolled-to-end-input" value="false">
    <label class="terms-agree-row">
      <input type="checkbox" id="agree-terms-checkbox" name="agree_terms" value="true" disabled>
      <span>I have read and agree to these terms for this version.</span>
    </label>
    <div class="button-group">
      <button type="submit" id="accept-terms-button" disabled>Accept And Continue</button>
      <a class="button-link subtle" href="/access/request">Request Access</a>
    </div>
  </form>
</section>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const scrollBox = document.getElementById("terms-scroll-box");
  const agreeCheckbox = document.getElementById("agree-terms-checkbox");
  const acceptButton = document.getElementById("accept-terms-button");
  const scrolledToEndInput = document.getElementById("scrolled-to-end-input");
  if (!scrollBox || !agreeCheckbox || !acceptButton || !scrolledToEndInput) {
    return;
  }

  let scrolledToEnd = false;
  const nearBottom = () => (scrollBox.scrollTop + scrollBox.clientHeight) >= (scrollBox.scrollHeight - 8);

  const refresh = () => {
    if (nearBottom()) {
      scrolledToEnd = true;
      scrolledToEndInput.value = "true";
      agreeCheckbox.disabled = false;
    }
    acceptButton.disabled = !(scrolledToEnd && agreeCheckbox.checked);
  };

  scrollBox.addEventListener("scroll", refresh);
  agreeCheckbox.addEventListener("change", refresh);
  refresh();
})();
</script>
{% endblock %}
