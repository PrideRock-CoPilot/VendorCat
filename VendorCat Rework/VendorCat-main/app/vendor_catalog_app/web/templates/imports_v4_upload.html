{% extends "base.html" %}

{% block head %}
  <link rel="stylesheet" href="/static/css/imports_wizard.css?v={{ static_asset_version }}">
{% endblock %}

{% block content %}
<div class="section-header">
  <div>
    <h1>Data Imports</h1>
    <p>Upload files and continue to mapping.</p>
  </div>
  <div class="button-group">
    <label style="display:grid; gap:4px; min-width: 240px;">
      Templates
      <select id="template-layout-select">
        {% for option in layout_options %}
        <option value="{{ option.key }}" {% if option.key == selected_layout %}selected{% endif %}>{{ option.label }}</option>
        {% endfor %}
      </select>
    </label>
    <a id="template-download-link" class="button-link subtle" href="/imports/templates/{{ selected_layout }}.csv">Download Template</a>
  </div>
</div>

<section class="card section-divider">
  <h2>Upload File</h2>
  <p>Source System is required. Upload one or more files to begin preview and mapping.</p>
  <form method="post" action="/imports/preview" enctype="multipart/form-data" class="grid grid-2">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <input type="hidden" name="layout" value="{{ selected_layout }}">
    <label>
      Files
      <input type="file" name="files" multiple required accept=".csv,.tsv,.txt,.json,.xml,.zip">
    </label>
    <label>
      Source System
      <select name="source_system" required>
        <option value="">Select source system</option>
        {% for option in source_system_options %}
        <option value="{{ option.key }}" {% if option.key == selected_source_system %}selected{% endif %}>{{ option.label }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="full">
      Approved Mapping Profile (Optional)
      <select name="mapping_profile_id">
        <option value="">No mapping profile selected</option>
        {% for profile in mapping_profiles %}
        <option value="{{ profile.profile_id }}">
          {{ profile.profile_name }}{% if profile.file_format %} ({{ profile.file_format|upper }}){% endif %}
        </option>
        {% endfor %}
      </select>
    </label>

    <details class="full">
      <summary>Parser Options</summary>
      <div class="grid grid-2" style="margin-top:10px;">
        <label>
          Parser Mode
          <select name="format_hint">
            {% for option in file_format_options %}
            <option value="{{ option.key }}">{{ option.label }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Delimiter
          <input type="text" name="delimiter" value="," placeholder=", | ; or \t">
        </label>
        <label>
          JSON Record Path
          <input type="text" name="json_record_path" placeholder="records.items">
        </label>
        <label>
          XML Record Path
          <input type="text" name="xml_record_path" placeholder="vendors.vendor">
        </label>
        <label>
          XML Record Tag (Legacy)
          <input type="text" name="xml_record_tag" placeholder="vendor">
        </label>
      </div>
    </details>

    <div class="full">
      <button type="submit">Upload And Preview</button>
    </div>
  </form>
</section>

<section class="card section-divider">
  <h2>My Mapping Requests</h2>
  {% if my_mapping_requests %}
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Requested At</th>
          <th>Name</th>
          <th>Layout</th>
          <th>Status</th>
          <th>Reviewer Note</th>
        </tr>
      </thead>
      <tbody>
        {% for row in my_mapping_requests %}
        <tr>
          <td>{{ row.created_at }}</td>
          <td>{{ row.proposed_profile_name or row.profile_request_id }}</td>
          <td>{{ row.layout_key }}</td>
          <td>{{ row.status }}</td>
          <td>{{ row.review_note or "-" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="muted">No mapping requests yet.</p>
  {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const layoutSelect = document.getElementById('template-layout-select');
  const downloadLink = document.getElementById('template-download-link');
  const layoutInput = document.querySelector('input[name="layout"]');
  if (!layoutSelect || !downloadLink || !layoutInput) return;

  const sync = () => {
    const key = String(layoutSelect.value || 'vendors').trim() || 'vendors';
    downloadLink.setAttribute('href', `/imports/templates/${encodeURIComponent(key)}.csv`);
    layoutInput.value = key;
  };

  layoutSelect.addEventListener('change', sync);
  sync();
})();
</script>
{% endblock %}
