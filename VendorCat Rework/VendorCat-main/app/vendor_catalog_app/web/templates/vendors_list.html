{% extends "base.html" %}
{% block content %}
{% set header_labels = {
  "display_name": "Display Name",
  "vendor_id": "Vendor ID",
  "legal_name": "Legal Name",
  "lifecycle_state": "Lifecycle State",
  "owner_org_id": "Business Unit",
  "risk_tier": "Risk Tier",
  "updated_at": "Updated At"
} %}
<h1>Vendor 360</h1>

<section class="card section-divider">
  <h2>Workspace Flow</h2>
  <p class="muted">
    Navigate the full hierarchy: Vendor -> Offerings -> Business Unit/Profile -> Contacts/Owners -> Contracts -> Data Flows -> Documents.
  </p>
</section>

<form method="get" action="/vendors" class="card grid grid-5">
  <label title="Search a business owner like 'bob smith' to find all related vendors and offerings.">
    Search related data
    <input type="text" name="q" value="{{ filters.q }}" placeholder="Vendor, offering, contract, owner, contact, demo...">
  </label>
  <label>
    Status
    <select name="status">
      {% for option in status_options %}
      <option value="{{ option }}" {% if option == filters.status %}selected{% endif %}>{{ option }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Business Unit
    <select name="owner">
      {% for option in owner_options %}
      <option value="{{ option }}" {% if option == filters.owner %}selected{% endif %}>{{ option }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Risk
    <select name="risk">
      {% for option in risk_options %}
      <option value="{{ option }}" {% if option == filters.risk %}selected{% endif %}>{{ option }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Page Size
    <select name="page_size">
      {% for size in page_sizes %}
      <option value="{{ size }}" {% if size == filters.page_size %}selected{% endif %}>{{ size }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Group By
    <select name="group">
      {% for option in group_options %}
      <option value="{{ option }}" {% if option == filters.group %}selected{% endif %}>{{ option }}</option>
      {% endfor %}
    </select>
  </label>
  <input type="hidden" name="sort_by" value="{{ filters.sort_by }}">
  <input type="hidden" name="sort_dir" value="{{ filters.sort_dir }}">
  <input type="hidden" name="page" value="1">
  <input type="hidden" name="show_settings" value="{{ 1 if show_settings else 0 }}">
  <div>
    <button type="submit">Apply Filters</button>
  </div>
</form>

{% if grouped %}
<section class="card">
  <h2>Group Summary</h2>
  <table>
    <thead><tr><th>{{ filters.group }}</th><th>Vendor Count</th></tr></thead>
    <tbody>
    {% for row in grouped %}
    <tr><td>{{ row[filters.group] }}</td><td>{{ row.vendor_count }}</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

<div class="section-header">
  <div>
    <h2 title="Click a vendor row to open the high-level overview. Use Offerings for deep-dive offering management.">Vendor List</h2>
  </div>
  <div class="button-group">
    <a class="button-link subtle" href="/help/vendor-360-overview">? Vendor 360 Guide</a>
    {% if can_edit and not locked_mode %}
    <a class="button-link" href="/vendors/new?return_to={{ return_to|urlencode }}">+ New Vendor</a>
    {% endif %}
    <a class="button-link settings-toggle" href="{{ settings_toggle_url }}">
      {% if show_settings %}&#9881; Hide Fields{% else %}&#9881; Field Settings{% endif %}
    </a>
  </div>
</div>

{% if show_settings %}
<section class="card">
  <h2>Field Matrix</h2>
  <form method="post" action="/vendors/settings">
    <input type="hidden" name="return_to" value="{{ return_to }}">
    <table>
      <thead><tr><th>Show</th><th>Order</th><th>Field</th></tr></thead>
      <tbody>
      {% for field in all_fields %}
      <tr>
        <td>
          <input type="checkbox" name="include_{{ field }}" {% if field in visible_fields %}checked{% endif %}>
        </td>
        <td>
          <input type="number" name="order_{{ field }}" min="1" max="999"
                 value="{{ (visible_fields.index(field) + 1) if field in visible_fields else 999 }}">
        </td>
        <td>
          {{ field }}
          <input type="hidden" name="field_name" value="{{ field }}">
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    <button type="submit">Apply Field Matrix</button>
  </form>
</section>
{% endif %}

{% if not vendors %}
<section class="card empty-state-card section-divider">
  <h2>No Vendors Found</h2>
  <p>Try clearing filters or create a new vendor profile to get started.</p>
  <div class="empty-state-actions">
    <a class="button-link subtle" href="/vendors">Clear Filters</a>
    {% if can_edit and not locked_mode %}
    <a class="button-link" href="/vendors/new?return_to=%2Fvendors">Create Vendor</a>
    {% endif %}
  </div>
</section>
{% endif %}

<section class="card">
  <table id="vendor-table" class="vendor-table">
    <thead>
      <tr>
        {% for field in visible_fields %}
        <th class="sortable-header">
          {% if sort_links.get(field) %}
          <a class="sortable-header-link" href="{{ sort_links.get(field) }}">{{ header_labels.get(field, field|replace('_', ' ')|title) }}</a>
          {% if filters.sort_by == 'vendor_name' and field == 'display_name' %}
          <small class="sort-indicator">{% if filters.sort_dir == 'asc' %}&#8593;{% else %}&#8595;{% endif %}</small>
          {% elif filters.sort_by == field %}
          <small class="sort-indicator">{% if filters.sort_dir == 'asc' %}&#8593;{% else %}&#8595;{% endif %}</small>
          {% endif %}
          {% else %}
          {{ header_labels.get(field, field|replace('_', ' ')|title) }}
          {% endif %}
        </th>
        {% endfor %}
        <th>Offerings</th>
      </tr>
    </thead>
    <tbody>
      {% for row in vendors %}
      <tr class="clickable-row" data-href="{{ row._vendor_link }}">
        {% for field in visible_fields %}
        <td>
          {% if field == "display_name" %}
          <strong>{{ row[field] }}</strong>
          {% else %}
          {{ row[field] }}
          {% endif %}
        </td>
        {% endfor %}
        <td>
          {% if row._offerings %}
          <div class="offering-chip-list">
            {% for offering in row._offerings %}
            <a class="offering-chip" href="{{ offering._offering_link }}">
              <span>{{ offering.offering_name }}</span>
              <small>{{ offering.lifecycle_state }}</small>
            </a>
            {% endfor %}
          </div>
          {% else %}
          <span class="muted">none</span>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="{{ visible_fields|length + 1 }}">No vendors found</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="section-header" style="margin-top:10px;">
    <p>Showing {{ show_from }}-{{ show_to }} of {{ total_rows }} vendors.</p>
    <div class="button-group">
      <a class="button-link subtle {% if filters.page <= 1 %}disabled{% endif %}" href="{{ prev_page_url }}">Previous</a>
      <span class="pill pagination-pill">Page {{ filters.page }} of {{ page_count }}</span>
      <a class="button-link subtle {% if filters.page >= page_count %}disabled{% endif %}" href="{{ next_page_url }}">Next</a>
    </div>
  </div>
</section>
{% endblock %}
