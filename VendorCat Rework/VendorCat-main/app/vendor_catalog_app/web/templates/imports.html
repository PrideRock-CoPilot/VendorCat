{% extends "base.html" %}
{% block content %}
<div class="section-header">
  <div>
    <h1>Data Imports</h1>
    <p>Use quick upload for approved layouts, or launch the wizard for everything else.</p>
  </div>
</div>

<section class="card section-divider">
  <div class="import-wizard-steps">
    <span class="status-badge {{ 'status-ready' if wizard_step in ['upload', 'preview', 'complete'] else 'status-same' }}">1. Upload</span>
    <span class="status-badge {{ 'status-ready' if wizard_step in ['preview', 'complete'] else 'status-same' }}">2. Detect & Stage</span>
    <span class="status-badge {{ 'status-ready' if wizard_step in ['preview', 'complete'] else 'status-same' }}">3. Preview & Map</span>
    <span class="status-badge {{ 'status-ready' if wizard_step == 'complete' else 'status-same' }}">4. Merge</span>
  </div>

  <form method="post" action="/imports/preview" enctype="multipart/form-data" id="import-start-form">
    <input type="hidden" name="flow_mode" id="flow-mode-input" value="{{ selected_flow_mode }}">
    <div class="grid grid-4">
      <label>
        Upload File
        <input type="file" name="file" id="ingestion-file-input" required>
      </label>

      <label>
        Layout
        <select name="layout">
          {% for option in layout_options %}
          <option value="{{ option.key }}" {% if option.key == selected_layout %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>

      <label>
        Source System
        <select name="source_system">
          {% for option in source_system_options %}
          <option value="{{ option.key }}" {% if option.key == selected_source_system %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>

      <label>
        Source Object
        <input type="text" name="source_object" value="{{ source_object }}" placeholder="table/feed/file group">
      </label>
    </div>

    <div id="ingestion-route-hint" class="flash info" style="display:none;"></div>

    <section id="quick-upload-panel" class="import-flow-panel">
      <h3>Quick Upload (Approved Layouts)</h3>
      <p class="muted">For approved CSV/TSV templates only. Header layout must match the official template exactly.</p>
      <div class="button-group">
        <button type="submit" id="quick-submit-button">Quick Preview</button>
        <button type="button" class="button-link subtle" id="open-wizard-button">Use Wizard Instead</button>
      </div>
    </section>

    <section id="wizard-upload-panel" class="import-flow-panel" style="display:none;">
      <h3>Advanced Wizard</h3>
      <p class="muted">Auto-opened for JSON/XML/other formats or custom parsing needs.</p>
      <div class="grid grid-5">
        <label>
          Parser Mode
          <select name="format_hint" id="format-hint-select">
            {% for option in file_format_options %}
            <option value="{{ option.key }}" {% if option.key == parser_options.format_hint %}selected{% endif %}>{{ option.label }}</option>
            {% endfor %}
          </select>
        </label>

        <label data-format-option="delimiter">
          Delimiter
          <input type="text" name="delimiter" value="{{ parser_options.delimiter }}" placeholder=", | ; or \t">
        </label>

        <label data-format-option="json">
          JSON Record Path
          <input type="text" name="json_record_path" value="{{ parser_options.json_record_path }}" placeholder="records.items">
        </label>

        <label data-format-option="xml">
          XML Record Tag
          <input type="text" name="xml_record_tag" value="{{ parser_options.xml_record_tag }}" placeholder="vendor">
        </label>

        <label>
          Saved Mapping
          <select name="mapping_profile_id" id="mapping-profile-select">
            <option value="">No saved mapping</option>
            {% for profile in mapping_profiles %}
            <option value="{{ profile.profile_id }}" {% if selected_mapping_profile_id == profile.profile_id %}selected{% endif %}>
              {{ profile.profile_name }}{% if profile.file_format %} ({{ profile.file_format|upper }}){% endif %}
            </option>
            {% endfor %}
          </select>
        </label>
      </div>
      <div class="button-group">
        <button type="submit" id="wizard-submit-button">Launch Wizard Preview</button>
        <button type="button" class="button-link subtle" id="back-to-quick-button">Back To Quick Upload</button>
      </div>
    </section>
  </form>

  <p class="muted">{{ selected_layout_spec.description }}</p>
  <p class="muted">Columns: {{ selected_layout_spec.fields|join(", ") }}</p>
  {% if source_file_name %}
  <p class="muted">
    File: <strong>{{ source_file_name }}</strong>
    {% if detected_file_type %}| detected={{ detected_file_type }}{% endif %}
    {% if effective_file_type %}| parser={{ effective_file_type }}{% endif %}
  </p>
  {% endif %}
  {% for warning in parser_warnings %}
  <div class="flash info">{{ warning }}</div>
  {% endfor %}
  {% if staging_warning %}
  <div class="flash info">{{ staging_warning }}</div>
  {% endif %}
  {% if staging_job_id %}
  <p class="muted">Staging job: <strong>{{ staging_job_id }}</strong> | staged rows: <strong>{{ staged_row_count }}</strong></p>
  {% endif %}

  <h3>Sample Templates</h3>
  <div class="button-group">
    {% for option in layout_options %}
    <a class="button-link subtle" href="/imports/templates/{{ option.key }}.csv">{{ option.label }} Template</a>
    {% endfor %}
  </div>
</section>

{% if preview_rows %}
<section class="card section-divider">
  <div class="section-header">
    <div>
      <h2>Preview And Mapping</h2>
      {% if preview_hidden_count %}
      <p>Showing {{ preview_rows|length }} of {{ preview_total_rows }} row(s) for layout "{{ selected_layout_spec.label }}".</p>
      <p class="muted">{{ preview_hidden_count }} additional row(s) are loaded and will still apply using defaults unless overridden.</p>
      {% else %}
      <p>{{ preview_total_rows or (preview_rows|length) }} row(s) parsed for layout "{{ selected_layout_spec.label }}".</p>
      {% endif %}
    </div>
  </div>

  <section class="bulk-defaults-card">
    <h3>Source Tag/Column Mapping</h3>
    <p class="muted">Detected source fields are shown from the uploaded file. Adjust mappings, then rebuild preview.</p>
    {% if mapping_profile_saved %}
    <div class="flash success">Saved mapping profile: <strong>{{ mapping_profile_saved }}</strong></div>
    {% endif %}
    <form method="post" action="/imports/remap">
      <input type="hidden" name="preview_token" value="{{ preview_token }}">
      <div class="grid grid-3">
        <label>
          Mapping Profile
          <select name="mapping_profile_id">
            <option value="">Use current mapping</option>
            {% for profile in mapping_profiles %}
            <option value="{{ profile.profile_id }}" {% if selected_mapping_profile_id == profile.profile_id %}selected{% endif %}>
              {{ profile.profile_name }}{% if profile.file_format %} ({{ profile.file_format|upper }}){% endif %}{% if profile.compatible is defined and not profile.compatible %} - signature differs{% endif %}
            </option>
            {% endfor %}
          </select>
        </label>
        <label>
          Save Mapping As
          <input type="text" name="mapping_profile_name" placeholder="optional profile name">
        </label>
        <div class="button-group form-actions">
          <button type="submit">Rebuild Preview With Mapping</button>
        </div>
      </div>
      <div class="table-wrap table-scroll">
        <table>
          <thead>
            <tr>
              <th>Source Tag/Column (Static)</th>
              <th>Sample</th>
              <th>Map To Destination Field</th>
            </tr>
          </thead>
          <tbody>
            {% for source in source_field_map %}
            <tr>
              <td><strong>{{ source.key }}</strong></td>
              <td>{{ source.sample_value }}</td>
              <td>
                <input type="hidden" name="source_field_keys" value="{{ source.key }}">
                <select name="source_target_keys">
                  <option value="">(unmapped)</option>
                  {% for group in target_field_groups %}
                  <optgroup label="{{ group.area_label }} -> {{ group.stage_table }}">
                    {% for option in group.options %}
                    <option value="{{ option.key }}" {% if selected_source_target_mapping.get(source.key, "") == option.key %}selected{% endif %}>
                      {{ option.label }}
                    </option>
                    {% endfor %}
                  </optgroup>
                  {% endfor %}
                </select>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
  </section>

  {% if source_field_map %}
  <section class="bulk-defaults-card">
    <h3>Detected Source Fields</h3>
    <div class="table-wrap table-scroll">
      <table>
        <thead>
          <tr>
            <th>Tag / Column</th>
            <th>Sample Value</th>
            <th>Rows With Value</th>
          </tr>
        </thead>
        <tbody>
          {% for source in source_field_map %}
          <tr>
            <td>{{ source.key }}</td>
            <td>{{ source.sample_value }}</td>
            <td>{{ source.non_empty_count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  {% endif %}

  {% set summary = namespace(error_count=0, review_count=0, ready_count=0, suggested_merge=0, suggested_new=0) %}
  {% for row in preview_rows %}
    {% if row.row_status == "error" %}
      {% set summary.error_count = summary.error_count + 1 %}
    {% elif row.row_status == "review" %}
      {% set summary.review_count = summary.review_count + 1 %}
    {% else %}
      {% set summary.ready_count = summary.ready_count + 1 %}
    {% endif %}
    {% if row.suggested_action == "merge" %}
      {% set summary.suggested_merge = summary.suggested_merge + 1 %}
    {% else %}
      {% set summary.suggested_new = summary.suggested_new + 1 %}
    {% endif %}
  {% endfor %}

  <div class="import-preview-summary">
    <span class="status-badge status-{{ 'error' if summary.error_count else 'ready' }}">Errors: {{ summary.error_count }}</span>
    <span class="status-badge status-review">Needs Review: {{ summary.review_count }}</span>
    <span class="status-badge status-ready">Ready: {{ summary.ready_count }}</span>
    <span class="status-badge status-merged">Suggested Merge: {{ summary.suggested_merge }}</span>
    <span class="status-badge status-new">Suggested New: {{ summary.suggested_new }}</span>
  </div>
  {% if summary.error_count %}
  <div class="flash error">
    {{ summary.error_count }} row(s) have validation errors. Fix action/target values before applying.
  </div>
  {% endif %}

  <form method="post" action="/imports/apply">
    <input type="hidden" name="preview_token" value="{{ preview_token }}">
    <label>
      Merge Reason
      <select name="reason">
        <option value="">Select reason (required for merge actions)</option>
        {% for option in import_merge_reason_options %}
        <option value="{{ option }}" {% if import_reason == option %}selected{% endif %}>{{ option|replace('_', ' ')|title }}</option>
        {% endfor %}
      </select>
    </label>

    <section class="bulk-defaults-card">
      <h3>Bulk Action Defaults</h3>
      <div class="bulk-defaults-row">
        <label>
          Set Action For Rows Without Errors
          <select id="bulk-action-default" name="bulk_default_action">
            <option value="">Keep Suggested Actions</option>
            <option value="new">Set to new</option>
            <option value="merge">Set to merge</option>
            <option value="skip">Set to skip</option>
          </select>
        </label>
        <div class="button-group">
          <button type="button" id="bulk-action-all-new">All New</button>
          <button type="button" id="bulk-action-all-merge">All Merge</button>
          <button type="button" id="bulk-action-all-skip">All Skip</button>
        </div>
      </div>
    </section>

    <div class="table-wrap preview-table-wrap">
      <table>
        <thead>
          <tr>
            <th>Line</th>
            <th>Row Status</th>
            {% for field in selected_layout_spec.fields %}
            <th>{{ field }}</th>
            {% endfor %}
            <th>Match</th>
            <th>Action</th>
            <th>Merge Target</th>
          </tr>
        </thead>
        <tbody>
          {% for row in preview_rows %}
          <tr data-row-status="{{ row.row_status }}" class="import-row-status-{{ row.row_status }}" data-row-index="{{ row.row_index }}">
            <td>{{ row.line_number or row.row_index }}</td>
            <td>
              {% if row.row_status == "error" %}
              <span class="status-badge status-error">error</span>
              {% elif row.row_status == "review" %}
              <span class="status-badge status-review">review</span>
              {% else %}
              <span class="status-badge status-ready">ready</span>
              {% endif %}
            </td>
            {% for field in selected_layout_spec.fields %}
            <td>{{ row.row_data.get(field, "") }}</td>
            {% endfor %}
            <td>
              {% if row.suggested_target_label %}
              <div>{{ row.suggested_target_label }}</div>
              {% else %}
              <div>None</div>
              {% endif %}
              {% for note in row.notes %}
              <div><small class="status-badge status-review">{{ note }}</small></div>
              {% endfor %}
              {% for err in row.errors %}
              <div><small class="status-badge status-error">{{ err }}</small></div>
              {% endfor %}
            </td>
            <td>
              <select name="action_{{ row.row_index }}" data-import-action-select>
                <option value="new" {% if row.suggested_action == "new" %}selected{% endif %}>new</option>
                <option value="merge" {% if row.suggested_action == "merge" %}selected{% endif %}>merge</option>
                <option value="skip">skip</option>
              </select>
            </td>
            <td>
              <div class="import-merge-target">
                <input type="hidden" name="target_{{ row.row_index }}" value="{{ row.suggested_target_id }}" data-merge-target-hidden>
                <input
                  type="text"
                  value="{{ row.suggested_target_label or '' }}"
                  list="merge-target-options-{{ row.row_index }}"
                  placeholder="Search and select merge target"
                  data-merge-target-label-input
                >
                <datalist id="merge-target-options-{{ row.row_index }}">
                  {% for option in row.merge_options or [] %}
                  <option value="{{ option.label }}" data-target-id="{{ option.id }}"></option>
                  {% endfor %}
                </datalist>
                {% if not (row.merge_options or []) %}
                <small class="muted">No suggestions yet; adjust row data or keep as new.</small>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="button-group" style="margin-top:10px;">
      <button type="submit">Apply Import</button>
      <a class="button-link subtle" href="/imports">Discard Preview</a>
    </div>
  </form>
</section>
{% endif %}

{% if import_results %}
<section class="card section-divider">
  <h2>Import Results</h2>
  {% if staging_job_id %}
  <p class="muted">Staging job: <strong>{{ staging_job_id }}</strong> finalized.</p>
  {% endif %}
  <table>
    <thead>
      <tr>
        <th>Row</th>
        <th>Status</th>
        <th>Message</th>
      </tr>
    </thead>
    <tbody>
      {% for result in import_results %}
      <tr>
        <td>{{ result.row_index }}</td>
        <td>{{ result.status }}</td>
        <td>{{ result.message }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
(() => {
  const fileInput = document.getElementById("ingestion-file-input");
  const flowModeInput = document.getElementById("flow-mode-input");
  const routeHint = document.getElementById("ingestion-route-hint");
  const quickPanel = document.getElementById("quick-upload-panel");
  const wizardPanel = document.getElementById("wizard-upload-panel");
  const openWizardButton = document.getElementById("open-wizard-button");
  const backToQuickButton = document.getElementById("back-to-quick-button");
  const quickSubmitButton = document.getElementById("quick-submit-button");
  const wizardSubmitButton = document.getElementById("wizard-submit-button");
  const formatSelect = document.getElementById("format-hint-select");
  const delimiterBlock = document.querySelector("[data-format-option='delimiter']");
  const jsonBlock = document.querySelector("[data-format-option='json']");
  const xmlBlock = document.querySelector("[data-format-option='xml']");

  const quickExtensions = new Set(["csv", "tsv"]);
  const wizardExtensions = new Set(["json", "xml"]);

  const setMode = (mode) => {
    const selected = (mode || "quick").toLowerCase() === "wizard" ? "wizard" : "quick";
    if (flowModeInput) {
      flowModeInput.value = selected;
    }
    if (quickPanel) {
      quickPanel.style.display = selected === "quick" ? "" : "none";
    }
    if (wizardPanel) {
      wizardPanel.style.display = selected === "wizard" ? "" : "none";
    }
  };

  const setRouteHint = (message) => {
    if (!routeHint) {
      return;
    }
    const text = String(message || "").trim();
    if (!text) {
      routeHint.style.display = "none";
      routeHint.textContent = "";
      return;
    }
    routeHint.style.display = "";
    routeHint.textContent = text;
  };

  const extensionFromFileName = (name) => {
    const raw = String(name || "").trim().toLowerCase();
    const idx = raw.lastIndexOf(".");
    if (idx <= -1 || idx === raw.length - 1) {
      return "";
    }
    return raw.slice(idx + 1);
  };

  const detectFileTypeKey = (fileObj) => {
    if (!fileObj) {
      return "";
    }
    const ext = extensionFromFileName(fileObj.name || "");
    if (ext) {
      return ext;
    }
    const mime = String(fileObj.type || "").toLowerCase();
    if (mime.includes("json")) return "json";
    if (mime.includes("xml")) return "xml";
    if (mime.includes("csv")) return "csv";
    if (mime.includes("tab-separated") || mime.includes("tsv")) return "tsv";
    return "";
  };

  const routeByFile = (fileObj) => {
    const ext = detectFileTypeKey(fileObj);
    if (!ext) {
      setMode("quick");
      setRouteHint("");
      if (formatSelect) {
        formatSelect.value = "auto";
      }
      return;
    }
    if (quickExtensions.has(ext)) {
      setMode("quick");
      setRouteHint(`Detected .${ext} file. Using Quick Upload for approved layouts.`);
      if (formatSelect) {
        formatSelect.value = "auto";
      }
      return;
    }
    setMode("wizard");
    if (wizardExtensions.has(ext) && formatSelect) {
      formatSelect.value = ext;
    } else if (formatSelect) {
      formatSelect.value = "auto";
    }
    const pretty = ext.toUpperCase();
    setRouteHint(`Detected .${ext} (${pretty}). Advanced Wizard enabled for guided parsing.`);
  };

  const toggleParserBlocks = () => {
    if (!formatSelect) {
      return;
    }
    const value = (formatSelect.value || "").toLowerCase();
    const showDelimiter = value === "auto" || value === "csv" || value === "tsv" || value === "delimited";
    const showJson = value === "auto" || value === "json";
    const showXml = value === "auto" || value === "xml";
    if (delimiterBlock) delimiterBlock.style.display = showDelimiter ? "" : "none";
    if (jsonBlock) jsonBlock.style.display = showJson ? "" : "none";
    if (xmlBlock) xmlBlock.style.display = showXml ? "" : "none";
  };

  if (openWizardButton) {
    openWizardButton.addEventListener("click", () => {
      setMode("wizard");
      setRouteHint("Advanced Wizard enabled. Configure parser settings and continue.");
    });
  }

  if (backToQuickButton) {
    backToQuickButton.addEventListener("click", () => {
      setMode("quick");
      if (formatSelect) {
        formatSelect.value = "auto";
      }
      toggleParserBlocks();
      setRouteHint("Quick Upload enabled for approved layout files.");
    });
  }

  if (quickSubmitButton) {
    quickSubmitButton.addEventListener("click", (event) => {
      const selectedFile = fileInput && fileInput.files && fileInput.files.length ? fileInput.files[0] : null;
      const ext = detectFileTypeKey(selectedFile);
      if (ext && !quickExtensions.has(ext)) {
        event.preventDefault();
        setMode("wizard");
        if (formatSelect && wizardExtensions.has(ext)) {
          formatSelect.value = ext;
        }
        toggleParserBlocks();
        setRouteHint(`Detected .${ext}. Quick Upload is only for approved CSV/TSV layouts, so Wizard is now active.`);
        return;
      }
      setMode("quick");
      if (formatSelect) {
        formatSelect.value = "auto";
      }
      toggleParserBlocks();
    });
  }

  if (wizardSubmitButton) {
    wizardSubmitButton.addEventListener("click", () => {
      setMode("wizard");
      toggleParserBlocks();
    });
  }

  if (fileInput) {
    fileInput.addEventListener("change", () => {
      const selectedFile = fileInput.files && fileInput.files.length ? fileInput.files[0] : null;
      routeByFile(selectedFile);
      toggleParserBlocks();
    });
  }

  if (formatSelect) {
    formatSelect.addEventListener("change", toggleParserBlocks);
  }

  const initialFileName = {{ source_file_name|tojson }};
  const initialEffectiveType = {{ effective_file_type|tojson }};
  const initialFlowMode = {{ selected_flow_mode|tojson }};
  const initialMode = String(initialFlowMode || "").toLowerCase() === "wizard" ? "wizard" : "quick";
  setMode(initialMode);
  if (initialMode === "wizard" && formatSelect && initialEffectiveType) {
    formatSelect.value = String(initialEffectiveType || "auto").toLowerCase();
  }
  if (initialMode !== "wizard") {
    routeByFile(initialFileName ? { name: initialFileName, type: "" } : null);
  } else if (initialFileName) {
    setRouteHint("Advanced Wizard mode is active for this preview.");
  }
  toggleParserBlocks();
})();
</script>

{% if preview_rows %}
<script>
(() => {
  const previewRows = Array.from(document.querySelectorAll("tr[data-row-index]"));
  if (!previewRows.length) {
    return;
  }
  const getRows = () => previewRows.map((row) => ({
    row,
    select: row.querySelector("[data-import-action-select]"),
  })).filter((item) => !!item.row && !!item.select);

  const syncMergeTargetForRow = (row) => {
    const labelInput = row.querySelector("[data-merge-target-label-input]");
    const hiddenInput = row.querySelector("[data-merge-target-hidden]");
    if (!labelInput || !hiddenInput) {
      return;
    }
    const listId = labelInput.getAttribute("list");
    const datalist = listId ? document.getElementById(listId) : null;
    const options = datalist ? Array.from(datalist.querySelectorAll("option")) : [];
    const entered = String(labelInput.value || "").trim();
    const matched = options.find((opt) => String(opt.value || "").trim() === entered);
    hiddenInput.value = matched ? String(matched.getAttribute("data-target-id") || "").trim() : "";
  };

  const hydrateMergeLabelFromHidden = (row) => {
    const labelInput = row.querySelector("[data-merge-target-label-input]");
    const hiddenInput = row.querySelector("[data-merge-target-hidden]");
    if (!labelInput || !hiddenInput) {
      return;
    }
    if (String(labelInput.value || "").trim()) {
      return;
    }
    const currentId = String(hiddenInput.value || "").trim();
    if (!currentId) {
      return;
    }
    const listId = labelInput.getAttribute("list");
    const datalist = listId ? document.getElementById(listId) : null;
    const options = datalist ? Array.from(datalist.querySelectorAll("option")) : [];
    const matched = options.find((opt) => String(opt.getAttribute("data-target-id") || "").trim() === currentId);
    if (matched) {
      labelInput.value = String(matched.value || "").trim();
    }
  };

  const refreshMergeTargetAvailability = (row) => {
    const actionSelect = row.querySelector("[data-import-action-select]");
    const labelInput = row.querySelector("[data-merge-target-label-input]");
    if (!actionSelect || !labelInput) {
      return;
    }
    const mergeEnabled = String(actionSelect.value || "").toLowerCase() === "merge";
    labelInput.disabled = !mergeEnabled;
    labelInput.setAttribute("aria-disabled", mergeEnabled ? "false" : "true");
  };

  const setAllActions = (value, onlyWithoutErrors) => {
    getRows().forEach((item) => {
      const rowStatus = item.row.getAttribute("data-row-status") || "";
      if (onlyWithoutErrors && rowStatus === "error") {
        return;
      }
      item.select.value = value;
      item.select.dispatchEvent(new Event("change", { bubbles: true }));
    });
  };

  const defaultsSelect = document.getElementById("bulk-action-default");
  if (defaultsSelect) {
    defaultsSelect.addEventListener("change", () => {
      const value = defaultsSelect.value;
      if (!value) {
        return;
      }
      setAllActions(value, true);
    });
  }

  const allNew = document.getElementById("bulk-action-all-new");
  if (allNew) {
    allNew.addEventListener("click", () => setAllActions("new", false));
  }
  const allMerge = document.getElementById("bulk-action-all-merge");
  if (allMerge) {
    allMerge.addEventListener("click", () => setAllActions("merge", false));
  }
  const allSkip = document.getElementById("bulk-action-all-skip");
  if (allSkip) {
    allSkip.addEventListener("click", () => setAllActions("skip", false));
  }

  previewRows.forEach((row) => {
    const actionSelect = row.querySelector("[data-import-action-select]");
    const labelInput = row.querySelector("[data-merge-target-label-input]");
    hydrateMergeLabelFromHidden(row);
    refreshMergeTargetAvailability(row);
    if (actionSelect) {
      actionSelect.addEventListener("change", () => refreshMergeTargetAvailability(row));
    }
    if (labelInput) {
      labelInput.addEventListener("input", () => syncMergeTargetForRow(row));
      labelInput.addEventListener("change", () => syncMergeTargetForRow(row));
      labelInput.addEventListener("blur", () => syncMergeTargetForRow(row));
    }
  });
})();
</script>
{% endif %}
{% endblock %}
