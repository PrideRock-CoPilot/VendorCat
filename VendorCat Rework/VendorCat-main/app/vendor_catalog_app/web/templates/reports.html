{% extends "base.html" %}
{% block content %}
<div class="section-header">
  <div>
    <h1>Reports</h1>
    <p>Build custom extracts with tabular or graphical views, download CSV, export a Power BI bundle, or queue email delivery requests.</p>
  </div>
</div>

<form method="get" action="/reports" class="card grid grid-3">
  <input type="hidden" name="run" value="1">
  <input type="hidden" name="dbx_report" value="{{ filters.dbx_report }}">
  <div class="full">
    <h2>Core Filters</h2>
    <p class="muted">Start with these defaults, then open Advanced Filters only if needed.</p>
  </div>
  <label>
    Report Type
    <select name="report_type">
      {% for key, info in report_types.items() %}
      <option value="{{ key }}" {% if key == filters.report_type %}selected{% endif %}>{{ info.label }}</option>
      {% endfor %}
    </select>
    <small class="muted">{{ selected_report.description }}</small>
  </label>
  <label>
    Search
    <input type="text" name="search" value="{{ filters.search }}" placeholder="Name, id, contract, owner, notes...">
  </label>
  <label>
    Vendor
    <select name="vendor">
      {% for option in vendor_options %}
      <option value="{{ option.vendor_id }}" {% if option.vendor_id == filters.vendor %}selected{% endif %}>{{ option.label }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Max Rows
    <select name="limit">
      {% for option in row_limits %}
      <option value="{{ option }}" {% if option == filters.limit %}selected{% endif %}>{{ option }}</option>
      {% endfor %}
    </select>
  </label>
  <div class="button-group">
    <button type="submit">Run Report</button>
    {% if download_url %}
    <a class="button-link subtle" href="{{ download_url }}">Download CSV</a>
    {% endif %}
    {% if powerbi_download_url %}
    <a class="button-link subtle" href="{{ powerbi_download_url }}">Download Power BI Bundle</a>
    {% endif %}
  </div>

  {% set show_advanced = filters.lifecycle_state != "all"
    or filters.project_status != "all"
    or filters.outcome != "all"
    or filters.owner_principal
    or filters.business_unit != "all"
    or filters.horizon_days != 180
    or filters.view_mode != "both" %}
  <details class="full" {% if show_advanced %}open{% endif %}>
    <summary><strong>Advanced Filters</strong></summary>
    <div class="grid grid-3" style="margin-top:10px;">
      <label>
        Lifecycle
        <select name="lifecycle_state">
          {% for option in vendor_lifecycle_states %}
          <option value="{{ option }}" {% if option == filters.lifecycle_state %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        Project Status
        <select name="project_status">
          {% for option in project_statuses %}
          <option value="{{ option }}" {% if option == filters.project_status %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        Demo Outcome
        <select name="outcome">
          {% for option in demo_outcomes %}
          <option value="{{ option }}" {% if option == filters.outcome %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        Owner Principal
        <input type="text" name="owner_principal" value="{{ filters.owner_principal }}" placeholder="bob.smith@example.com">
      </label>
      <label>
        Business Unit
        <select name="business_unit">
          {% for option in orgs %}
          <option value="{{ option }}" {% if option == filters.business_unit %}selected{% endif %}>{{ "All Business Units" if option == "all" else option }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        Renewal Horizon (days)
        <input type="number" name="horizon_days" value="{{ filters.horizon_days }}" min="30" max="730">
      </label>
      <label>
        Result View
        <select name="view_mode">
          {% for option in view_modes %}
          <option value="{{ option }}" {% if option == filters.view_mode %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        Graph Type
        <select name="chart_kind">
          {% for option in chart_kinds %}
          <option value="{{ option }}" {% if option == filters.chart_kind %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        Graph Dimension
        <select name="chart_x">
          {% for option in chart_dimension_options %}
          <option value="{{ option.key }}" {% if option.key == filters.chart_x %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        Graph Metric
        <select name="chart_y">
          {% for option in chart_metric_options %}
          <option value="{{ option.key }}" {% if option.key == filters.chart_y %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
    </div>
  </details>
</form>

{% if databricks_reports %}
<section class="card section-divider">
  <div class="section-header">
    <div>
      <h2>Databricks Native Reports</h2>
      <p>Open reports in Databricks or host a trusted report inline.</p>
    </div>
  </div>
  <table>
    <thead>
      <tr>
        <th>Report</th>
        <th>Description</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for report in databricks_reports %}
      <tr>
        <td>{{ report.label }}</td>
        <td>{{ report.description or "-" }}</td>
        <td>
          <div class="button-group">
            <a class="button-link subtle" href="{{ report.url }}" target="_blank" rel="noopener noreferrer">Open in Databricks</a>
            {% if report.can_embed %}
            <a class="button-link subtle" href="{{ report.embed_link }}">{{ "Embedded" if report.is_selected else "Embed Here" }}</a>
            {% else %}
            <span class="muted">Embed disabled</span>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if selected_databricks_report %}
  <div class="section-divider" style="margin-top:12px; padding-top:12px;">
    <h3>Embedded: {{ selected_databricks_report.label }}</h3>
    {% if selected_databricks_report.description %}
    <p>{{ selected_databricks_report.description }}</p>
    {% endif %}
    <iframe
      title="Databricks report {{ selected_databricks_report.label }}"
      src="{{ selected_databricks_report.embed_url }}"
      loading="lazy"
      referrerpolicy="strict-origin-when-cross-origin"
      style="width:100%; min-height:780px; border:1px solid #e2e8f0; border-radius:10px; background:#ffffff;"
      sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-downloads">
    </iframe>
  </div>
  {% endif %}
</section>
{% endif %}

{% if columns %}
<section class="card section-divider">
  <details>
    <summary><strong>Column Matrix</strong> (select visible/downloaded columns)</summary>
    <form method="get" action="/reports" style="margin-top:10px;" data-columns-form>
      <input type="hidden" name="run" value="1">
      <input type="hidden" name="report_type" value="{{ filters.report_type }}">
      <input type="hidden" name="search" value="{{ filters.search }}">
      <input type="hidden" name="vendor" value="{{ filters.vendor }}">
      <input type="hidden" name="lifecycle_state" value="{{ filters.lifecycle_state }}">
      <input type="hidden" name="project_status" value="{{ filters.project_status }}">
      <input type="hidden" name="outcome" value="{{ filters.outcome }}">
      <input type="hidden" name="owner_principal" value="{{ filters.owner_principal }}">
      <input type="hidden" name="business_unit" value="{{ filters.business_unit }}">
      <input type="hidden" name="horizon_days" value="{{ filters.horizon_days }}">
      <input type="hidden" name="limit" value="{{ filters.limit }}">
      <input type="hidden" name="view_mode" value="{{ filters.view_mode }}">
      <input type="hidden" name="chart_kind" value="{{ filters.chart_kind }}">
      <input type="hidden" name="chart_x" value="{{ filters.chart_x }}">
      <input type="hidden" name="chart_y" value="{{ filters.chart_y }}">
      <input type="hidden" name="dbx_report" value="{{ filters.dbx_report }}">
      <input type="hidden" name="cols" value="{{ selected_columns|join(',') }}" data-cols-target>
      <div class="grid grid-5">
        {% for column in columns %}
        <label>
          <input type="checkbox" value="{{ column }}" data-column-toggle {% if column in selected_columns %}checked{% endif %}>
          {{ column }}
        </label>
        {% endfor %}
      </div>
      <div class="button-group" style="margin-top:8px;">
        <button type="submit">Apply Columns</button>
      </div>
    </form>
  </details>
</section>
{% endif %}

{% if filters.run == 1 and show_chart %}
<section class="card section-divider">
  <div class="section-header">
    <div>
      <h2>Graph View</h2>
      <p>{{ chart_dimension_label }} vs {{ chart_metric_label }}{% if chart_rows %} ({{ chart_rows|length }} points){% endif %}.</p>
    </div>
  </div>
  {% if chart_rows %}
    {% if filters.chart_kind == "line" %}
    <svg class="line-chart" viewBox="0 0 100 100" preserveAspectRatio="none" aria-label="line chart">
      <line class="axis-line" x1="5" y1="90" x2="95" y2="90"></line>
      <line class="axis-line" x1="5" y1="10" x2="5" y2="90"></line>
      <polyline class="trend-line" points="{{ chart_line_path }}"></polyline>
      {% for point in chart_line_points %}
      <circle class="trend-point" cx="{{ point.x }}" cy="{{ point.y }}" r="1.4">
        <title>{{ point.label }}: {{ point.value_display }}</title>
      </circle>
      {% endfor %}
    </svg>
    {% else %}
    <div class="graph-block">
      {% for row in chart_rows %}
      <div class="bar-row">
        <div class="bar-label">{{ row.label }}</div>
        <div class="bar-track"><div class="bar-fill" style="width: {{ row.width_pct }}%;"></div></div>
        <div class="bar-value">{{ row.value_display }} <small class="muted">({{ row.share_pct }}%)</small></div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <table class="compact-table">
      <thead>
        <tr>
          <th>{{ chart_dimension_label }}</th>
          <th>{{ chart_metric_label }}</th>
          <th>% Share</th>
        </tr>
      </thead>
      <tbody>
        {% for row in chart_rows %}
        <tr>
          <td>{{ row.label }}</td>
          <td>{{ row.value_display }}</td>
          <td>{{ row.share_pct }}%</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
  <p class="muted">{{ chart_empty_message }}</p>
  {% endif %}
</section>
{% endif %}

{% if filters.run == 1 and show_table %}
<section class="card section-divider">
  <div class="section-header">
    <div>
      <h2>Table View</h2>
      <p>{{ row_count }} total rows. Showing {{ preview_count }} row preview.</p>
    </div>
  </div>
  <table>
    <thead>
      <tr>
        {% for column in selected_columns %}
        <th>{{ column }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
      <tr>
        {% for column in selected_columns %}
        <td>{{ row[column] }}</td>
        {% endfor %}
      </tr>
      {% else %}
      <tr><td colspan="{{ selected_columns|length if selected_columns else 1 }}">No rows found for selected filters.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

{% if filters.run == 1 %}
<section class="card section-divider">
  <h2>Email Extract Request</h2>
  <p>Queue a delivery request. The request metadata is captured for downstream email processing.</p>
  <form method="post" action="/reports/email" class="grid grid-3">
    <input type="hidden" name="report_type" value="{{ filters.report_type }}">
    <input type="hidden" name="search" value="{{ filters.search }}">
    <input type="hidden" name="vendor" value="{{ filters.vendor }}">
    <input type="hidden" name="lifecycle_state" value="{{ filters.lifecycle_state }}">
    <input type="hidden" name="project_status" value="{{ filters.project_status }}">
    <input type="hidden" name="outcome" value="{{ filters.outcome }}">
    <input type="hidden" name="owner_principal" value="{{ filters.owner_principal }}">
    <input type="hidden" name="business_unit" value="{{ filters.business_unit }}">
    <input type="hidden" name="horizon_days" value="{{ filters.horizon_days }}">
    <input type="hidden" name="limit" value="{{ filters.limit }}">
    <input type="hidden" name="view_mode" value="{{ filters.view_mode }}">
    <input type="hidden" name="chart_kind" value="{{ filters.chart_kind }}">
    <input type="hidden" name="chart_x" value="{{ filters.chart_x }}">
    <input type="hidden" name="chart_y" value="{{ filters.chart_y }}">
    <input type="hidden" name="dbx_report" value="{{ filters.dbx_report }}">
    <input type="hidden" name="cols" value="{{ selected_columns|join(',') }}">
    <label>
      To
      <input type="email" name="email_to" placeholder="recipient@example.com" required>
    </label>
    <label>
      Subject
      <input type="text" name="email_subject" placeholder="{{ selected_report.label }} Extract">
    </label>
    <div style="display:flex; align-items:flex-end;">
      <button type="submit">Queue Email Request</button>
    </div>
  </form>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll("[data-columns-form]").forEach((form) => {
  const target = form.querySelector("[data-cols-target]");
  if (!target) return;
  form.addEventListener("submit", () => {
    const selected = Array.from(form.querySelectorAll("[data-column-toggle]:checked")).map((el) => el.value);
    target.value = selected.join(",");
  });
});
</script>
{% endblock %}

