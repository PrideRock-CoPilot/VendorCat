{% extends "base.html" %}
{% block content %}
<section class="card dashboard-hero">
  <div>
    <p class="dashboard-eyebrow">Command Center</p>
    <h1>Executive Overview</h1>
    <p>Track vendor health, offerings, contracts, and renewals from one workspace.</p>
  </div>
  <div class="button-group">
    <a class="button-link subtle" href="/vendor-360">Open Vendor 360</a>
    <a class="button-link subtle" href="/contracts">Open Contracts Hub</a>
    <a class="button-link subtle" href="/reports">Open Reports</a>
  </div>
</section>

<section class="card dashboard-flow">
  <h2>Operational Flow</h2>
  <div class="section-nav-links">
    <a href="/vendor-360">Vendors</a>
    <a href="/vendor-360">Offerings</a>
    <a href="/contracts">Contracts</a>
    <a href="/imports">Imports</a>
    <a href="/reports">Reports</a>
    <a href="/help">Help</a>
  </div>
</section>

<form method="get" action="/dashboard" class="card grid grid-3 dashboard-filter-bar">
  <label>
    Business Unit
    <select name="business_unit">
      {% for option in orgs %}
      <option value="{{ option }}" {% if option == selected_business_unit %}selected{% endif %}>{{ "All Business Units" if option == "all" else option }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Spend Window (months)
    <select name="months">
      {% for m in [3, 6, 9, 12, 18, 24] %}
      <option value="{{ m }}" {% if m == months %}selected{% endif %}>{{ m }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Renewal Horizon (days)
    <select name="horizon_days">
      {% for d in [60, 90, 120, 180, 270, 365] %}
      <option value="{{ d }}" {% if d == horizon_days %}selected{% endif %}>{{ d }}</option>
      {% endfor %}
    </select>
  </label>
  <div>
    <button type="submit">Apply</button>
  </div>
</form>

<section class="metrics dashboard-kpi-row">
  <div class="metric metric-priority"><span>Spend ({{ months }}m)</span><strong>${{ "{:,.0f}".format(summary.total_spend_window) }}</strong></div>
  <div class="metric metric-priority"><span>High/Critical Risk</span><strong>{{ summary.high_risk_vendors|int }}</strong></div>
  <div class="metric metric-priority"><span>Renewals Due</span><strong>{{ summary.renewals_due_count|int }}</strong></div>
  <div class="metric"><span>Active Vendors</span><strong>{{ kpis.active_vendors }}</strong></div>
  <div class="metric"><span>Active Offerings</span><strong>{{ kpis.active_offerings }}</strong></div>
  <div class="metric"><span>Not-Selected Demo Rate</span><strong>{{ "{:.1f}%".format(summary.not_selected_demo_rate * 100) }}</strong></div>
</section>

<section class="card dashboard-alerts-card">
  <h2>Executive Alerts</h2>
  <div class="dashboard-alerts-grid">
    {% for alert in executive_alerts %}
    <article class="dashboard-alert dashboard-alert-{{ alert.tone }}">
      <div class="dashboard-alert-title">{{ alert.title }}</div>
      <p>{{ alert.detail }}</p>
      <a class="button-link subtle" href="{{ alert.href }}">{{ alert.action }}</a>
    </article>
    {% endfor %}
  </div>
</section>

<div class="grid grid-2 dashboard-visual-grid">
  <section class="card">
    <h2>Spend By Category</h2>
    <div class="dashboard-chart-block" data-dashboard-donut data-source-id="dashboard-by-category-json" data-value-field="total_spend" data-label-field="category" data-prefix="$" data-empty-text="No category spend data"></div>
    <script id="dashboard-by-category-json" type="application/json">{{ by_category | tojson }}</script>
    <div class="dashboard-chart-legend">
      {% for row in by_category %}
      <div class="dashboard-chart-legend-row">
        <span class="dashboard-chart-legend-label">{{ row.category or 'Unknown' }}</span>
        <span class="dashboard-chart-legend-value">${{ "{:,.0f}".format(row.total_spend or 0) }}</span>
      </div>
      {% else %}
      <p class="muted">No data</p>
      {% endfor %}
    </div>
  </section>

  <section class="card">
    <h2>Monthly Spend Trend</h2>
    <div class="dashboard-chart-block" data-dashboard-line data-source-id="dashboard-trend-json" data-value-field="total_spend" data-label-field="month" data-prefix="$" data-empty-text="No spend trend data"></div>
    <script id="dashboard-trend-json" type="application/json">{{ trend | tojson }}</script>
    <div class="dashboard-chart-legend dashboard-chart-legend-compact">
      {% for row in trend %}
      <div class="dashboard-chart-legend-row">
        <span class="dashboard-chart-legend-label">{{ row.month }}</span>
        <span class="dashboard-chart-legend-value">${{ "{:,.0f}".format(row.total_spend or 0) }}</span>
      </div>
      {% else %}
      <p class="muted">No data</p>
      {% endfor %}
    </div>
  </section>
</div>

<div class="grid grid-2 dashboard-visual-grid">
  <section class="card">
    <h2>Renewal Focus ({{ horizon_days }} days)</h2>
    <div class="dashboard-renewal-snapshot">
      <div class="metric metric-mini"><span>Next 30 Days</span><strong>{{ renewals_30_count }}</strong></div>
      <div class="metric metric-mini"><span>Next 60 Days</span><strong>{{ renewals_60_count }}</strong></div>
      <div class="metric metric-mini"><span>30-Day Value</span><strong>${{ "{:,.0f}".format(renewals_30_value) }}</strong></div>
    </div>
    {% if renewals %}
    <div class="dashboard-renewal-preview">
      <h3>Upcoming In Focus</h3>
      <ul>
        {% for row in renewals[:3] %}
        <li>
          <a href="/contracts?tab=expiring&q={{ row.contract_id }}">{{ row.vendor_name or row.vendor_id or 'Unknown vendor' }}</a>
          <span class="muted"> - {{ row.renewal_date }}{% if row.days_to_renewal is not none %} ({{ row.days_to_renewal|int }} days){% endif %}</span>
        </li>
        {% endfor %}
      </ul>
      <a class="button-link subtle" href="/contracts?tab=expiring">View all renewals</a>
    </div>
    {% else %}
    <p class="muted">No renewals in the selected horizon.</p>
    {% endif %}
  </section>

  <section class="card">
    <h2>Risk Distribution</h2>
    <div class="dashboard-chart-block" data-dashboard-donut data-source-id="dashboard-risk-json" data-value-field="vendor_count" data-label-field="risk_tier" data-empty-text="No risk distribution data"></div>
    <script id="dashboard-risk-json" type="application/json">{{ risk_dist | tojson }}</script>
    <div class="dashboard-chart-legend">
      {% for row in risk_dist %}
      {% set count = row.vendor_count or 0 %}
      {% set width_pct = (count / risk_total * 100) if risk_total > 0 else 0 %}
      <div class="dashboard-chart-legend-row">
        <span class="dashboard-chart-legend-label">{{ row.risk_tier or 'unknown' }}</span>
        <span class="dashboard-chart-legend-value">{{ count }}{% if risk_total > 0 %} ({{ "{:.0f}".format(width_pct) }}%){% endif %}</span>
      </div>
      {% else %}
      <p class="muted">No data</p>
      {% endfor %}
    </div>
  </section>
</div>

<div class="grid grid-2">
  <section class="card">
    <h2>Top Vendors By Spend</h2>
    <table>
      <thead><tr><th>Vendor</th><th>Risk</th><th>Total Spend</th></tr></thead>
      <tbody>
      {% for row in top_vendors %}
      {% set risk_key = (row.risk_tier or 'unknown')|lower %}
      <tr>
        <td>{{ row.vendor_name }}</td>
        <td><span class="risk-pill risk-pill-{{ risk_key }}">{{ row.risk_tier or 'unknown' }}</span></td>
        <td>${{ "{:,.0f}".format(row.total_spend) }}</td>
      </tr>
      {% else %}
      <tr><td colspan="3">No data</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>

  <section class="card">
    <h2>Detailed Data</h2>
    <p class="muted">Detailed renewal, demo, and cancellation outputs are available in Reports when needed.</p>
    <a class="button-link subtle" href="/reports">Open Reports</a>
  </section>
</div>
{% endblock %}

