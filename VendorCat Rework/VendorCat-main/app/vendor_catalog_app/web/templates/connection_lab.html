<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vendor Catalog Connection Lab</title>
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <link rel="stylesheet" href="/static/css/app.css">
</head>
<body>
  <main class="container">
    <section class="card section-divider">
      <h1>Connection Lab</h1>
      <p>Use this page to test temporary Databricks connection values without redeploying the app.</p>
      <p><strong>Current return path:</strong> <code>{{ return_to }}</code></p>

      {% if flashes %}
        {% for flash in flashes %}
        <div class="flash {{ flash.level }}">{{ flash.message }}</div>
        {% endfor %}
      {% endif %}

      {% if not authorized %}
      <section class="card section-divider">
        <h2>Unlock</h2>
        <p>Enter the connection lab secret token to continue.</p>
        <form method="post" action="/connection-lab/authorize" class="inline-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="next" value="/connection-lab?next={{ return_to|urlencode }}">
          <input type="password" name="connection_lab_token" placeholder="Secret token" required autocomplete="current-password">
          <button type="submit">Unlock</button>
        </form>
      </section>
      {% else %}
      <section class="card section-divider">
        <h2>Temporary Override</h2>
        {% if active_override_preview %}
        <p><strong>Active session override:</strong></p>
        <ul>
          {% if active_override_preview.databricks_server_hostname %}
          <li><code>host={{ active_override_preview.databricks_server_hostname }}</code></li>
          {% endif %}
          {% if active_override_preview.databricks_http_path %}
          <li><code>http_path={{ active_override_preview.databricks_http_path }}</code></li>
          {% endif %}
          {% if active_override_preview.auth_mode %}
          <li><code>auth_mode={{ active_override_preview.auth_mode }}</code></li>
          {% endif %}
        </ul>
        {% else %}
        <p>No temporary override is active.</p>
        {% endif %}

        <form method="post" action="/connection-lab/probe" class="grid grid-2" style="margin-top: 12px;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="next" value="{{ return_to }}">
          <label>Server Hostname
            <input type="text" name="databricks_server_hostname" value="{{ form_state.databricks_server_hostname }}" placeholder="dbc-xxxx.cloud.databricks.com">
          </label>
          <label>HTTP Path
            <input type="text" name="databricks_http_path" value="{{ form_state.databricks_http_path }}" placeholder="/sql/1.0/warehouses/<id>">
          </label>
          <label>Warehouse ID (optional)
            <input type="text" name="databricks_warehouse_id" value="{{ form_state.databricks_warehouse_id }}" placeholder="955428814f623a0e">
          </label>
          <label>Auth Mode
            <select name="auth_mode">
              <option value="inherit" {% if form_state.auth_mode == 'inherit' %}selected{% endif %}>Inherit Runtime Auth</option>
              <option value="pat" {% if form_state.auth_mode == 'pat' %}selected{% endif %}>PAT Token</option>
              <option value="oauth_client" {% if form_state.auth_mode == 'oauth_client' %}selected{% endif %}>Client Credentials</option>
            </select>
          </label>
          <label>PAT Token
            <input type="password" name="databricks_token" value="" placeholder="dapi..." autocomplete="off">
          </label>
          <label>Client ID
            <input type="text" name="databricks_client_id" value="" placeholder="00000000-0000-0000-0000-000000000000">
          </label>
          <label>Client Secret
            <input type="password" name="databricks_client_secret" value="" placeholder="Client secret" autocomplete="off">
          </label>
          <div class="inline-form" style="gap:8px; align-items:end;">
            <button type="submit">Probe Connection</button>
            <button type="submit" formaction="/connection-lab/apply">Apply For This Session</button>
          </div>
        </form>

        <form method="post" action="/connection-lab/clear" class="inline-form" style="margin-top:8px;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="next" value="{{ return_to }}">
          <button type="submit" class="subtle">Clear Session Override</button>
        </form>
      </section>
      {% endif %}

      {% if probe_payload %}
      <section class="card section-divider">
        <h2>Probe Result</h2>
        <p><strong>Status:</strong> {{ "PASS" if probe_payload.ok else "FAIL" }}</p>
        <p><strong>Mode:</strong> {{ probe_payload.mode }}</p>
        <p><strong>Schema:</strong> {{ probe_payload.schema }}</p>
        {% if probe_payload.connection_lab and probe_payload.connection_lab.override_preview %}
        <p><strong>Probe override:</strong> {{ probe_payload.connection_lab.override_preview }}</p>
        {% endif %}
        {% if probe_payload.recommendations %}
        <h3>Recommendations</h3>
        <ul>
          {% for line in probe_payload.recommendations %}
          <li>{{ line }}</li>
          {% endfor %}
        </ul>
        {% endif %}
      </section>
      {% endif %}

      <div class="button-group">
        <a class="button-link" href="{{ return_to }}">Back</a>
        <a class="button-link subtle" href="/bootstrap-diagnostics">Open Bootstrap Diagnostics</a>
      </div>
    </section>
  </main>
</body>
</html>
