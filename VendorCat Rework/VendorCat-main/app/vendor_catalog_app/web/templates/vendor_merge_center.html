{% extends "base.html" %}

{% block head %}
  <link rel="stylesheet" href="/static/css/imports_wizard.css?v={{ static_asset_version }}">
{% endblock %}

{% block content %}
{% set has_preview = merge_preview|default({}) %}
{% set conflict_count = (merge_preview.conflicts|length) if merge_preview else 0 %}
{% set offering_collision_count = (merge_preview.offering_collisions|length) if merge_preview else 0 %}

<div class="section-header merge-guided-header">
  <div>
    <h1>Vendor Merge Center</h1>
    <p>Guided merge workflow: candidate check, conflict decisions, and final confirmation.</p>
  </div>
  <div class="button-group">
    <button type="button" class="button-link subtle" data-replay-tour>Replay Tour</button>
    <a class="button-link subtle" href="/vendors">Back To Vendor 360</a>
  </div>
</div>

<section
  class="card section-divider merge-guided-shell"
  data-merge-guided
  data-guided-enabled="{{ 'true' if merge_center_guided_ux_v2_enabled else 'false' }}"
  data-show-tour="{{ 'true' if show_guided_tour else 'false' }}"
  data-step-state="{{ guided_step_state }}"
  data-tour-dismiss-url="/vendors/merge-center/tour/dismiss"
>
  <header class="guided-stepper merge-stepper">
    <ol class="guided-step-list">
      <li><button type="button" class="guided-step-btn {% if guided_step_state == 'candidate_check' %}is-active{% endif %}" data-merge-step="candidate">A. Candidate Check</button></li>
      <li><button type="button" class="guided-step-btn {% if guided_step_state == 'conflict_decisions' %}is-active{% endif %}" data-merge-step="conflicts">B. Conflict Decisions</button></li>
      <li><button type="button" class="guided-step-btn {% if guided_step_state == 'final_confirmation' %}is-active{% endif %}" data-merge-step="confirm">C. Final Merge Confirmation</button></li>
    </ol>
  </header>

  <section class="guided-tour-demo-board" data-tour-demo-board hidden aria-live="polite">
    <article class="guided-tour-demo-card" data-tour-example="merge_candidates" hidden>
      <h3>Walkthrough Example: Candidate Check</h3>
      <p class="muted">Select survivor and source vendors using typeahead search.</p>
      <div class="guided-tour-demo-grid">
        <div class="guided-meta-item">
          <div class="muted">Survivor Vendor</div>
          <div><strong>vnd-0108 | Apex Cloud Services</strong></div>
        </div>
        <div class="guided-meta-item">
          <div class="muted">Source Vendor</div>
          <div><strong>vnd-0544 | Apex Cloud Services LLC</strong></div>
        </div>
        <div class="guided-meta-item">
          <div class="muted">Candidate Match Score</div>
          <div><strong>96%</strong></div>
        </div>
        <div class="guided-meta-item">
          <div class="muted">Linked Rows Found</div>
          <div><strong>237</strong></div>
        </div>
      </div>
    </article>

    <article class="guided-tour-demo-card" data-tour-example="merge_conflicts" hidden>
      <h3>Walkthrough Example: Field Conflict Decisions</h3>
      <p class="muted">Pick how each conflicting value should be preserved.</p>
      <div class="table-wrap">
        <table class="guided-tour-demo-table">
          <thead>
            <tr>
              <th>Field</th>
              <th>Survivor</th>
              <th>Source</th>
              <th>Decision</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>support_email</td>
              <td>support@apexcloud.com</td>
              <td>ops@apexcloud.com</td>
              <td>Use source</td>
            </tr>
            <tr>
              <td>risk_tier</td>
              <td>medium</td>
              <td>high</td>
              <td>Keep survivor</td>
            </tr>
          </tbody>
        </table>
      </div>
    </article>

    <article class="guided-tour-demo-card" data-tour-example="merge_offering_collisions" hidden>
      <h3>Walkthrough Example: Offering Collisions</h3>
      <p class="muted">Resolve offering overlaps before final execute.</p>
      <div class="table-wrap">
        <table class="guided-tour-demo-table">
          <thead>
            <tr>
              <th>Source Offering</th>
              <th>Collision Targets</th>
              <th>Decision</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Managed SOC</td>
              <td>SOC Managed Detection, 24x7 SOC</td>
              <td>Merge into SOC Managed Detection</td>
            </tr>
            <tr>
              <td>Cloud DR</td>
              <td>Cloud DR Essentials</td>
              <td>Keep both (rename to Cloud DR Legacy)</td>
            </tr>
          </tbody>
        </table>
      </div>
    </article>

    <article class="guided-tour-demo-card" data-tour-example="merge_final_ack" hidden>
      <h3>Walkthrough Example: Final Merge Confirmation</h3>
      <p class="muted">Acknowledge irreversible merge behavior before execute.</p>
      <div class="guided-metrics">
        <span class="status-badge status-review">Field conflicts: 2</span>
        <span class="status-badge status-blocked">Offering collisions: 2</span>
        <span class="status-badge status-ready">Rows reassigned: 237</span>
      </div>
      <label class="guided-confirm-checkbox">
        <input type="checkbox" checked disabled>
        I understand this merge archives the source vendor and cannot be undone from this screen.
      </label>
    </article>
  </section>

  <section class="merge-panel" data-merge-panel="candidate" data-tour-anchor="merge-candidate-panel">
    <div class="section-header compact">
      <div>
        <h2>Step A: Candidate Check</h2>
        <p>Select survivor and source vendors using plain-language search. IDs are captured automatically.</p>
      </div>
    </div>

    <form method="post" action="/vendors/merge-center/preview" id="merge-candidate-form" class="guided-primary-grid">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <input type="hidden" name="survivor_vendor_id" id="survivor-vendor-id" value="{{ survivor_vendor_id }}">
      <input type="hidden" name="source_vendor_id" id="source-vendor-id" value="{{ source_vendor_id }}">

      <label data-vendor-typeahead data-target-input="#survivor-vendor-id">
        Survivor Vendor (kept as canonical)
        <input
          type="text"
          id="survivor-vendor-label"
          value="{{ survivor_vendor_id }}"
          autocomplete="off"
          placeholder="Search vendor by name or ID"
          data-typeahead-input
        >
        <div class="typeahead-results" data-typeahead-results hidden></div>
      </label>

      <label data-vendor-typeahead data-target-input="#source-vendor-id">
        Source Vendor (archived after merge)
        <input
          type="text"
          id="source-vendor-label"
          value="{{ source_vendor_id }}"
          autocomplete="off"
          placeholder="Search vendor by name or ID"
          data-typeahead-input
        >
        <div class="typeahead-results" data-typeahead-results hidden></div>
      </label>

      <label>
        Expert Input (Optional IDs)
        <input type="text" id="merge-id-manual" placeholder="survivor=vnd-xxx, source=vnd-yyy">
      </label>

      <div class="guided-primary-actions">
        <button type="submit">Preview Merge</button>
        <a class="button-link subtle" href="/vendors/merge-center">Reset</a>
      </div>
    </form>
  </section>

  {% if merge_preview %}
  <section class="merge-panel" data-merge-panel="conflicts">
    <div class="section-header compact">
      <div>
        <h2>Step B: Conflict Decisions</h2>
        <p>Merge Preview: survivor={{ merge_preview.survivor_vendor_id }} | source={{ merge_preview.source_vendor_id }} | source-linked-rows={{ merge_preview.total_source_linked_rows }}</p>
      </div>
    </div>

    <form method="post" action="/vendors/merge-center/execute" id="merge-execute-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <input type="hidden" name="survivor_vendor_id" value="{{ merge_preview.survivor_vendor_id }}">
      <input type="hidden" name="source_vendor_id" value="{{ merge_preview.source_vendor_id }}">

      <section class="guided-sub-card merge-conflict-card" data-tour-anchor="merge-conflicts">
        <h3>Field Conflicts</h3>
        <p class="muted">{{ conflict_count }} scalar conflict(s) detected.</p>
        <table>
          <thead>
            <tr>
              <th>Field</th>
              <th>Current Survivor Value</th>
              <th>Source Value</th>
              <th>Decision</th>
            </tr>
          </thead>
          <tbody>
            {% for row in merge_preview.conflicts %}
            <tr>
              <td>{{ row.field_name }}</td>
              <td>{{ row.survivor_value or "-" }}</td>
              <td>{{ row.source_value or "-" }}</td>
              <td>
                <select name="conflict_decision_{{ row.field_name }}">
                  <option value="survivor">Use survivor value (recommended)</option>
                  <option value="source">Use source value</option>
                  <option value="keep_both">Keep both values where possible</option>
                </select>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="4">No scalar conflicts detected.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </section>

      <section class="guided-sub-card merge-conflict-card" data-tour-anchor="merge-offerings">
        <h3>Offering Collisions</h3>
        <p class="muted">{{ offering_collision_count }} offering collision(s) require decisions.</p>
        <table>
          <thead>
            <tr>
              <th>Source Offering</th>
              <th>Collision Targets</th>
              <th>Decision</th>
              <th>Merge Target</th>
              <th>Rename When Keeping Both</th>
            </tr>
          </thead>
          <tbody>
            {% for row in merge_preview.offering_collisions %}
            <tr class="merge-offering-row" data-source-offering-id="{{ row.source_offering_id }}">
              <td>{{ row.source_offering_name }} ({{ row.source_offering_id }})</td>
              <td>
                {% for target in row.target_options %}
                <div>{{ target.offering_name }} ({{ target.offering_id }})</div>
                {% endfor %}
              </td>
              <td>
                <select name="offering_decision_{{ row.source_offering_id }}" data-offering-decision>
                  <option value="keep_both">Keep both offerings</option>
                  <option value="merge">Merge source into selected target</option>
                </select>
              </td>
              <td>
                <select name="offering_target_{{ row.source_offering_id }}" data-offering-target>
                  <option value="">(auto-first target)</option>
                  {% for target in row.target_options %}
                  <option value="{{ target.offering_id }}">{{ target.offering_name }} ({{ target.offering_id }})</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <input type="text" name="offering_rename_{{ row.source_offering_id }}" data-offering-rename placeholder="optional keep-both name">
              </td>
            </tr>
            {% else %}
            <tr><td colspan="5">No offering collisions detected.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </section>

      <section class="merge-panel" data-merge-panel="confirm">
        <div class="section-header compact">
          <div>
            <h2>Step C: Final Merge Confirmation</h2>
            <p>This action is irreversible in normal operations. Review summary and confirm before execute.</p>
          </div>
        </div>

        <section class="guided-safety-card">
          <h3>Merge Impact Summary</h3>
          <div class="guided-metrics">
            <span class="status-badge status-review">Field conflicts: {{ conflict_count }}</span>
            <span class="status-badge status-blocked">Offering collisions: {{ offering_collision_count }}</span>
            <span class="status-badge status-ready">Linked rows reassigned: {{ merge_preview.total_source_linked_rows }}</span>
          </div>
          <label>
            Merge Reason
            <input type="text" name="merge_reason" value="vendor_merge_center" required>
          </label>
          <label class="guided-confirm-checkbox" data-tour-anchor="merge-final-ack">
            <input type="checkbox" name="guided_merge_acknowledge" value="1" id="merge-final-ack">
            I understand this merge archives the source vendor and cannot be undone from this screen.
          </label>
        </section>

        <div class="guided-primary-actions">
          <button type="submit">Execute Merge</button>
          <a class="button-link subtle" href="/vendors/merge-center">Cancel</a>
        </div>
      </section>
    </form>
  </section>
  {% else %}
  <section class="merge-panel" data-merge-panel="conflicts">
    <div class="flash info">Run Candidate Check to generate a merge preview.</div>
  </section>
  {% endif %}

  {% if merge_execute_result %}
  <section class="guided-sub-card">
    <h3>Merge Result</h3>
    <p class="muted">Canonical redirect has been applied to the survivor profile.</p>
    <pre>{{ merge_execute_result | tojson(indent=2) }}</pre>
  </section>
  {% endif %}

  <div class="guided-tour-overlay is-spotlight" data-tour-overlay data-tour-surface="merge-center" hidden></div>
</section>
{% endblock %}

{% block scripts %}
  <script src="/static/js/guided_tour_engine.js?v={{ static_asset_version }}"></script>
  <script src="/static/js/vendor_merge_center_guided.js?v={{ static_asset_version }}"></script>
{% endblock %}
