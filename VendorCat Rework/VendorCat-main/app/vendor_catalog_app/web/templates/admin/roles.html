{% extends "base.html" %}

{% block head %}
  <link rel="stylesheet" href="/static/css/admin_portal.css">
{% endblock %}

{% block content %}
<div class="section-header">
  <div>
    <h1>Role Catalog</h1>
    <p>Browse and edit role definitions. Open a role to review user and group grants.</p>
  </div>
</div>

{% include "admin/_nav.html" %}

<section class="card admin-filter-card">
  <form method="get" action="/admin/roles" class="inline-form">
    <label>Search Roles
      <input type="search" name="q" value="{{ roles_query }}" placeholder="role code, name, description">
    </label>
    <label>Page Size
      <select name="page_size">
        {% for size in [10, 25, 50, 100] %}
        <option value="{{ size }}" {% if roles_pager.page_size == size %}selected{% endif %}>{{ size }}</option>
        {% endfor %}
      </select>
    </label>
    <button type="submit">Apply</button>
    <a class="button-link subtle" href="/admin/roles">Reset</a>
  </form>
</section>

<section class="card">
  {% set pager = roles_pager %}
  {% include "admin/_pagination.html" %}
  <table>
    <thead>
      <tr>
        <th>Role Code</th>
        <th>Name</th>
        <th>Approval</th>
        <th>Edit</th>
        <th>Report</th>
        <th>Direct Apply</th>
        <th>Change Permissions</th>
      </tr>
    </thead>
    <tbody>
      {% for row in role_definitions %}
      <tr>
        <td><a href="/admin/roles/{{ row.role_code }}">{{ row.role_code }}</a></td>
        <td>{{ row.role_name }}</td>
        <td>{{ row.approval_level }}</td>
        <td>{{ row.can_edit }}</td>
        <td>{{ row.can_report }}</td>
        <td>{{ row.can_direct_apply }}</td>
        <td>{{ row.actions_summary }}</td>
      </tr>
      {% else %}
      <tr><td colspan="7">No roles configured.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="card" style="margin-top:12px;">
  <h2>Create or Update Role</h2>
  <form method="post" action="/admin/roles/save" class="grid grid-2" style="margin-top:10px;">
    <label>Role Code
      <input list="role-code-options" type="text" name="role_code" placeholder="vendor_editor" required>
      <datalist id="role-code-options">
        {% for role_code in role_code_options %}
        <option value="{{ role_code }}"></option>
        {% endfor %}
      </datalist>
    </label>
    <label>Role Name
      <input type="text" name="role_name" placeholder="Vendor Editor" required>
    </label>
    <label class="full">Description
      <input type="text" name="description" placeholder="Describe what this role can do.">
    </label>
    <label>Approval Level
      <select name="approval_level">
        {% for level in role_approval_level_options %}
        <option value="{{ level }}">{{ level }}</option>
        {% endfor %}
      </select>
    </label>
    <div class="full inline-form">
      <label><input type="checkbox" name="can_edit"> Can Edit</label>
      <label><input type="checkbox" name="can_report"> Can Report</label>
      <label><input type="checkbox" name="can_direct_apply"> Can Direct Apply</label>
    </div>
    <div class="full">
      <h3>Per-Action Change Permissions</h3>
      <div class="role-permission-grid">
        {% for action in change_actions %}
        <label class="role-permission-option">
          <input type="checkbox" name="perm_{{ action }}">
          <span>{{ action }}</span>
        </label>
        {% endfor %}
      </div>
    </div>
    <div><button type="submit">Save Role</button></div>
  </form>
</section>
{% endblock %}
