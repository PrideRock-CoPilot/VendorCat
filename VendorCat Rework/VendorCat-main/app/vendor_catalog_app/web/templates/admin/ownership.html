{% extends "base.html" %}

{% block head %}
  <link rel="stylesheet" href="/static/css/admin_portal.css">
{% endblock %}

{% block content %}
<div class="section-header">
  <div>
    <h1>Ownership Reassignment</h1>
    <p>Search an owner, review assignments, and reassign safely with previewed scope.</p>
  </div>
</div>

{% include "admin/_nav.html" %}

<section class="card">
  <h2>Load Assignments</h2>
  <form method="get" action="/admin/ownership" class="inline-form" style="margin-top:8px;">
    <label>Source Owner
      <div class="typeahead-block">
        <input type="text" name="source_owner" value="{{ selected_owner_source }}" placeholder="user@company.com" required data-admin-user-search>
        <div class="typeahead-results hidden"></div>
      </div>
    </label>
    <label>Page Size
      <select name="page_size">
        {% for size in [10, 25, 50, 100] %}
        <option value="{{ size }}" {% if ownership_pager.page_size == size %}selected{% endif %}>{{ size }}</option>
        {% endfor %}
      </select>
    </label>
    <button type="submit">Load Ownerships</button>
  </form>
</section>

{% if selected_owner_source %}
<section class="card">
  <h2>Assignments for {{ selected_owner_source }}</h2>
  {% set pager = ownership_pager %}
  {% include "admin/_pagination.html" %}
  <form method="post" action="/admin/ownership/reassign" style="margin-top:8px;">
    <input type="hidden" name="source_owner" value="{{ selected_owner_source }}">
    <div class="grid grid-2" style="margin-bottom:10px;">
      <label>Default Replacement Owner
        <div class="typeahead-block">
          <input type="text" name="default_target_owner" placeholder="user@company.com" data-admin-user-search>
          <div class="typeahead-results hidden"></div>
        </div>
      </label>
      <label>Action Mode
        <select name="action_mode">
          <option value="all_default">Reassign all rows to default owner</option>
          <option value="selected_default">Reassign selected rows to default owner</option>
          <option value="selected_per_row">Reassign selected rows using per-row owner (fallback to default)</option>
        </select>
      </label>
    </div>
    <table>
      <thead>
        <tr>
          <th>Select</th>
          <th>Type</th>
          <th>Vendor</th>
          <th>Entity</th>
          <th>Role</th>
          <th>Current Owner</th>
          <th>Per-Row Replacement</th>
        </tr>
      </thead>
      <tbody>
        {% for row in ownership_rows %}
        <tr>
          <td><input type="checkbox" name="selected_assignment_key" value="{{ row.assignment_key }}"></td>
          <td>{{ row.entity_type }}</td>
          <td>{{ row.vendor_display_name or row.vendor_id or '-' }}</td>
          <td>
            <div>{{ row.entity_name or row.entity_id }}</div>
            <div class="muted">{{ row.entity_id }}</div>
          </td>
          <td>{{ row.owner_role }}</td>
          <td>{{ row.owner_principal }}</td>
          <td>
            <div class="typeahead-block">
              <input
                type="text"
                name="target_for__{{ row.assignment_key }}"
                placeholder="Optional per-row owner"
                data-admin-user-search
              >
              <div class="typeahead-results hidden"></div>
            </div>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="7">No active ownership assignments found for this owner.</td></tr>
        {% endfor %}
      </tbody>
    </table>
    <div style="margin-top:10px;"><button type="submit">Apply Reassignment</button></div>
  </form>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="/static/js/admin_portal.js"></script>
{% endblock %}
