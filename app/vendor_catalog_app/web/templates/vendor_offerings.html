{% extends "base.html" %}
{% from "doc_link_form.html" import render_doc_link_form with context %}
{% block content %}
<div class="section-header">
  <div>
    <h1>{{ vendor_display_name }} Offerings</h1>
    <p>Offering-level details, mappings, and editable controls.</p>
  </div>
  <div class="button-group">
    {% if can_edit and not locked_mode %}
    <a class="button-link" href="/vendors/{{ vendor_id }}/offerings/new?return_to={{ return_to|urlencode }}">+ New Offering</a>
    {% endif %}
    <a class="button-link subtle" href="/vendors/{{ vendor_id }}/summary?return_to={{ return_to|urlencode }}">Vendor Summary</a>
    <a class="button-link" href="{{ return_to }}">Back To List</a>
  </div>
</div>

<section class="metrics">
  <div class="metric"><span>Lifecycle</span><strong>{{ summary.lifecycle_state }}</strong></div>
  <div class="metric"><span>Risk Tier</span><strong>{{ summary.risk_tier }}</strong></div>
  <div class="metric"><span>Offerings</span><strong>{{ summary.offering_count|int }}</strong></div>
  <div class="metric"><span>Active Contracts</span><strong>{{ summary.active_contract_count|int }}</strong></div>
  <div class="metric"><span>Demos Selected</span><strong>{{ summary.demos_selected|int }}</strong></div>
  <div class="metric"><span>Demos Not Selected</span><strong>{{ summary.demos_not_selected|int }}</strong></div>
</section>

<section class="card section-nav-card">
  <div class="section-nav-links">
    {% for item in vendor_nav %}
    <a class="{% if item.active %}active{% endif %}" href="{{ item.url }}">{{ item.label }}</a>
    {% endfor %}
  </div>
</section>

{% if not offerings %}
<section class="card empty-state-card section-divider">
  <h2>No Offerings Found</h2>
  <p>Create your first offering, then map contracts, demos, and documents.</p>
  <div class="empty-state-actions">
    {% if can_edit and not locked_mode %}
    <a class="button-link" href="/vendors/{{ vendor_id }}/offerings/new?return_to={{ return_to|urlencode }}">Create Offering</a>
    {% endif %}
    <a class="button-link subtle" href="/vendors/{{ vendor_id }}/summary?return_to={{ return_to|urlencode }}">Open Vendor Summary</a>
  </div>
</section>
{% endif %}

<section class="card section-divider">
  <h2>Offerings</h2>
  <table>
    <thead>
      <tr>
        <th>Offering</th>
        <th>Type</th>
        <th>LOB</th>
        <th>Service Type</th>
        <th>Lifecycle</th>
        <th>Criticality</th>
        <th>Owners</th>
        <th>Contacts</th>
        <th>Contracts</th>
        <th>Demos</th>
        <th>Docs</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for row in offerings %}
    <tr>
      <td>{{ row.offering_name }}</td>
      <td>{{ row.offering_type }}</td>
      <td>{{ row.lob or "-" }}</td>
      <td>{{ row.service_type or "-" }}</td>
      <td>{{ row.lifecycle_state }}</td>
      <td>{{ row.criticality_tier }}</td>
      <td>{{ row.owner_count }}</td>
      <td>{{ row.contact_count }}</td>
      <td>{{ row.contract_count }}</td>
      <td>{{ row.demo_count }}</td>
      <td>{{ row.doc_count }}</td>
      <td class="button-group">
        <a class="button-link subtle" href="{{ row._open_link }}">Open</a>
        {% if can_edit and not locked_mode %}
        <a class="button-link subtle" href="{{ row._edit_link }}">Edit</a>
        {% endif %}
      </td>
    </tr>
    {% else %}
    <tr><td colspan="12">No offerings found.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>

<section class="card section-divider">
  <h2>Unassigned Records</h2>
  <p>Map unassigned records to an offering.</p>
</section>

<div class="grid grid-2">
  <section class="card">
    <h3>Unassigned Contracts</h3>
    {% if can_edit and not locked_mode %}
    <form id="bulk-map-contracts-form" method="post" action="/vendors/{{ vendor_id }}/map-contracts/bulk" class="bulk-map-toolbar">
      <input type="hidden" name="return_to" value="{{ offerings_return_to }}">
      <label>Map Selected To
        <select name="offering_id" required>
          <option value="">Select offering</option>
          {% for option in bulk_offering_options %}
          <option value="{{ option.offering_id }}">{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label>Reason
        <input type="text" name="reason" placeholder="Reason" required>
      </label>
      <div class="button-group">
        <button type="button" data-bulk-select-all="contract">Select All</button>
        <button type="button" data-bulk-clear-all="contract">Clear</button>
        <button type="submit">Map Selected</button>
      </div>
      <span class="muted" data-bulk-selected-count="contract">0 selected</span>
    </form>
    {% endif %}
    <table>
      <thead><tr><th>Select</th><th>Contract</th><th>Status</th><th>Start</th><th>End</th><th>Map</th></tr></thead>
      <tbody>
      {% for row in unassigned_contracts %}
      <tr>
        <td>
          {% if can_edit and not locked_mode %}
          <input
            type="checkbox"
            name="contract_ids"
            value="{{ row.contract_id }}"
            form="bulk-map-contracts-form"
            data-bulk-item="contract"
            aria-label="Select contract {{ row.contract_number or row.contract_id }}"
          >
          {% else %}
          -
          {% endif %}
        </td>
        <td>{{ row.contract_number or row.contract_id }}</td>
        <td>{{ row.contract_status }}</td>
        <td>{{ row.start_date }}</td>
        <td>{{ row.end_date }}</td>
        <td>
          {% if can_edit and not locked_mode %}
          <form method="post" action="/vendors/{{ vendor_id }}/map-contract" class="inline-form">
            <input type="hidden" name="return_to" value="{{ offerings_return_to }}">
            <input type="hidden" name="contract_id" value="{{ row.contract_id }}">
            <select name="offering_id">
              {% for option in offering_options %}
              <option value="{{ option.offering_id }}">{{ option.label }}</option>
              {% endfor %}
            </select>
            <input type="text" name="reason" placeholder="Reason" required>
            <button type="submit">Map</button>
          </form>
          {% else %}
          <span class="muted">view-only</span>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6">No unassigned contracts.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>

  <section class="card">
    <h3>Unassigned Demos</h3>
    {% if can_edit and not locked_mode %}
    <form id="bulk-map-demos-form" method="post" action="/vendors/{{ vendor_id }}/map-demos/bulk" class="bulk-map-toolbar">
      <input type="hidden" name="return_to" value="{{ offerings_return_to }}">
      <label>Map Selected To
        <select name="offering_id" required>
          <option value="">Select offering</option>
          {% for option in bulk_offering_options %}
          <option value="{{ option.offering_id }}">{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label>Reason
        <input type="text" name="reason" placeholder="Reason" required>
      </label>
      <div class="button-group">
        <button type="button" data-bulk-select-all="demo">Select All</button>
        <button type="button" data-bulk-clear-all="demo">Clear</button>
        <button type="submit">Map Selected</button>
      </div>
      <span class="muted" data-bulk-selected-count="demo">0 selected</span>
    </form>
    {% endif %}
    <table>
      <thead><tr><th>Select</th><th>Demo</th><th>Date</th><th>Outcome</th><th>Score</th><th>Map</th></tr></thead>
      <tbody>
      {% for row in unassigned_demos %}
      <tr>
        <td>
          {% if can_edit and not locked_mode %}
          <input
            type="checkbox"
            name="demo_ids"
            value="{{ row.demo_id }}"
            form="bulk-map-demos-form"
            data-bulk-item="demo"
            aria-label="Select demo {{ row.demo_id }}"
          >
          {% else %}
          -
          {% endif %}
        </td>
        <td>{{ row.demo_id }}</td>
        <td>{{ row.demo_date }}</td>
        <td>{{ row.selection_outcome }}</td>
        <td>{{ row.overall_score }}</td>
        <td>
          {% if can_edit and not locked_mode %}
          <form method="post" action="/vendors/{{ vendor_id }}/map-demo" class="inline-form">
            <input type="hidden" name="return_to" value="{{ offerings_return_to }}">
            <input type="hidden" name="demo_id" value="{{ row.demo_id }}">
            <select name="offering_id">
              {% for option in offering_options %}
              <option value="{{ option.offering_id }}">{{ option.label }}</option>
              {% endfor %}
            </select>
            <input type="text" name="reason" placeholder="Reason" required>
            <button type="submit">Map</button>
          </form>
          {% else %}
          <span class="muted">view-only</span>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6">No unassigned demos.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<section class="card section-divider">
  <h2>Offering Documents</h2>
  <p>Links only. We auto-detect document type from URL.</p>
  <table>
    <thead><tr><th>Offering</th><th>Recent Links</th><th>Add Link</th></tr></thead>
    <tbody>
    {% for row in offerings %}
    <tr>
      <td>{{ row.offering_name }}</td>
      <td><a class="button-link subtle" href="{{ row._open_link }}#offering-docs">View Docs</a></td>
      <td>
        {% if can_edit and not locked_mode %}
        {{ render_doc_link_form(
             post_url="/vendors/" ~ vendor_id ~ "/offerings/" ~ row.offering_id ~ "/docs/link",
             return_to=offerings_return_to,
             submit_label="Add Link"
           ) }}
        {% else %}
        <span class="muted">view-only</span>
        {% endif %}
      </td>
    </tr>
    {% else %}
    <tr><td colspan="3">No offerings.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const setupBulkSelection = (kind) => {
    const items = Array.from(document.querySelectorAll(`[data-bulk-item="${kind}"]`));
    if (!items.length) {
      return;
    }
    const countNode = document.querySelector(`[data-bulk-selected-count="${kind}"]`);
    const selectAllButton = document.querySelector(`[data-bulk-select-all="${kind}"]`);
    const clearButton = document.querySelector(`[data-bulk-clear-all="${kind}"]`);

    const updateCount = () => {
      if (!countNode) {
        return;
      }
      const selectedCount = items.filter((item) => item.checked).length;
      countNode.textContent = `${selectedCount} selected`;
    };

    if (selectAllButton) {
      selectAllButton.addEventListener("click", () => {
        items.forEach((item) => {
          item.checked = true;
        });
        updateCount();
      });
    }
    if (clearButton) {
      clearButton.addEventListener("click", () => {
        items.forEach((item) => {
          item.checked = false;
        });
        updateCount();
      });
    }
    items.forEach((item) => item.addEventListener("change", updateCount));
    updateCount();
  };

  setupBulkSelection("contract");
  setupBulkSelection("demo");
})();
</script>
{% endblock %}
