{% extends "base.html" %}
{% from "owner_forms.html" import owner_principal_input with context %}
{% block content %}
<div class="section-header">
  <div>
    <h1>Edit Project</h1>
    <p>{{ project.project_name }}</p>
  </div>
  <div class="button-group">
    <a class="button-link subtle" href="/help/edit-project">? Help</a>
    <a class="button-link subtle" href="/projects/{{ project.project_id }}/summary?return_to={{ return_to|urlencode }}">Project Detail</a>
    <a class="button-link" href="{{ return_to }}">Back To List</a>
  </div>
</div>

<section class="card section-divider">
  <form method="post" action="{{ form_action }}" class="grid grid-3" data-project-link-picker>
    <input type="hidden" name="return_to" value="{{ return_to }}">
    <label>Project Name
      <input type="text" name="project_name" value="{{ project.project_name }}" required>
    </label>
    <label>Project Type
      <select name="project_type">
        {% for value in project_types %}
        <option value="{{ value }}" {% if value == project.project_type %}selected{% endif %}>{{ value }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Status
      <select name="status">
        {% for value in project_statuses %}
        <option value="{{ value }}" {% if value == project.status %}selected{% endif %}>{{ value }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Start Date<input type="date" name="start_date" value="{{ project.start_date }}"></label>
    <label>Target Date<input type="date" name="target_date" value="{{ project.target_date }}"></label>
    {{ owner_principal_input("owner_principal", project.owner_principal or "", "Owner Principal", "user@company.com") }}
    <label class="full">Description
      <textarea name="description" rows="4">{{ project.description or '' }}</textarea>
    </label>

    <div class="full">
      <label>Linked Vendors</label>
      <div class="typeahead-block">
        <input type="text" placeholder="Search vendors..." autocomplete="off" data-vendor-search>
        <div class="typeahead-results hidden" data-vendor-results></div>
      </div>
      <div class="chip-list" data-vendor-selected></div>
      <div data-vendor-hidden-inputs></div>
      <small class="muted">Projects can be attached to multiple vendors.</small>
    </div>

    <div class="full">
      <label>Linked Offerings</label>
      <div class="typeahead-block">
        <input type="text" placeholder="Search offerings..." autocomplete="off" data-offering-search>
        <div class="typeahead-results hidden" data-offering-results></div>
      </div>
      <div class="chip-list" data-offering-selected></div>
      <div data-offering-hidden-inputs></div>
      <small class="muted">Selecting offerings auto-attaches their vendor(s).</small>
    </div>

    <label class="full">Reason
      <input type="text" name="reason" placeholder="Why this update is needed" required>
    </label>
    <div><button type="submit">Save Project</button></div>
  </form>
</section>

<script id="project-initial-vendors" type="application/json">{{ selected_vendor_rows|tojson }}</script>
<script id="project-initial-offerings" type="application/json">{{ selected_offering_rows|tojson }}</script>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const root = document.querySelector("[data-project-link-picker]");
  if (!root) return;

  const parseJson = (id) => {
    const node = document.getElementById(id);
    if (!node) return [];
    try {
      const parsed = JSON.parse(node.textContent || "[]");
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  };

  function buildMultiPicker(config) {
    const state = new Map();
    const input = config.input;
    const results = config.results;
    const selected = config.selected;
    const hidden = config.hidden;
    let timer = null;

    const hideResults = () => {
      results.innerHTML = "";
      results.classList.add("hidden");
    };

    const syncHidden = () => {
      hidden.innerHTML = "";
      state.forEach((item, key) => {
        const hiddenInput = document.createElement("input");
        hiddenInput.type = "hidden";
        hiddenInput.name = config.hiddenName;
        hiddenInput.value = key;
        hidden.appendChild(hiddenInput);
      });
    };

    const renderSelected = () => {
      selected.innerHTML = "";
      state.forEach((item, key) => {
        const chip = document.createElement("span");
        chip.className = "item-chip";
        const label = document.createElement("span");
        label.textContent = config.renderLabel(item);
        const remove = document.createElement("button");
        remove.type = "button";
        remove.className = "chip-remove";
        remove.textContent = "x";
        remove.title = config.removeLabel;
        remove.setAttribute("aria-label", `${config.removeLabel}: ${config.renderLabel(item)}`);
        remove.addEventListener("click", () => {
          state.delete(key);
          renderSelected();
          syncHidden();
          if (config.onChange) config.onChange(item, "remove");
        });
        chip.appendChild(label);
        chip.appendChild(remove);
        selected.appendChild(chip);
      });
    };

    const addItem = (item) => {
      const key = config.getId(item);
      if (!key || state.has(key)) return;
      state.set(key, item);
      renderSelected();
      syncHidden();
      if (config.onChange) config.onChange(item, "add");
    };

    const search = async () => {
      const query = (input.value || "").trim();
      if (!query) {
        hideResults();
        return;
      }
      const items = await config.fetchItems(query);
      const filtered = items.filter((item) => {
        const key = config.getId(item);
        return key && !state.has(key);
      });
      results.innerHTML = "";
      if (!filtered.length) {
        hideResults();
        return;
      }
      filtered.forEach((item) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "typeahead-option";
        btn.textContent = config.renderLabel(item);
        btn.addEventListener("click", () => {
          addItem(item);
          input.value = "";
          hideResults();
        });
        results.appendChild(btn);
      });
      results.classList.remove("hidden");
    };

    input.addEventListener("input", () => {
      if (timer) window.clearTimeout(timer);
      timer = window.setTimeout(search, 180);
    });
    document.addEventListener("click", (event) => {
      if (!results.contains(event.target) && event.target !== input) hideResults();
    });

    config.initial.forEach(addItem);
    return {
      add: addItem,
      ids: () => Array.from(state.keys()),
    };
  }

  const vendorPicker = buildMultiPicker({
    input: root.querySelector("[data-vendor-search]"),
    results: root.querySelector("[data-vendor-results]"),
    selected: root.querySelector("[data-vendor-selected]"),
    hidden: root.querySelector("[data-vendor-hidden-inputs]"),
    hiddenName: "linked_vendors",
    removeLabel: "Remove Vendor",
    initial: parseJson("project-initial-vendors"),
    getId: (item) => (item.vendor_id || "").trim(),
    renderLabel: (item) => `${item.label || item.vendor_id} (${item.vendor_id})`,
    fetchItems: async (q) => {
      const response = await fetch(`/api/vendors/search?q=${encodeURIComponent(q)}&limit=15`);
      if (!response.ok) return [];
      const payload = await response.json();
      return payload.items || [];
    },
  });

  buildMultiPicker({
    input: root.querySelector("[data-offering-search]"),
    results: root.querySelector("[data-offering-results]"),
    selected: root.querySelector("[data-offering-selected]"),
    hidden: root.querySelector("[data-offering-hidden-inputs]"),
    hiddenName: "linked_offerings",
    removeLabel: "Remove Offering",
    initial: parseJson("project-initial-offerings"),
    getId: (item) => (item.offering_id || "").trim(),
    renderLabel: (item) => item.label || item.offering_id || "",
    fetchItems: async (q) => {
      const vendorIds = vendorPicker ? vendorPicker.ids() : [];
      const params = new URLSearchParams({ q, limit: "15" });
      if (vendorIds.length === 1) params.set("vendor_id", vendorIds[0]);
      const response = await fetch(`/api/offerings/search?${params.toString()}`);
      if (!response.ok) return [];
      const payload = await response.json();
      return payload.items || [];
    },
    onChange: (item, action) => {
      if (action !== "add" || !vendorPicker) return;
      const vendorId = (item.vendor_id || "").trim();
      if (!vendorId) return;
      const vendorLabel = (item.vendor_display_name || vendorId).trim();
      if (!vendorPicker.ids().includes(vendorId)) {
        vendorPicker.add({ vendor_id: vendorId, label: vendorLabel });
      }
    },
  });
})();
</script>
{% endblock %}
