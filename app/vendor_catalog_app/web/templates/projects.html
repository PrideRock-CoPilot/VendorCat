{% extends "base.html" %}
{% block content %}
<div class="section-header">
  <div>
    <h1>Projects</h1>
    <p>Global project workspace across all vendors.</p>
  </div>
</div>

<form method="get" action="/projects" class="card grid grid-3">
  <label>
    Search
    <input type="text" name="search" value="{{ filters.search }}" placeholder="Project, owner, vendor, type...">
  </label>
  <label>
    Status
    <select name="status">
      {% for option in status_options %}
      <option value="{{ option }}" {% if option == filters.status %}selected{% endif %}>{{ option }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Vendor
    <input type="hidden" name="vendor" value="{{ filters.vendor }}" data-project-vendor-id>
    <input type="text" value="{{ filters.vendor_label or '' }}" placeholder="Search vendor..." autocomplete="off" data-project-vendor-search>
    <div class="typeahead-results hidden" data-project-vendor-results></div>
    <small class="muted">Leave blank for all vendors.</small>
  </label>
  <div>
    <button type="submit">Apply Filters</button>
    <button type="button" class="button-link subtle" data-clear-vendor-filter style="margin-left:6px;">Clear Vendor</button>
  </div>
</form>

{% if can_edit and not locked_mode %}
<section class="card section-divider">
  <h2>New Project</h2>
  <p>You can create projects before assigning vendors. Attach vendors and offerings in the project form.</p>
  <a class="button-link" href="/projects/new?return_to=%2Fprojects">Create Project</a>
</section>
{% endif %}

<section class="card section-divider">
  <h2>Project List</h2>
  <table>
    <thead>
      <tr>
        <th>Project</th>
        <th>Vendor</th>
        <th>Status</th>
        <th>Type</th>
        <th>Owner</th>
        <th>Target</th>
        <th>Demos</th>
        <th>Last Activity</th>
      </tr>
    </thead>
    <tbody>
    {% for row in rows %}
    <tr class="clickable-row" data-href="{{ row._open_link }}">
      <td>{{ row.project_name }}</td>
      <td>{{ row.vendor_display_name }}</td>
      <td>{{ row.status }}</td>
      <td>{{ row.project_type }}</td>
      <td>{{ row.owner_principal }}</td>
      <td>{{ row.target_date }}</td>
      <td>{{ row.demo_count }}</td>
      <td>{{ row.last_activity_at }}</td>
    </tr>
    {% else %}
    <tr><td colspan="8">No projects found.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const vendorInput = document.querySelector("[data-project-vendor-search]");
  const vendorHidden = document.querySelector("[data-project-vendor-id]");
  const results = document.querySelector("[data-project-vendor-results]");
  const clearBtn = document.querySelector("[data-clear-vendor-filter]");
  if (!vendorInput || !vendorHidden || !results) return;

  let timer = null;
  const hideResults = () => {
    results.innerHTML = "";
    results.classList.add("hidden");
  };
  const search = async (query) => {
    if (!query) {
      hideResults();
      return;
    }
    const response = await fetch(`/api/vendors/search?q=${encodeURIComponent(query)}&limit=10`);
    if (!response.ok) {
      hideResults();
      return;
    }
    const payload = await response.json();
    const items = payload.items || [];
    results.innerHTML = "";
    if (!items.length) {
      hideResults();
      return;
    }
    items.forEach((item) => {
      const option = document.createElement("button");
      option.type = "button";
      option.className = "typeahead-option";
      option.textContent = `${item.label || item.vendor_id} (${item.vendor_id})`;
      option.addEventListener("click", () => {
        vendorInput.value = item.label || item.vendor_id;
        vendorHidden.value = item.vendor_id || "all";
        hideResults();
      });
      results.appendChild(option);
    });
    results.classList.remove("hidden");
  };

  vendorInput.addEventListener("input", () => {
    const raw = (vendorInput.value || "").trim();
    if (!raw) {
      vendorHidden.value = "all";
      hideResults();
      return;
    }
    if (timer) window.clearTimeout(timer);
    timer = window.setTimeout(() => search(raw), 180);
  });
  document.addEventListener("click", (event) => {
    if (!results.contains(event.target) && event.target !== vendorInput) hideResults();
  });
  if (clearBtn) {
    clearBtn.addEventListener("click", () => {
      vendorInput.value = "";
      vendorHidden.value = "all";
      hideResults();
    });
  }
})();
</script>
{% endblock %}
