{% extends "base.html" %}
{% block content %}
<h1>Demo Outcomes</h1>
<p class="muted">Capture outcomes, then use shared review forms for multi-reviewer grading and summary scoring.</p>

<section class="card">
  <table>
    <thead>
      <tr><th>Demo</th><th>Vendor</th><th>Offering</th><th>Date</th><th>Score</th><th>Outcome</th><th>Reason</th><th>Notes</th><th>Review Form</th></tr>
    </thead>
    <tbody>
      {% for row in rows %}
      <tr>
        <td>{{ row.demo_id }}</td>
        <td>{{ row.vendor_id }}</td>
        <td>{{ row.offering_id }}</td>
        <td>{{ row.demo_date }}</td>
        <td>{{ row.overall_score }}</td>
        <td>{{ row.selection_outcome }}</td>
        <td>{{ row.non_selection_reason_code }}</td>
        <td>{{ row.notes }}</td>
        <td>{% if row.review_form_url %}<a href="{{ row.review_form_url }}">Open</a>{% endif %}</td>
      </tr>
      {% else %}
      <tr><td colspan="9">No demo outcomes</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

{% if can_edit %}
<section class="card">
  <h2>Add Demo Outcome</h2>
  <form method="post" action="/demos" class="grid grid-3">
    <label>Vendor ID
      <div class="typeahead-block">
        <input type="text" name="vendor_id" required autocomplete="off" data-demo-vendor-search placeholder="Search vendor name or id...">
        <div class="typeahead-results hidden" data-demo-vendor-results></div>
      </div>
      <small class="muted">Select a vendor from search results to auto-fill vendor ID.</small>
    </label>
    <label>Offering ID
      <div class="typeahead-block">
        <input type="text" name="offering_id" autocomplete="off" data-demo-offering-search placeholder="Search offering name or id...">
        <div class="typeahead-results hidden" data-demo-offering-results></div>
      </div>
      <small class="muted">Optional. Results are filtered by selected vendor when possible.</small>
    </label>
    <label>Demo Date<input type="date" name="demo_date" value="{{ today }}"></label>
    <label>Overall Score<input type="number" step="0.1" min="0" max="10" name="overall_score" value="7.0"></label>
    <label>Selection Outcome
      <select name="selection_outcome">
        <option value="selected">selected</option>
        <option value="not_selected">not_selected</option>
        <option value="deferred">deferred</option>
      </select>
    </label>
    <label>Non-selection Reason<input type="text" name="non_selection_reason_code"></label>
    <label class="full">Notes<textarea name="notes" rows="2"></textarea></label>
    <div><button type="submit">Save Demo Outcome</button></div>
  </form>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
(() => {
  const vendorInput = document.querySelector("input[data-demo-vendor-search]");
  const vendorResults = document.querySelector("[data-demo-vendor-results]");
  const offeringInput = document.querySelector("input[data-demo-offering-search]");
  const offeringResults = document.querySelector("[data-demo-offering-results]");
  if (!vendorInput || !vendorResults || !offeringInput || !offeringResults) return;

  let vendorTimer = null;
  let offeringTimer = null;
  let vendorRequestSeq = 0;
  let offeringRequestSeq = 0;

  const hideResults = (target) => {
    target.innerHTML = "";
    target.classList.add("hidden");
  };

  const renderTypeahead = (target, items, toLabel, onPick) => {
    target.innerHTML = "";
    if (!items.length) {
      hideResults(target);
      return;
    }
    items.forEach((item) => {
      const option = document.createElement("button");
      option.type = "button";
      option.className = "typeahead-option";
      option.textContent = toLabel(item);
      option.addEventListener("click", () => onPick(item));
      target.appendChild(option);
    });
    if (!target.children.length) {
      hideResults(target);
      return;
    }
    target.classList.remove("hidden");
  };

  const searchVendors = async () => {
    const query = String(vendorInput.value || "").trim();
    if (!query) {
      hideResults(vendorResults);
      return;
    }
    const seq = vendorRequestSeq + 1;
    vendorRequestSeq = seq;
    try {
      const response = await fetch(`/api/vendors/search?q=${encodeURIComponent(query)}&limit=15`);
      if (!response.ok) {
        hideResults(vendorResults);
        return;
      }
      const payload = await response.json();
      if (seq !== vendorRequestSeq) return;
      const items = Array.isArray(payload.items) ? payload.items : [];
      renderTypeahead(
        vendorResults,
        items.filter((item) => String(item.vendor_id || "").trim()),
        (item) => String(item.label || item.vendor_id || "").trim(),
        (item) => {
          vendorInput.value = String(item.vendor_id || "").trim();
          hideResults(vendorResults);
        },
      );
    } catch {
      hideResults(vendorResults);
    }
  };

  const searchOfferings = async () => {
    const query = String(offeringInput.value || "").trim();
    if (!query) {
      hideResults(offeringResults);
      return;
    }
    const seq = offeringRequestSeq + 1;
    offeringRequestSeq = seq;
    const vendorId = String(vendorInput.value || "").trim();
    const params = new URLSearchParams({ q: query, limit: "15" });
    if (vendorId) params.set("vendor_id", vendorId);
    try {
      const response = await fetch(`/api/offerings/search?${params.toString()}`);
      if (!response.ok) {
        hideResults(offeringResults);
        return;
      }
      const payload = await response.json();
      if (seq !== offeringRequestSeq) return;
      const items = Array.isArray(payload.items) ? payload.items : [];
      renderTypeahead(
        offeringResults,
        items.filter((item) => String(item.offering_id || "").trim()),
        (item) => String(item.label || item.offering_id || "").trim(),
        (item) => {
          offeringInput.value = String(item.offering_id || "").trim();
          hideResults(offeringResults);
        },
      );
    } catch {
      hideResults(offeringResults);
    }
  };

  vendorInput.addEventListener("input", () => {
    if (vendorTimer) window.clearTimeout(vendorTimer);
    vendorTimer = window.setTimeout(searchVendors, 180);
  });
  offeringInput.addEventListener("input", () => {
    if (offeringTimer) window.clearTimeout(offeringTimer);
    offeringTimer = window.setTimeout(searchOfferings, 180);
  });

  document.addEventListener("click", (event) => {
    if (!vendorResults.contains(event.target) && event.target !== vendorInput) {
      hideResults(vendorResults);
    }
    if (!offeringResults.contains(event.target) && event.target !== offeringInput) {
      hideResults(offeringResults);
    }
  });
})();
</script>
{% endblock %}

