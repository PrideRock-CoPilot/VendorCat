{% extends "base.html" %}
{% from "doc_link_form.html" import render_doc_link_form with context %}
{% from "owner_forms.html" import project_owner_update_form with context %}
{% block content %}
<div class="section-header">
  <div>
    <h1>{{ project.project_name }}</h1>
    <p>Standalone project workspace.</p>
  </div>
  <div class="button-group">
    {% if can_edit and not locked_mode %}
    <a class="button-link subtle" href="/projects/{{ project_id }}/edit?return_to={{ return_to|urlencode }}">Edit Project</a>
    {% endif %}
    {% if vendor_id %}
    <a class="button-link subtle" href="/vendors/{{ vendor_id }}/summary?return_to={{ return_to|urlencode }}">Open Vendor</a>
    {% endif %}
    <a class="button-link" href="{{ return_to }}">Back</a>
  </div>
</div>

<section class="metrics">
  <div class="metric"><span>Status</span><strong>{{ summary.status }}</strong></div>
  <div class="metric"><span>Type</span><strong>{{ summary.project_type }}</strong></div>
  <div class="metric"><span>Owner</span><strong>{{ project.owner_principal or "-" }}</strong></div>
  <div class="metric"><span>Vendors</span><strong>{{ summary.vendor_count }}</strong></div>
  <div class="metric"><span>Offerings</span><strong>{{ summary.offering_count }}</strong></div>
  <div class="metric"><span>Demos</span><strong>{{ summary.demo_count }}</strong></div>
  <div class="metric"><span>Notes</span><strong>{{ summary.note_count }}</strong></div>
  <div class="metric"><span>Docs</span><strong>{{ summary.doc_count }}</strong></div>
</section>

<section class="card section-nav-card">
  <div class="section-nav-links">
    {% for item in project_nav %}
    <a class="{% if item.active %}active{% endif %}" href="{{ item.url }}">{{ item.label }}</a>
    {% endfor %}
  </div>
</section>

{% if section == "summary" %}
{% if can_edit and not locked_mode %}
<section class="card section-divider">
  <h2>Quick Actions</h2>
  <div class="button-group">
    {% if vendor_id %}
    <a class="button-link" href="/vendors/{{ vendor_id }}/projects/{{ project_id }}/demos/new?return_to=/projects/{{ project_id }}/demos">+ Add Demo</a>
    {% endif %}
    <a class="button-link subtle" href="/projects/{{ project_id }}/docs?return_to={{ return_to|urlencode }}">+ Add Document</a>
    <a class="button-link subtle" href="/projects/{{ project_id }}/notes?return_to={{ return_to|urlencode }}#add-note">+ Add Note</a>
  </div>
</section>
{% endif %}
<div class="grid grid-2">
  <section class="card section-divider">
    <h2>Project Summary</h2>
    <table>
      <tbody>
      <tr><th>Project ID</th><td>{{ project.project_id }}</td></tr>
      <tr>
        <th>Vendors</th>
        <td>
          {% for row in project_vendors %}
            <a href="/vendors/{{ row.vendor_id }}/summary?return_to={{ return_to|urlencode }}">{{ row.vendor_display_name }}</a>{% if not loop.last %}, {% endif %}
          {% else %}
            <span class="muted">No vendors attached</span>
          {% endfor %}
        </td>
      </tr>
      <tr><th>Status</th><td>{{ project.status }}</td></tr>
      <tr><th>Type</th><td>{{ project.project_type }}</td></tr>
      <tr><th>Start Date</th><td>{{ project.start_date }}</td></tr>
      <tr><th>Target Date</th><td>{{ project.target_date }}</td></tr>
      <tr><th>Owner</th><td>{{ project.owner_principal }}</td></tr>
      <tr><th>Description</th><td>{{ project.description }}</td></tr>
      </tbody>
    </table>
  </section>
  <section class="card section-divider">
    <h2>Quick Health</h2>
    <table>
      <tbody>
      <tr><th>Linked Offerings</th><td>{{ summary.offering_count }}</td></tr>
      <tr><th>Project Demos</th><td>{{ summary.demo_count }}</td></tr>
      <tr><th>Document Links</th><td>{{ summary.doc_count }}</td></tr>
      <tr><th>Owners</th><td>{{ summary.owner_count }}</td></tr>
      </tbody>
    </table>
  </section>
</div>

<section class="card section-divider">
  <h2>Recent Notes</h2>
  <table>
    <thead><tr><th>When</th><th>Author</th><th>Note</th></tr></thead>
    <tbody>
    {% for row in project_notes[:5] %}
    <tr><td>{{ row.created_at }}</td><td>{{ row.created_by }}</td><td>{{ row.note_text }}</td></tr>
    {% else %}
    <tr><td colspan="3">No notes yet.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

{% if section == "ownership" %}
<div class="grid grid-2">
  <section class="card section-divider">
    <h2>Project Ownership</h2>
    {% if can_edit and not locked_mode %}
    {{ project_owner_update_form(
         post_url=owner_update_action,
         return_to="/projects/" ~ project_id ~ "/ownership",
         owner_value=project.owner_principal or "",
         submit_label="Save Owner"
       ) }}
    {% endif %}
    <table>
      <thead><tr><th>Role</th><th>Principal</th></tr></thead>
      <tbody>
      <tr><td>project_owner</td><td>{{ project.owner_principal or "not assigned" }}</td></tr>
      </tbody>
    </table>
  </section>
  <section class="card section-divider">
    <h2>Linked Offering Owners</h2>
    <table>
      <thead><tr><th>Offering</th><th>Owner</th><th>Role</th><th>Active</th></tr></thead>
      <tbody>
      {% for row in project_offering_owners %}
      <tr><td>{{ row.offering_name }}</td><td>{{ row.owner_user_principal }}</td><td>{{ row.owner_role }}</td><td>{{ row.active_flag }}</td></tr>
      {% else %}
      <tr><td colspan="4">No linked offering owners.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
</div>
<section class="card section-divider">
  <h2>Linked Offering Contacts</h2>
  <table>
    <thead><tr><th>Offering</th><th>Name</th><th>Type</th><th>Email</th><th>Phone</th></tr></thead>
    <tbody>
    {% for row in project_offering_contacts %}
    <tr><td>{{ row.offering_name }}</td><td>{{ row.full_name }}</td><td>{{ row.contact_type }}</td><td>{{ row.email }}</td><td>{{ row.phone }}</td></tr>
    {% else %}
    <tr><td colspan="5">No linked offering contacts.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

{% if section == "offerings" %}
<section class="card section-divider">
  <h2>Linked Offerings</h2>
  {% if can_edit and not locked_mode %}
  <form method="post" action="{{ add_offering_action }}" class="grid grid-5" style="margin-bottom:10px;" data-attach-offering-form>
    <input type="hidden" name="return_to" value="/projects/{{ project_id }}/offerings">
    <input type="hidden" name="offering_id" data-selected-offering-id>
    <label>Vendor
      <input type="text" autocomplete="off" placeholder="Search vendor..." data-offering-vendor-filter>
      <div class="typeahead-results hidden" data-vendor-results></div>
      <div class="muted" data-selected-vendor-label>{% if vendor_id %}Selected: {{ vendor_display_name }} ({{ vendor_id }}){% else %}No vendor selected{% endif %}</div>
      <div style="margin-top:6px;">
        <a class="button-link subtle" href="/vendors/new?return_to=%2Fprojects%2F{{ project_id }}%2Fofferings">Add Vendor</a>
      </div>
    </label>
    <label>Offering
      <input type="text" autocomplete="off" placeholder="Search offering to attach..." data-offering-select required>
      <div class="typeahead-results hidden" data-offering-results></div>
      <div class="muted" data-selected-offering-label>No offering selected</div>
      <div style="margin-top:6px;">
        <a class="button-link subtle" href="#" data-create-offering-link>Add Offering</a>
      </div>
    </label>
    <label>Reason
      <input type="text" name="reason" placeholder="Reason (optional)">
    </label>
    <div style="display:flex; align-items:flex-end;">
      <button type="submit">Attach Offering</button>
    </div>
  </form>
  <form method="post" action="{{ add_vendor_action }}" data-auto-attach-vendor>
    <input type="hidden" name="return_to" value="/projects/{{ project_id }}/offerings">
    <input type="hidden" name="vendor_id" data-auto-vendor-id>
    <input type="hidden" name="reason" value="Auto attach from vendor selection">
  </form>
  <div class="muted">Search vendors and offerings on demand. Selecting a vendor auto-attaches it when not already linked.</div>
  <script id="project-linked-vendors" type="application/json">{{ linked_vendor_rows|tojson }}</script>
  <script id="project-linked-offering-ids" type="application/json">{{ current_offering_ids|tojson }}</script>
  {% endif %}
  <table>
    <thead><tr><th>Vendor</th><th>Offering</th><th>Type</th><th>Lifecycle</th><th>Criticality</th><th>Open</th></tr></thead>
    <tbody>
    {% for row in project_offerings %}
    <tr>
      <td>{{ row.vendor_id }}</td>
      <td>{{ row.offering_name }}</td>
      <td>{{ row.offering_type }}</td>
      <td>{{ row.lifecycle_state }}</td>
      <td>{{ row.criticality_tier }}</td>
      <td><a class="button-link subtle" href="/vendors/{{ row.vendor_id }}/offerings/{{ row.offering_id }}?return_to={{ return_to|urlencode }}">Offering</a></td>
    </tr>
    {% else %}
    <tr><td colspan="6">No linked offerings.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

{% if section == "demos" %}
<section class="card section-divider">
  <div class="section-header">
    <div>
      <h2>Project Demos</h2>
      <p>All project demo sessions with links back to vendor demo records.</p>
    </div>
    <div class="button-group">
      {% if can_edit and not locked_mode and vendor_id %}
      <a class="button-link" href="/vendors/{{ vendor_id }}/projects/{{ project_id }}/demos/new?return_to=/projects/{{ project_id }}/demos">+ Add Demo</a>
      {% endif %}
    </div>
  </div>

  {% if can_edit and not locked_mode and vendor_id %}
  <form method="post" action="/vendors/{{ vendor_id }}/projects/{{ project_id }}/demos/map" class="inline-form" style="margin-bottom:10px;">
    <input type="hidden" name="return_to" value="/projects/{{ project_id }}/demos">
    <select name="vendor_demo_id" required>
      {% for option in demo_map_options if option.demo_id %}
      <option value="{{ option.demo_id }}">{{ option.label }}</option>
      {% endfor %}
    </select>
    <button type="submit">Map Existing Vendor Demo</button>
  </form>
  {% elif not vendor_id %}
  <p class="muted">Attach at least one vendor to this project before adding or mapping demos.</p>
  {% endif %}

  <table>
    <thead><tr><th>Vendor</th><th>Demo</th><th>Type</th><th>Outcome</th><th>Score</th><th>Start</th><th>Vendor Demo</th><th>Actions</th></tr></thead>
    <tbody>
    {% for row in project_demos %}
    <tr>
      <td>{{ row.vendor_id }}</td>
      <td>{{ row.demo_name }}</td>
      <td>{{ row.demo_type }}</td>
      <td>{{ row.outcome }}</td>
      <td>{{ row.score }}</td>
      <td>{{ row.demo_datetime_start }}</td>
      <td>
        {% if row.linked_vendor_demo_id and row._linked_vendor_demo_link %}
        <a href="{{ row._linked_vendor_demo_link }}">{{ row.linked_vendor_demo_id }}</a>
        {% elif row.linked_vendor_demo_id %}
        {{ row.linked_vendor_demo_id }}
        {% else %}
        <span class="muted">none</span>
        {% endif %}
      </td>
      <td>
        {% if can_edit and not locked_mode and vendor_id %}
        <form method="post" action="{{ row._remove_action }}" class="inline-form">
          <input type="hidden" name="return_to" value="/projects/{{ project_id }}/demos">
          <button type="submit">Remove</button>
        </form>
        {% else %}
        <span class="muted">-</span>
        {% endif %}
      </td>
    </tr>
    {% else %}
    <tr><td colspan="8">No project demos.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

{% if section == "docs" %}
<section class="card section-divider">
  <h2>Project Documents</h2>
  <table>
    <thead><tr><th>Title</th><th>Source</th><th>Owner</th><th>Tags</th><th>Link</th><th>Action</th></tr></thead>
    <tbody>
    {% for row in project_docs %}
    <tr>
      <td>{{ row.doc_title }}</td>
      <td>{{ row.doc_type }}</td>
      <td>{{ row.owner }}</td>
      <td>{{ row.tags }}</td>
      <td><a href="{{ row.doc_url }}" target="_blank" rel="noopener">Open</a></td>
      <td>
        {% if can_edit and not locked_mode %}
        <form method="post" action="/vendors/docs/{{ row.doc_id }}/remove" class="inline-form">
          <input type="hidden" name="return_to" value="/projects/{{ project_id }}/docs">
          <input type="hidden" name="vendor_id" value="{{ vendor_id }}">
          <button type="submit">Remove</button>
        </form>
        {% endif %}
      </td>
    </tr>
    {% else %}
    <tr><td colspan="6">No project documents.</td></tr>
    {% endfor %}
    </tbody>
  </table>

  {% if can_edit and not locked_mode %}
  <details style="margin-top:12px;">
    <summary><strong>Add New Document Link</strong></summary>
    <div style="margin-top:10px;">
      {{ render_doc_link_form(
           post_url="/projects/" ~ project_id ~ "/docs/link",
           return_to="/projects/" ~ project_id ~ "/docs",
           submit_label="Add Link"
         ) }}
    </div>
  </details>
  {% endif %}
</section>
{% endif %}

{% if section == "notes" %}
<section class="card section-divider" id="add-note">
  <h2>Project Notes</h2>
  {% if can_edit and not locked_mode %}
  <form method="post" action="/projects/{{ project_id }}/notes/add" class="grid grid-2">
    <input type="hidden" name="return_to" value="/projects/{{ project_id }}/notes">
    <label class="full">Add Note
      <textarea name="note_text" rows="3" required></textarea>
    </label>
    <div><button type="submit">Save Note</button></div>
  </form>
  {% endif %}
  <table style="margin-top:10px;">
    <thead><tr><th>When</th><th>Author</th><th>Note</th></tr></thead>
    <tbody>
    {% for row in project_notes %}
    <tr><td>{{ row.created_at }}</td><td>{{ row.created_by }}</td><td>{{ row.note_text }}</td></tr>
    {% else %}
    <tr><td colspan="3">No notes yet.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>

<section class="card section-divider">
  <h2>Project Activity</h2>
  <table>
    <thead><tr><th>When</th><th>Entity</th><th>Action</th><th>Details</th><th>Actor</th></tr></thead>
    <tbody>
    {% for row in project_activity %}
    <tr><td>{{ row.event_ts }}</td><td>{{ row.entity_name }}</td><td>{{ row.action_type }}</td><td>{{ row.change_summary }}</td><td>{{ row.actor_user_principal }}</td></tr>
    {% else %}
    <tr><td colspan="5">No project activity yet.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
const attachOfferingForm = document.querySelector("[data-attach-offering-form]");
if (attachOfferingForm) {
  const vendorFilter = attachOfferingForm.querySelector("[data-offering-vendor-filter]");
  const vendorResults = attachOfferingForm.querySelector("[data-vendor-results]");
  const vendorLabel = attachOfferingForm.querySelector("[data-selected-vendor-label]");
  const offeringInput = attachOfferingForm.querySelector("[data-offering-select]");
  const offeringResults = attachOfferingForm.querySelector("[data-offering-results]");
  const offeringLabel = attachOfferingForm.querySelector("[data-selected-offering-label]");
  const offeringHidden = attachOfferingForm.querySelector("[data-selected-offering-id]");
  const createLink = attachOfferingForm.querySelector("[data-create-offering-link]");
  const autoVendorForm = document.querySelector("[data-auto-attach-vendor]");
  const autoVendorInput = autoVendorForm ? autoVendorForm.querySelector("[data-auto-vendor-id]") : null;
  const projectId = "{{ project_id }}";
  const parseJson = (id) => {
    const node = document.getElementById(id);
    if (!node) return [];
    try {
      const parsed = JSON.parse(node.textContent || "[]");
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  };
  const linkedVendors = new Map();
  parseJson("project-linked-vendors").forEach((row) => {
    const vendorId = (row.vendor_id || "").trim();
    if (vendorId) linkedVendors.set(vendorId, row.label || vendorId);
  });
  const linkedOfferingIds = new Set(parseJson("project-linked-offering-ids").map((value) => String(value || "").trim()));
  let selectedVendorId = {{ vendor_id|tojson }};
  let selectedVendorLabel = {{ vendor_display_name|tojson }};
  let selectedOffering = null;
  let vendorTimer = null;
  let offeringTimer = null;

  const hideResults = (node) => {
    if (!node) return;
    node.innerHTML = "";
    node.classList.add("hidden");
  };

  const updateOfferingState = () => {
    if (!offeringLabel || !offeringHidden) return;
    if (selectedOffering && selectedOffering.offering_id) {
      offeringLabel.textContent = selectedOffering.label || selectedOffering.offering_id;
      offeringHidden.value = selectedOffering.offering_id;
      offeringInput.value = selectedOffering.label || selectedOffering.offering_id;
    } else {
      offeringLabel.textContent = "No offering selected";
      offeringHidden.value = "";
    }
  };

  const updateVendorState = () => {
    if (vendorLabel) {
      if (selectedVendorId) {
        const label = selectedVendorLabel || selectedVendorId;
        vendorLabel.textContent = `Selected: ${label} (${selectedVendorId})`;
      } else {
        vendorLabel.textContent = "No vendor selected";
      }
    }
    if (createLink) {
      if (selectedVendorId) {
        createLink.href = `/projects/${projectId}/offerings/new?vendor_id=${encodeURIComponent(selectedVendorId)}&return_to=/projects/${projectId}/offerings`;
        createLink.classList.remove("disabled");
      } else {
        createLink.href = "#";
        createLink.classList.add("disabled");
      }
    }
  };

  const chooseVendor = (item) => {
    selectedVendorId = (item.vendor_id || "").trim();
    selectedVendorLabel = (item.label || item.vendor_id || "").trim();
    updateVendorState();
    const alreadyLinked = linkedVendors.has(selectedVendorId);
    if (selectedVendorId && autoVendorForm && autoVendorInput && !alreadyLinked) {
      autoVendorInput.value = selectedVendorId;
      autoVendorForm.submit();
    }
  };

  const runVendorSearch = async (query) => {
    if (!vendorResults) return;
    if (!query) {
      hideResults(vendorResults);
      return;
    }
    const response = await fetch(`/api/vendors/search?q=${encodeURIComponent(query)}&limit=10`);
    if (!response.ok) {
      hideResults(vendorResults);
      return;
    }
    const payload = await response.json();
    const items = (payload.items || []).filter((item) => item && item.vendor_id);
    vendorResults.innerHTML = "";
    if (!items.length) {
      hideResults(vendorResults);
      return;
    }
    items.forEach((item) => {
      const option = document.createElement("button");
      option.type = "button";
      option.className = "typeahead-option";
      option.textContent = `${item.label || item.vendor_id} (${item.vendor_id})`;
      option.addEventListener("click", () => {
        chooseVendor(item);
        vendorFilter.value = "";
        hideResults(vendorResults);
      });
      vendorResults.appendChild(option);
    });
    vendorResults.classList.remove("hidden");
  };

  const runOfferingSearch = async (query) => {
    if (!offeringResults) return;
    if (!query) {
      hideResults(offeringResults);
      return;
    }
    const params = new URLSearchParams({ q: query, limit: "12" });
    if (selectedVendorId) params.set("vendor_id", selectedVendorId);
    const response = await fetch(`/api/offerings/search?${params.toString()}`);
    if (!response.ok) {
      hideResults(offeringResults);
      return;
    }
    const payload = await response.json();
    const items = (payload.items || []).filter((item) => {
      const offeringId = String(item.offering_id || "").trim();
      return offeringId && !linkedOfferingIds.has(offeringId);
    });
    offeringResults.innerHTML = "";
    if (!items.length) {
      hideResults(offeringResults);
      return;
    }
    items.forEach((item) => {
      const option = document.createElement("button");
      option.type = "button";
      option.className = "typeahead-option";
      option.textContent = item.label || item.offering_id;
      option.addEventListener("click", () => {
        selectedOffering = item;
        updateOfferingState();
        const offerVendorId = (item.vendor_id || "").trim();
        if (offerVendorId && offerVendorId !== selectedVendorId) {
          chooseVendor({
            vendor_id: offerVendorId,
            label: item.vendor_display_name || offerVendorId,
          });
        }
        hideResults(offeringResults);
      });
      offeringResults.appendChild(option);
    });
    offeringResults.classList.remove("hidden");
  };

  if (vendorFilter) {
    vendorFilter.addEventListener("input", () => {
      if (vendorTimer) window.clearTimeout(vendorTimer);
      vendorTimer = window.setTimeout(() => runVendorSearch((vendorFilter.value || "").trim()), 180);
    });
  }
  if (offeringInput) {
    offeringInput.addEventListener("input", () => {
      selectedOffering = null;
      updateOfferingState();
      if (offeringTimer) window.clearTimeout(offeringTimer);
      offeringTimer = window.setTimeout(() => runOfferingSearch((offeringInput.value || "").trim()), 180);
    });
  }
  document.addEventListener("click", (event) => {
    if (vendorResults && !vendorResults.contains(event.target) && event.target !== vendorFilter) {
      hideResults(vendorResults);
    }
    if (offeringResults && !offeringResults.contains(event.target) && event.target !== offeringInput) {
      hideResults(offeringResults);
    }
  });

  attachOfferingForm.addEventListener("submit", (event) => {
    if (!offeringHidden || !offeringHidden.value) {
      event.preventDefault();
      if (offeringLabel) offeringLabel.textContent = "Select an offering before attaching.";
      return;
    }
    if (selectedVendorId && autoVendorForm && autoVendorInput && !linkedVendors.has(selectedVendorId)) {
      autoVendorInput.value = selectedVendorId;
      autoVendorForm.submit();
    }
  });

  if (selectedVendorId && selectedVendorLabel) {
    updateVendorState();
  } else {
    selectedVendorId = "";
    selectedVendorLabel = "";
    updateVendorState();
  }
  updateOfferingState();
}
</script>
{% endblock %}
