{% extends "base.html" %}
{% block content %}
<div class="breadcrumbs">
  <a href="/demos">Demos</a>
  <span class="breadcrumb-sep">/</span>
  <span aria-current="page">Workspace: {{ demo_id }}</span>
</div>

<div class="section-header">
  <div>
    <h1>Demo Workspace</h1>
    <p>Manage lifecycle stages, reviewer scorecards, and decision readiness for demo {{ demo_id }}.</p>
  </div>
  <div class="button-group">
    <a class="button-link subtle" href="/help/demo-workspace">? Help</a>
    <a class="button-link subtle" href="/demos/{{ demo_id }}/review-form">Open Review Form</a>
    <a class="button-link subtle" href="/demos">Back To Demos</a>
  </div>
</div>

<section class="metrics">
  <div class="metric"><span>Current Stage</span><strong>{{ stage_state.current_stage_label }}</strong></div>
  <div class="metric"><span>Current Outcome</span><strong>{{ demo.selection_outcome }}</strong></div>
  <div class="metric"><span>Recorded Score</span><strong>{{ demo.overall_score if demo.overall_score is not none else '--' }}</strong></div>
  <div class="metric"><span>Scorecards Submitted</span><strong>{{ review_summary.submission_count }}</strong></div>
  <div class="metric"><span>Average Team Score</span><strong>{{ review_summary.overall_avg if review_summary.overall_avg is not none else '--' }}</strong></div>
</section>

<section class="card">
  <h2>Lifecycle Stages</h2>
  <div class="stage-rail">
    {% for step in stage_state.steps %}
    <div class="stage-step stage-{{ step.state }}">
      <span class="stage-dot"></span>
      <span class="stage-label">{{ step.label }}</span>
    </div>
    {% endfor %}
  </div>

  {% if can_edit and not locked_mode %}
  <form method="post" action="/demos/{{ demo_id }}/stage" class="grid grid-3 section-divider">
    <label>
      Move Stage To
      <select name="stage">
        {% for code in stage_order %}
        <option value="{{ code }}" {% if code == stage_state.current_stage %}selected{% endif %}>{{ stage_labels.get(code, code) }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="full">
      Stage Notes
      <textarea name="notes" rows="2" placeholder="Capture key context, blockers, or approvals."></textarea>
    </label>
    <div><button type="submit">Update Stage</button></div>
  </form>
  {% endif %}

  <div class="table-wrap section-divider">
    <table>
      <thead><tr><th>Stage</th><th>Changed At</th><th>Changed By</th><th>Notes</th></tr></thead>
      <tbody>
        {% for row in stage_state.history_rows %}
        <tr>
          <td>{{ row.stage_label }}</td>
          <td>{{ row.changed_at }}</td>
          <td>{{ row.changed_by }}</td>
          <td>{{ row.notes or '--' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="4">No explicit stage history yet. Current stage inferred from outcome.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Scoring Cards</h2>
  <p class="muted">Each submitted scorecard is listed with reviewer totals and criterion-level entries.</p>
  <div class="table-wrap">
    <table>
      <thead><tr><th>Reviewer</th><th>Submitted</th><th>Overall (0-10)</th><th>Total Points</th><th>Comment</th><th>Criteria Breakdown</th></tr></thead>
      <tbody>
        {% for row in scoring_cards %}
        <tr>
          <td>{{ row.reviewer }}</td>
          <td>{{ row.submitted_at }}</td>
          <td>{{ row.overall_score }}</td>
          <td>{{ row.total_earned }} / {{ row.total_possible }}</td>
          <td>{{ row.comment or '--' }}</td>
          <td>
            {% if row.scores %}
            {% for score in row.scores %}
            <div>{{ score.label }}: {{ score.score }} / {{ score.max_score }}</div>
            {% endfor %}
            {% else %}
            --
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr><td colspan="6">No scorecards submitted yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Score Rollup</h2>
  <div class="table-wrap">
    <table>
      <thead><tr><th>Criterion</th><th>Average Score</th><th>Responses</th></tr></thead>
      <tbody>
        {% for row in review_summary.criterion_stats %}
        <tr>
          <td>{{ row.label }}</td>
          <td>{{ row.avg_score if row.avg_score is not none else '--' }}</td>
          <td>{{ row.response_count }}</td>
        </tr>
        {% else %}
        <tr><td colspan="3">No criterion rollup available yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}

