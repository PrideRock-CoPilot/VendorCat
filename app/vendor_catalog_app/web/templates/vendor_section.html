{% extends "base.html" %}
{% from "doc_link_form.html" import render_doc_link_form with context %}
{% from "owner_forms.html" import vendor_owner_add_form, vendor_org_assignment_add_form, vendor_contact_add_form with context %}
{% block content %}
{% set section_labels = {
  "summary": "Summary",
  "ownership": "Ownership",
  "contracts": "Contracts",
  "demos": "Demos",
  "lineage": "Lineage",
  "changes": "Changes"
} %}
{% set section_label = section_labels.get(section, section|replace("_", " ")|title) %}
<nav class="breadcrumbs" aria-label="Breadcrumb">
  <a href="{{ return_to }}">Vendor 360</a>
  <span class="breadcrumb-sep" aria-hidden="true">/</span>
  {% if section == "summary" %}
  <span aria-current="page">{{ vendor_display_name }}</span>
  {% else %}
  <a href="/vendors/{{ vendor_id }}/summary?return_to={{ return_to|urlencode }}">{{ vendor_display_name }}</a>
  <span class="breadcrumb-sep" aria-hidden="true">/</span>
  <span aria-current="page">{{ section_label }}</span>
  {% endif %}
</nav>
<div class="section-header">
  <div>
    <h1>{{ vendor_display_name }}</h1>
    <p>Vendor 360 high-level profile, governance, and audit.</p>
  </div>
  <div class="button-group">
    <a class="button-link subtle" href="/help/vendor-360-overview">? Help</a>
    <a class="button-link subtle" href="/vendors/{{ vendor_id }}/offerings?return_to={{ return_to|urlencode }}">Offerings</a>
    <a class="button-link" href="{{ return_to }}">Back To List</a>
  </div>
</div>

<section class="metrics">
  <div class="metric"><span>Lifecycle</span><strong>{{ summary.lifecycle_state }}</strong></div>
  <div class="metric"><span>Risk Tier</span><strong>{{ summary.risk_tier }}</strong></div>
  <div class="metric"><span>Offerings</span><strong>{{ summary.offering_count|int }}</strong></div>
  <div class="metric"><span>Active Contracts</span><strong>{{ summary.active_contract_count|int }}</strong></div>
  <div class="metric"><span>Demos Selected</span><strong>{{ summary.demos_selected|int }}</strong></div>
  <div class="metric"><span>Demos Not Selected</span><strong>{{ summary.demos_not_selected|int }}</strong></div>
  <div class="metric"><span>Active LOBs</span><strong>{{ (summary.active_lob_values or [])|join(", ") or "none" }}</strong></div>
  <div class="metric"><span>Active Service Types</span><strong>{{ (summary.active_service_type_values or [])|join(", ") or "none" }}</strong></div>
</section>

<section class="card section-nav-card">
  <div class="section-nav-links">
    {% for item in vendor_nav %}
    <a class="{% if item.active %}active{% endif %}" href="{{ item.url }}">{{ item.label }}</a>
    {% endfor %}
  </div>
</section>

{% if section == "summary" %}
<div class="grid grid-2">
  <section class="card section-divider">
    <h2>Key Facts</h2>
    <table>
      <thead><tr><th>Field</th><th>Value</th></tr></thead>
      <tbody>
      {% for key, value in key_facts.items() %}
      <tr><td>{{ key }}</td><td>{{ value }}</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
  <section class="card section-divider">
    <h2>Primary Contacts</h2>
    <table>
      <thead><tr><th>Name</th><th>Type</th><th>Email</th></tr></thead>
      <tbody>
      {% for row in top_contacts %}
      <tr><td>{{ row.full_name }}</td><td>{{ row.contact_type }}</td><td>{{ row.email }}</td></tr>
      {% else %}
      <tr><td colspan="3">None</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<section class="card section-divider">
  <div class="section-header">
    <div>
      <h2>Top Offerings</h2>
      <p>Preview of the most relevant offerings for this vendor.</p>
    </div>
    <div>
      <a class="button-link subtle" href="{{ offerings_page_link }}">View All Offerings</a>
    </div>
  </div>
  <table>
    <thead><tr><th>Offering</th><th>Lifecycle</th><th>Criticality</th></tr></thead>
    <tbody>
    {% for row in top_offerings %}
    <tr>
      <td><a href="{{ row._offering_link }}">{{ row.offering_name }}</a></td>
      <td>{{ row.lifecycle_state }}</td>
      <td>{{ row.criticality_tier }}</td>
    </tr>
    {% else %}
    <tr><td colspan="3">No offerings</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>

<div class="grid grid-2">
  <section class="card section-divider">
    <div class="section-header">
      <div>
        <h2>Projects</h2>
        <p>Top active projects for this vendor.</p>
      </div>
      <div>
        <a class="button-link subtle" href="{{ projects_page_link }}">View All Projects</a>
      </div>
    </div>
    <table>
      <thead><tr><th>Project</th><th>Status</th><th>Target Date</th><th>Owner</th></tr></thead>
      <tbody>
      {% for row in projects_preview %}
      <tr>
        <td><a href="{{ row._project_link }}">{{ row.project_name }}</a></td>
        <td>{{ row.status }}</td>
        <td>{{ row.target_date }}</td>
        <td>{{ row.owner_principal }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">No projects yet.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>

  <section class="card section-divider">
    <h2>Documents</h2>
    <table>
      <thead><tr><th>Title</th><th>Source</th><th>Owner</th><th>Tags</th><th>Link</th></tr></thead>
      <tbody>
      {% for row in docs_preview %}
      <tr>
        <td>{{ row.doc_title }}</td>
        <td>{{ row.doc_type }}</td>
        <td>{{ row.owner }}</td>
        <td>{{ row.tags or "-" }}</td>
        <td><a href="{{ row.doc_url }}" target="_blank" rel="noopener">Open</a></td>
      </tr>
      {% else %}
      <tr><td colspan="5">No documents linked yet. Add SharePoint links for contracts, invoices, and governance records.</td></tr>
      {% endfor %}
      </tbody>
    </table>
    {% if can_edit and not locked_mode %}
    <h3 style="margin-top:12px;">Add New Document Link</h3>
    <div style="margin-top:10px;">
      {{ render_doc_link_form(
           post_url="/vendors/" ~ vendor_id ~ "/docs/link",
           return_to=return_to,
           submit_label="Add Link"
         ) }}
    </div>
    {% endif %}
  </section>
</div>

<section class="card section-divider">
  <details>
    <summary><strong>Spend (Last 12 Months)</strong></summary>
    <div class="grid grid-2" style="margin-top:10px;">
      <div>
        <h3>Spend By Category</h3>
        {% if spend_category %}
        <div class="graph-block">
          {% for row in spend_category %}
          <div class="bar-row">
            <div class="bar-label">{{ row.category }}</div>
            <div class="bar-track">
              <div class="bar-fill" style="width: {{ row.bar_pct }}%"></div>
            </div>
            <div class="bar-value">${{ "{:,.0f}".format(row.total_spend or 0) }}</div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p>No spend category data.</p>
        {% endif %}
      </div>
      <div>
        <h3>Monthly Spend Trend</h3>
        {% if spend_trend_points %}
        <svg class="line-chart" viewBox="0 0 560 180" preserveAspectRatio="none">
          <line x1="20" y1="160" x2="540" y2="160" class="axis-line"></line>
          <polyline class="trend-line" points="{{ spend_trend_points }}"></polyline>
          {% for p in spend_trend_plot_rows %}
          <circle class="trend-point" cx="{{ '%.1f'|format(p.plot_x) }}" cy="{{ '%.1f'|format(p.plot_y) }}" r="3"></circle>
          {% endfor %}
        </svg>
        {% else %}
        <p>No monthly trend data.</p>
        {% endif %}
      </div>
    </div>
  </details>
</section>

<section class="card section-divider">
  <details>
    <summary><strong>Show Raw Fields</strong></summary>
    <table style="margin-top:10px;">
      <thead><tr><th>Field</th><th>Value</th></tr></thead>
      <tbody>
      {% for row in raw_fields %}
      <tr><td>{{ row.field }}</td><td>{{ row.value }}</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </details>
</section>
{% endif %}

{% if section == "ownership" %}
{% set vendor_owner_role_options = owner_role_options|default(["business_owner", "executive_owner", "service_owner", "technical_owner", "security_owner", "application_owner", "platform_owner", "legacy_owner"], true) %}
{% set vendor_contact_type_options = contact_type_options|default(["business", "account_manager", "support", "escalation", "security_specialist", "customer_success", "product_manager"], true) %}
{% set vendor_ownership_return_to = "/vendors/" ~ vendor_id ~ "/ownership" %}
<section class="card section-divider">
  <div class="button-group" data-vendor-ownership-tabs role="tablist" aria-label="Vendor ownership areas" style="margin-bottom:10px;">
    <a href="#" class="button-link subtle active-tab" data-vendor-ownership-tab="owners" role="tab" aria-selected="true">Owners</a>
    <a href="#" class="button-link subtle" data-vendor-ownership-tab="contacts" role="tab" aria-selected="false">Contacts</a>
    <a href="#" class="button-link subtle" data-vendor-ownership-tab="org" role="tab" aria-selected="false">Line of Business</a>
  </div>

  <div data-vendor-ownership-panel="owners">
    <div class="section-header">
      <div><h2>Vendor Owners</h2></div>
      {% if can_edit and not locked_mode %}
      <div class="button-group">
        <a
          class="button-link"
          href="#"
          data-workspace-open
          data-workspace-mode="drawer-right"
          data-workspace-title="Add Vendor Owner"
          data-workspace-template="vendor-owner-add-template"
        >Add Owner</a>
      </div>
      {% endif %}
    </div>
    <div class="grid grid-2" style="margin-bottom:10px;">
      <label>Search Owner
        <input type="text" id="vendor-owner-search-filter" placeholder="Principal or display name">
      </label>
      <label>Role Filter
        <select id="vendor-owner-role-filter">
          <option value="">all</option>
          {% for option in vendor_owner_role_options %}
          <option value="{{ option }}">{{ option|replace('_', ' ')|title }}</option>
          {% endfor %}
        </select>
      </label>
    </div>
    <table>
      <thead><tr><th>Owner</th><th>Role</th><th>Active</th></tr></thead>
      <tbody>
      {% for row in owners %}
      <tr data-vendor-owner-filter-row data-owner-principal="{{ row.owner_user_principal|lower }}" data-owner-role="{{ row.owner_role|lower }}">
        <td>{{ row.owner_user_principal }}</td>
        <td>{{ row.owner_role }}</td>
        <td>{{ row.active_flag }}</td>
      </tr>
      {% else %}
      <tr><td colspan="3">No owners</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div data-vendor-ownership-panel="contacts" hidden>
    <div class="section-header">
      <div><h2>Vendor Contacts</h2></div>
      {% if can_edit and not locked_mode %}
      <div class="button-group">
        <a
          class="button-link"
          href="#"
          data-workspace-open
          data-workspace-mode="drawer-right"
          data-workspace-title="Add Vendor Contact"
          data-workspace-template="vendor-contact-add-template"
        >Add Contact</a>
      </div>
      {% endif %}
    </div>
    <div class="grid grid-2" style="margin-bottom:10px;">
      <label>Search Contact
        <input type="text" id="vendor-contact-search-filter" placeholder="Name, email, or phone">
      </label>
      <label>Type Filter
        <select id="vendor-contact-type-filter">
          <option value="">all</option>
          {% for option in vendor_contact_type_options %}
          <option value="{{ option }}">{{ option|replace('_', ' ')|title }}</option>
          {% endfor %}
        </select>
      </label>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Type</th><th>Email</th><th>Phone</th></tr></thead>
      <tbody>
      {% for row in contacts %}
      <tr
        data-vendor-contact-filter-row
        data-contact-name="{{ (row.full_name or '')|lower }}"
        data-contact-email="{{ (row.email or '')|lower }}"
        data-contact-phone="{{ (row.phone or '')|lower }}"
        data-contact-type="{{ (row.contact_type or '')|lower }}"
      >
        <td>{{ row.full_name }}</td>
        <td>{{ row.contact_type }}</td>
        <td>{{ row.email }}</td>
        <td>{{ row.phone }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">No contacts</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div data-vendor-ownership-panel="org" hidden>
    <div class="section-header">
      <div></div>
      {% if can_edit and not locked_mode %}
      <div class="button-group">
        <a
          class="button-link"
          href="#"
          data-workspace-open
          data-workspace-mode="drawer-right"
          data-workspace-title="Set Vendor Line of Business"
          data-workspace-template="vendor-lob-update-template"
        >Set Line of Business</a>
      </div>
      {% endif %}
    </div>
    <table>
      <thead><tr><th title="Select one or more values from the admin-managed Offering LOB lookup list. Primary is optional.">Lines of Business</th></tr></thead>
      <tbody>
      <tr>
        <td>
          {% if ownership_lob_items %}
            <ul style="margin:0; padding-left:18px;">
              {% for item in ownership_lob_items %}
              <li>
                {{ item.lob }}{% if item.is_primary %} (Primary){% endif %}
              </li>
              {% endfor %}
            </ul>
          {% else %}
            Not set
          {% endif %}
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  {% if can_edit and not locked_mode %}
  <template id="vendor-owner-add-template">
    <section>
      <h3>Add Owner</h3>
      {{ vendor_owner_add_form(
           post_url="/vendors/" ~ vendor_id ~ "/owners/add",
           return_to=vendor_ownership_return_to,
           default_role="business_owner",
           submit_label="Add Owner"
         ) }}
    </section>
  </template>
  <template id="vendor-contact-add-template">
    <section>
      <h3>Add Contact</h3>
      {{ vendor_contact_add_form(
           post_url="/vendors/" ~ vendor_id ~ "/contacts/add",
           return_to=vendor_ownership_return_to,
           submit_label="Add Contact"
         ) }}
    </section>
  </template>
  <template id="vendor-lob-update-template">
    <section>
      <h3>Set Vendor Line of Business</h3>
      {% set selected_lob_values = [current_owner_org_id] if current_owner_org_id else [] %}
      {% for row in org_assignments %}
      {% set active_flag_value = (row.active_flag|string)|trim|lower %}
      {% set is_active_assignment = active_flag_value not in ["0", "false", "no", "n"] %}
      {% set assignment_lob = (row.org_id or "")|string %}
      {% if is_active_assignment and assignment_lob and assignment_lob not in selected_lob_values %}
      {% set _ = selected_lob_values.append(assignment_lob) %}
      {% endif %}
      {% endfor %}
      {% set unmanaged_selected_lobs = [] %}
      {% for selected_lob in selected_lob_values %}
      {% if selected_lob not in ownership_lob_options %}
      {% set _ = unmanaged_selected_lobs.append(selected_lob) %}
      {% endif %}
      {% endfor %}
      <form method="post" action="/vendors/{{ vendor_id }}/ownership/lob/update" class="grid grid-1 form-grid" data-overlay-dirty-watch="true">
        <input type="hidden" name="return_to" value="{{ vendor_ownership_return_to }}">
        <label>Search LOB
          <input type="text" id="vendor-lob-search-filter" placeholder="Type to filter options">
        </label>
        <div>
          <span>Line of Business</span>
          <div class="button-group" style="margin:8px 0 6px 0;">
            <button type="button" class="button-link subtle" data-vendor-select-all-lobs>Select All</button>
            <button type="button" class="button-link subtle" data-vendor-clear-all-lobs>Clear All</button>
          </div>
          <div id="vendor-lob-checkboxes" style="border:1px solid var(--border); border-radius:8px; max-height:min(52vh, 420px); overflow:auto; padding:8px; margin-top:6px;">
            <div style="display:grid; grid-template-columns:64px 56px 1fr; align-items:center; gap:12px; margin:0 0 12px 0; font-size:13px; font-weight:700; color:#475569;">
              <span style="white-space:nowrap;">Primary</span>
              <span style="white-space:nowrap;">Active</span>
              <span style="white-space:nowrap;">LOB</span>
            </div>
            {% for option in ownership_lob_options %}
            <div data-vendor-lob-option data-lob-value="{{ option }}">
              <label style="display:grid; grid-template-columns:64px 56px 1fr; align-items:center; gap:12px; padding:6px 0; line-height:1.25; cursor:pointer;">
                <input
                  type="radio"
                  name="primary_lob"
                  value="{{ option }}"
                  data-vendor-primary-radio
                  style="width:auto; min-width:0; margin:0; justify-self:center; visibility:hidden;"
                  {% if option == (current_owner_org_id or "") %}checked{% endif %}
                >
                <input
                  type="checkbox"
                  name="lobs"
                  value="{{ option }}"
                  data-vendor-lob-checkbox
                  style="width:auto; min-width:0; margin:0; justify-self:center;"
                  {% if option in selected_lob_values %}checked{% endif %}
                >
                <span>{{ option }}</span>
              </label>
            </div>
            {% endfor %}
            {% for option in unmanaged_selected_lobs %}
            <div style="display:grid; grid-template-columns:64px 56px 1fr; align-items:center; gap:12px; padding:6px 0; line-height:1.25; opacity:0.8;">
              <input type="radio" disabled style="width:auto; min-width:0; margin:0; justify-self:center; visibility:hidden;">
              <input type="checkbox" checked disabled style="width:auto; min-width:0; margin:0; justify-self:center;">
              <span>{{ option }} (Current, unmanaged)</span>
            </div>
            {% endfor %}
          </div>
        </div>
        <div style="position:sticky; bottom:0; background:var(--card); border-top:1px solid var(--line); padding-top:10px; margin-top:8px;">
          <label>Reason
            <select name="reason_code" data-vendor-reason-code>
              {% for option in org_assignment_reason_options %}
              <option value="{{ option }}" {% if option == "ownership_alignment" %}selected{% endif %}>{{ option|replace('_', ' ')|title }}</option>
              {% endfor %}
            </select>
          </label>
          <label data-vendor-reason-other-wrap style="display:none;">
            Other reason
            <input type="text" name="reason_other_detail" data-vendor-reason-other placeholder="Enter reason" maxlength="200">
          </label>
          <div class="form-actions"><button type="submit">Save Line of Business</button></div>
        </div>
      </form>
    </section>
  </template>
  {% endif %}
</section>
{% endif %}

{% if section == "contracts" %}
<div class="grid grid-2">
  <section class="card section-divider">
    <div class="section-header">
      <h2>Contracts</h2>
      {% if can_edit and not locked_mode %}
      <a class="button-link subtle" href="/vendors/{{ vendor_id }}/offerings?return_to={{ return_to|urlencode }}">Map In Offerings</a>
      {% endif %}
    </div>
    {% if can_edit and not locked_mode %}
    <form method="post" action="/vendors/{{ vendor_id }}/contracts/add" class="grid grid-3" style="margin-bottom:10px;">
      <input type="hidden" name="return_to" value="/vendors/{{ vendor_id }}/contracts?return_to={{ return_to|urlencode }}">
      <label>Contract Number
        <input type="text" name="contract_number" required placeholder="e.g. MS-2026-001">
      </label>
      <label>Offering (optional)
        <select name="offering_id">
          {% for option in offering_options %}
          <option value="{{ option.offering_id }}">{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label>Status
        <select name="contract_status">
          {% for status in contract_status_options %}
          <option value="{{ status }}" {% if status == "active" %}selected{% endif %}>{{ status }}</option>
          {% endfor %}
        </select>
      </label>
      <label>Start Date
        <input type="date" name="start_date">
      </label>
      <label>End Date
        <input type="date" name="end_date">
      </label>
      <label>Annual Value
        <input type="text" name="annual_value" placeholder="e.g. 125000.00">
      </label>
      <label class="full">Reason
        <select name="reason">
          <option value="">Optional</option>
          {% for option in contract_change_reason_options %}
          <option value="{{ option }}">{{ option|replace('_', ' ')|title }}</option>
          {% endfor %}
        </select>
      </label>
      <div><button type="submit">Add Contract</button></div>
    </form>
    {% endif %}
    <table>
      <thead><tr><th>Contract</th><th>Offering</th><th>Status</th><th>Start</th><th>End</th><th>Annual</th><th>Cancelled</th><th>Action</th></tr></thead>
      <tbody>
      {% for row in contracts %}
      <tr>
        <td>
          {% if row.contract_number %}
          {{ row.contract_number }} ({{ row.contract_id }})
          {% else %}
          {{ row.contract_id }}
          {% endif %}
        </td>
        <td>{{ row.offering_id or "Vendor-level" }}</td>
        <td>{{ row.contract_status }}</td>
        <td>{{ row.start_date }}</td>
        <td>{{ row.end_date }}</td>
        <td>{% if row.annual_value is not none %}${{ "{:,.2f}".format(row.annual_value or 0) }}{% else %}-{% endif %}</td>
        <td>{{ row.cancelled_flag }}</td>
        <td>
          {% if can_edit and not locked_mode %}
          <details class="inline-details">
            <summary>Edit Contract</summary>
            <form method="post" action="/vendors/{{ vendor_id }}/contracts/{{ row.contract_id }}/update" class="inline-form" style="margin-top:6px;">
              <input type="hidden" name="return_to" value="/vendors/{{ vendor_id }}/contracts?return_to={{ return_to|urlencode }}">
              <input type="text" name="contract_number" value="{{ row.contract_number or '' }}" placeholder="Contract Number" required>
              <select name="offering_id">
                {% for option in offering_options %}
                <option value="{{ option.offering_id }}" {% if option.offering_id == (row.offering_id or '') %}selected{% endif %}>{{ option.label }}</option>
                {% endfor %}
              </select>
              <select name="contract_status">
                {% for status in contract_status_options %}
                <option value="{{ status }}" {% if status == (row.contract_status|string|lower) %}selected{% endif %}>{{ status }}</option>
                {% endfor %}
              </select>
              <input type="date" name="start_date" value="{{ row.start_date or '' }}">
              <input type="date" name="end_date" value="{{ row.end_date or '' }}">
              <input type="text" name="annual_value" value="{{ row.annual_value or '' }}" placeholder="Annual Value">
              <select name="reason" required>
                <option value="" selected disabled>Select reason</option>
                {% for option in contract_change_reason_options %}
                <option value="{{ option }}">{{ option|replace('_', ' ')|title }}</option>
                {% endfor %}
              </select>
              <button type="submit">Save Contract</button>
            </form>
          </details>
          {% endif %}
          {% if can_edit and not locked_mode and (row.contract_status|string|lower) != "cancelled" %}
          <form method="post" action="/vendors/{{ vendor_id }}/contracts/{{ row.contract_id }}/cancel" class="inline-form" style="margin-top:6px;">
            <input type="hidden" name="return_to" value="/vendors/{{ vendor_id }}/contracts?return_to={{ return_to|urlencode }}">
            <select name="reason_code" required>
              <option value="" selected disabled>Select cancellation reason</option>
              {% for code in contract_cancel_reason_options %}
              <option value="{{ code }}">{{ code|replace('_', ' ')|title }}</option>
              {% endfor %}
            </select>
            <input type="text" name="notes" placeholder="Notes">
            <button type="submit">Cancel Contract</button>
          </form>
          {% else %}
          -
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="8">No contracts</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
  <section class="card section-divider">
    <h2>Contract Events</h2>
    <table>
      <thead><tr><th>Event</th><th>Contract</th><th>Date</th><th>Reason</th></tr></thead>
      <tbody>
      {% for row in contract_events %}
      <tr><td>{{ row.event_type }}</td><td>{{ row.contract_id }}</td><td>{{ row.event_ts }}</td><td>{{ row.reason_code }}</td></tr>
      {% else %}
      <tr><td colspan="4">No events</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
</div>
{% endif %}

{% if section == "demos" %}
<div class="grid grid-2">
  <section class="card section-divider">
    <div class="section-header">
      <h2>Demo Outcomes</h2>
      {% if can_edit and not locked_mode %}
      <a class="button-link subtle" href="/vendors/{{ vendor_id }}/offerings?return_to={{ return_to|urlencode }}">Map In Offerings</a>
      {% endif %}
    </div>
    <table>
      <thead><tr><th>Demo</th><th>Offering</th><th>Date</th><th>Outcome</th><th>Score</th><th>Reason</th></tr></thead>
      <tbody>
      {% for row in demos %}
      <tr><td>{{ row.demo_id }}</td><td>{{ row.offering_id }}</td><td>{{ row.demo_date }}</td><td>{{ row.selection_outcome }}</td><td>{{ row.overall_score }}</td><td>{{ row.non_selection_reason_code }}</td></tr>
      {% else %}
      <tr><td colspan="6">No demos</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
  <section class="card section-divider">
    <h2>Demo Notes</h2>
    <table>
      <thead><tr><th>Demo</th><th>Type</th><th>Note</th></tr></thead>
      <tbody>
      {% for row in demo_notes %}
      <tr><td>{{ row.demo_id }}</td><td>{{ row.note_type }}</td><td>{{ row.note_text }}</td></tr>
      {% else %}
      <tr><td colspan="3">No notes</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<section class="card section-divider">
  <h2>Demo Score Breakdown</h2>
  <table>
    <thead><tr><th>Demo</th><th>Category</th><th>Score</th><th>Weight</th><th>Comments</th></tr></thead>
    <tbody>
    {% for row in demo_scores %}
    <tr><td>{{ row.demo_id }}</td><td>{{ row.score_category }}</td><td>{{ row.score_value }}</td><td>{{ row.weight }}</td><td>{{ row.comments }}</td></tr>
    {% else %}
    <tr><td colspan="5">No demo score details</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

{% if section == "lineage" %}
<div class="grid grid-3">
  <section class="card section-divider">
    <h2>Source Lineage</h2>
    <table>
      <thead><tr><th>Source</th><th>Record</th><th>Batch</th><th>Extract TS</th></tr></thead>
      <tbody>
      {% for row in source_lineage %}
      <tr><td>{{ row.source_system }}</td><td>{{ row.source_record_id }}</td><td>{{ row.source_batch_id }}</td><td>{{ row.source_extract_ts }}</td></tr>
      {% else %}
      <tr><td colspan="4">No lineage data</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
  <section class="card section-divider">
    <h2>Change Requests</h2>
    <table>
      <thead><tr><th>ID</th><th>Type</th><th>Status</th><th>Submitted</th></tr></thead>
      <tbody>
      {% for row in change_requests %}
      <tr><td>{{ row.change_request_id }}</td><td>{{ row.change_type }}</td><td>{{ row.status }}</td><td>{{ row.submitted_at }}</td></tr>
      {% else %}
      <tr><td colspan="4">No change requests</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
  <section class="card section-divider">
    <h2>Audit Events</h2>
    <table>
      <thead><tr><th>When</th><th>Entity</th><th>Action</th><th>Details</th><th>Actor</th></tr></thead>
      <tbody>
      {% for row in audit_events %}
      <tr><td>{{ row.event_ts }}</td><td>{{ row.entity_name }}</td><td>{{ row.action_type }}</td><td>{{ row.change_summary }}</td><td>{{ row.actor_user_principal }}</td></tr>
      {% else %}
      <tr><td colspan="5">No audit events</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
</div>
{% endif %}

{% if section == "changes" %}
{% set current = profile[0] if profile else {} %}
{% if (can_edit or can_submit_requests) and not locked_mode %}
<section class="card section-divider">
  <h2>Change Actions</h2>

  {% if can_direct_apply %}
  <h3>Direct Vendor Profile Update (Audited)</h3>
  <form method="post" action="/vendors/{{ vendor_id }}/direct-update" class="grid grid-3">
    <input type="hidden" name="return_to" value="{{ return_to }}">
    <label>Legal Name<input type="text" name="legal_name" value="{{ current.legal_name or '' }}"></label>
    <label>Display Name<input type="text" name="display_name" value="{{ current.display_name or '' }}"></label>
    <label>Lifecycle State
      <select name="lifecycle_state">
        {% for state in lifecycle_states %}
        <option value="{{ state }}" {% if state == current.lifecycle_state %}selected{% endif %}>{{ state }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Line of Business<input type="text" name="owner_org_id" value="{{ current.owner_org_id or '' }}"></label>
    <label>Risk Tier
      <select name="risk_tier">
        {% for tier in risk_tiers %}
        <option value="{{ tier }}" {% if tier == current.risk_tier %}selected{% endif %}>{{ tier }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="full">Reason For Change (required)
      <select name="reason" required>
        <option value="" selected disabled>Select reason</option>
        {% for option in vendor_profile_change_reason_options %}
        <option value="{{ option }}">{{ option|replace('_', ' ')|title }}</option>
        {% endfor %}
      </select>
    </label>
    <div><button type="submit">Apply Audited Update</button></div>
  </form>
  {% endif %}

  <h3>Request-Based Change</h3>
  <form method="post" action="/vendors/{{ vendor_id }}/change-request" class="grid grid-2">
    <input type="hidden" name="return_to" value="{{ return_to }}">
    <label>Change Type
      <select name="change_type">
        <option value="update_vendor_profile">update_vendor_profile</option>
        <option value="update_contact">update_contact</option>
        <option value="update_offering">update_offering</option>
        <option value="request_lifecycle_change">request_lifecycle_change</option>
      </select>
    </label>
    <label>Approval Level
      <select name="approval_level_required">
        <option value="">default by change type</option>
        {% for level in change_approval_level_options %}
        <option value="{{ level }}">level_{{ level }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Assigned Approver (optional)
      <input type="text" name="assigned_approver" placeholder="approver@example.com">
    </label>
    <label class="full">Notes
      <textarea name="change_notes" rows="2" placeholder="Describe the requested update."></textarea>
    </label>
    <div><button type="submit">Submit Change Request</button></div>
  </form>
</section>
{% else %}
<section class="card section-divider">
  <h2>Change Actions</h2>
  <p>{% if locked_mode %}Locked mode is enabled. Write actions are disabled.{% else %}You have view-only access.{% endif %}</p>
</section>
{% endif %}

<section class="card section-divider">
  <h2>Recent Audited Changes (Last 5)</h2>
  <table>
    <thead><tr><th>When</th><th>Entity</th><th>Action</th><th>Details</th><th>Actor</th><th>Request</th></tr></thead>
    <tbody>
    {% for row in recent_audit %}
    <tr><td>{{ row.event_ts }}</td><td>{{ row.entity_name }}</td><td>{{ row.action_type }}</td><td>{{ row.change_summary }}</td><td>{{ row.actor_user_principal }}</td><td>{{ row.request_id }}</td></tr>
    {% else %}
    <tr><td colspan="6">No recent changes</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
{% if section == "ownership" %}
<script>
(function () {
  const tabContainer = document.querySelector("[data-vendor-ownership-tabs]");
  const tabButtons = Array.from(document.querySelectorAll("[data-vendor-ownership-tab]"));
  const tabPanels = Array.from(document.querySelectorAll("[data-vendor-ownership-panel]"));
  if (tabContainer instanceof HTMLElement && tabButtons.length && tabPanels.length) {
    const showTab = (tabName) => {
      tabButtons.forEach((button) => {
        if (!(button instanceof HTMLElement)) return;
        const isActive = String(button.dataset.vendorOwnershipTab || "") === tabName;
        button.classList.toggle("active-tab", isActive);
        button.setAttribute("aria-selected", isActive ? "true" : "false");
      });
      tabPanels.forEach((panel) => {
        if (!(panel instanceof HTMLElement)) return;
        const isActive = String(panel.dataset.vendorOwnershipPanel || "") === tabName;
        panel.hidden = !isActive;
      });
    };
    tabButtons.forEach((button) => {
      if (!(button instanceof HTMLElement)) return;
      button.addEventListener("click", (event) => {
        event.preventDefault();
        showTab(String(button.dataset.vendorOwnershipTab || "owners"));
      });
    });
    showTab("owners");
  }

  const ownerSearchInput = document.getElementById("vendor-owner-search-filter");
  const ownerRoleSelect = document.getElementById("vendor-owner-role-filter");
  const ownerRows = Array.from(document.querySelectorAll("[data-vendor-owner-filter-row]"));
  if (ownerSearchInput instanceof HTMLInputElement && ownerRoleSelect instanceof HTMLSelectElement && ownerRows.length) {
    const applyOwnerFilters = () => {
      const searchNeedle = String(ownerSearchInput.value || "").trim().toLowerCase();
      const roleNeedle = String(ownerRoleSelect.value || "").trim().toLowerCase();
      ownerRows.forEach((row) => {
        if (!(row instanceof HTMLElement)) return;
        const principal = String(row.dataset.ownerPrincipal || "").toLowerCase();
        const role = String(row.dataset.ownerRole || "").toLowerCase();
        const text = String(row.textContent || "").toLowerCase();
        const searchMatch = !searchNeedle || principal.includes(searchNeedle) || text.includes(searchNeedle);
        const roleMatch = !roleNeedle || role === roleNeedle;
        row.style.display = searchMatch && roleMatch ? "" : "none";
      });
    };
    ownerSearchInput.addEventListener("input", applyOwnerFilters);
    ownerRoleSelect.addEventListener("change", applyOwnerFilters);
  }

  const contactSearchInput = document.getElementById("vendor-contact-search-filter");
  const contactTypeSelect = document.getElementById("vendor-contact-type-filter");
  const contactRows = Array.from(document.querySelectorAll("[data-vendor-contact-filter-row]"));
  if (contactSearchInput instanceof HTMLInputElement && contactTypeSelect instanceof HTMLSelectElement && contactRows.length) {
    const applyContactFilters = () => {
      const searchNeedle = String(contactSearchInput.value || "").trim().toLowerCase();
      const typeNeedle = String(contactTypeSelect.value || "").trim().toLowerCase();
      contactRows.forEach((row) => {
        if (!(row instanceof HTMLElement)) return;
        const name = String(row.dataset.contactName || "").toLowerCase();
        const email = String(row.dataset.contactEmail || "").toLowerCase();
        const phone = String(row.dataset.contactPhone || "").toLowerCase();
        const type = String(row.dataset.contactType || "").toLowerCase();
        const text = String(row.textContent || "").toLowerCase();
        const searchMatch = !searchNeedle || name.includes(searchNeedle) || email.includes(searchNeedle) || phone.includes(searchNeedle) || text.includes(searchNeedle);
        const typeMatch = !typeNeedle || type === typeNeedle;
        row.style.display = searchMatch && typeMatch ? "" : "none";
      });
    };
    contactSearchInput.addEventListener("input", applyContactFilters);
    contactTypeSelect.addEventListener("change", applyContactFilters);
  }

  const initVendorLobPrimaryControls = (root) => {
    if (!(root instanceof HTMLElement || root instanceof Document)) return;
    const container = root.querySelector("#vendor-lob-checkboxes");
    if (!(container instanceof HTMLElement)) return;
    if (container.dataset.vendorLobInit === "true") return;

    const selectAllButton = root.querySelector("button[data-vendor-select-all-lobs]");
    const clearAllButton = root.querySelector("button[data-vendor-clear-all-lobs]");
    const checkboxes = Array.from(container.querySelectorAll("input[data-vendor-lob-checkbox]"));
    const primaryRadios = Array.from(container.querySelectorAll("input[data-vendor-primary-radio]"));
    const searchInput = root.querySelector("#vendor-lob-search-filter");
    const reasonCodeSelect = root.querySelector("select[data-vendor-reason-code]");
    const reasonOtherWrap = root.querySelector("[data-vendor-reason-other-wrap]");
    const reasonOtherInput = root.querySelector("input[data-vendor-reason-other]");
    const lobRows = Array.from(container.querySelectorAll("[data-vendor-lob-option]"));

    container.addEventListener("pointerdown", (event) => {
      const target = event.target;
      if (!(target instanceof Element)) return;
      const row = target.closest("[data-vendor-lob-option]");
      if (!(row instanceof HTMLElement)) return;
      const radio = row.querySelector("input[data-vendor-primary-radio]");
      if (radio instanceof HTMLInputElement) {
        radio.dataset.wasChecked = radio.checked ? "true" : "false";
      }
    });

    const sync = () => {
      let anyChecked = false;

      checkboxes.forEach((checkbox) => {
        if (!(checkbox instanceof HTMLInputElement)) return;
        const isChecked = checkbox.checked;
        const row = checkbox.closest("[data-vendor-lob-option]");
        const radio = row instanceof HTMLElement ? row.querySelector("input[data-vendor-primary-radio]") : null;
        if (!(radio instanceof HTMLInputElement)) return;

        if (isChecked) {
          anyChecked = true;
          radio.style.visibility = "visible";
          radio.disabled = false;
        } else {
          radio.style.visibility = "hidden";
          radio.checked = false;
          radio.disabled = true;
        }
      });

      if (!anyChecked) {
        primaryRadios.forEach((radio) => {
          if (radio instanceof HTMLInputElement) {
            radio.checked = false;
          }
        });
      }
    };

    const applyLobFilter = () => {
      if (!(searchInput instanceof HTMLInputElement)) return;
      const needle = String(searchInput.value || "").trim().toLowerCase();
      lobRows.forEach((row) => {
        if (!(row instanceof HTMLElement)) return;
        const text = String(row.textContent || "").toLowerCase();
        row.style.display = !needle || text.includes(needle) ? "" : "none";
      });
    };

    const syncReasonOther = () => {
      if (!(reasonCodeSelect instanceof HTMLSelectElement)) return;
      const isOther = String(reasonCodeSelect.value || "").trim().toLowerCase() == "other";
      if (reasonOtherWrap instanceof HTMLElement) {
        reasonOtherWrap.style.display = isOther ? "" : "none";
      }
      if (reasonOtherInput instanceof HTMLInputElement) {
        reasonOtherInput.required = isOther;
        if (!isOther) {
          reasonOtherInput.value = "";
        }
      }
    };

    checkboxes.forEach((checkbox) => {
      if (!(checkbox instanceof HTMLInputElement)) return;
      checkbox.addEventListener("change", sync);
    });

    primaryRadios.forEach((radio) => {
      if (!(radio instanceof HTMLInputElement)) return;
      radio.addEventListener("click", (event) => {
        if (radio.dataset.wasChecked !== "true") return;
        event.preventDefault();
        radio.checked = false;
        sync();
      });
      radio.addEventListener("change", () => {
        if (!radio.checked) {
          sync();
          return;
        }
        const value = String(radio.value || "");
        const matchingCheckbox = container.querySelector(
          `input[data-vendor-lob-checkbox][value="${CSS.escape(value)}"]`
        );
        if (matchingCheckbox instanceof HTMLInputElement) {
          matchingCheckbox.checked = true;
        }
        sync();
      });
    });

    if (selectAllButton instanceof HTMLElement) {
      selectAllButton.addEventListener("click", () => {
        checkboxes.forEach((checkbox) => {
          if (checkbox instanceof HTMLInputElement) {
            checkbox.checked = true;
          }
        });
        sync();
      });
    }

    if (clearAllButton instanceof HTMLElement) {
      clearAllButton.addEventListener("click", () => {
        checkboxes.forEach((checkbox) => {
          if (checkbox instanceof HTMLInputElement) {
            checkbox.checked = false;
          }
        });
        primaryRadios.forEach((radio) => {
          if (radio instanceof HTMLInputElement) {
            radio.checked = false;
          }
        });
        sync();
      });
    }

    if (searchInput instanceof HTMLInputElement) {
      searchInput.addEventListener("input", applyLobFilter);
      applyLobFilter();
    }

    if (reasonCodeSelect instanceof HTMLSelectElement) {
      reasonCodeSelect.addEventListener("change", syncReasonOther);
      syncReasonOther();
    }

    sync();
    container.dataset.vendorLobInit = "true";
  };

  initVendorLobPrimaryControls(document);
  const workspaceOverlay = document.getElementById("workspace-overlay");
  if (workspaceOverlay instanceof HTMLElement) {
    workspaceOverlay.addEventListener("workspace-overlay-opened", (event) => {
      const detail = event.detail || {};
      const contentRoot = detail.contentRoot;
      if (contentRoot instanceof HTMLElement) {
        initVendorLobPrimaryControls(contentRoot);
      }
    });
  }
})();
</script>
{% endif %}
{% endblock %}
