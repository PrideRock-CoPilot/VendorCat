{% extends "base.html" %}
{% block content %}
<div class="breadcrumbs">
  <a href="/demos">Demos</a>
  <span class="breadcrumb-sep">/</span>
  <span aria-current="page">Review Form: {{ demo_id }}</span>
</div>

<h1>Demo Review Form</h1>
<p class="muted">Build reusable weighted questionnaires and collect reviewer scoring consistently across demo sessions.</p>
<div class="button-group section-divider">
  <a class="button-link subtle" href="/demos/{{ demo_id }}">Open Demo Workspace</a>
  <a class="button-link subtle" href="/demos">Back To Demos</a>
</div>

<section class="card">
  <table>
    <tbody>
      <tr><th>Demo ID</th><td>{{ demo.demo_id }}</td></tr>
      <tr><th>Vendor</th><td>{{ demo.vendor_id }}</td></tr>
      <tr><th>Offering</th><td>{{ demo.offering_id or "Unassigned" }}</td></tr>
      <tr><th>Demo Date</th><td>{{ demo.demo_date }}</td></tr>
      <tr><th>Current Outcome</th><td>{{ demo.selection_outcome }}</td></tr>
      <tr><th>Recorded Overall Score</th><td>{{ demo.overall_score }}</td></tr>
    </tbody>
  </table>
  {% if is_demo_session_open %}
  <p class="muted"><strong>Session state:</strong> Open. Review owners can submit or update their own answers.</p>
  {% else %}
  <p class="muted"><strong>Session state:</strong> Closed. Review answers are locked.</p>
  {% endif %}
</section>

{% if can_edit %}
<section class="card">
  <h2>Template Library</h2>
  <p class="muted">Saved templates can be attached to this demo so every reviewer uses the same form.</p>
  <div class="table-wrap">
    <table>
      <thead><tr><th>Template</th><th>Questions</th><th>Created By</th><th>Created At</th><th>Action</th></tr></thead>
      <tbody>
        {% for template in library_templates %}
        <tr>
          <td>
            <div><strong>{{ template.title }}</strong></div>
            <div class="muted">{{ template.instructions or "No instructions." }}</div>
          </td>
          <td>{{ template.questions|length }}</td>
          <td>{{ template.created_by }}</td>
          <td>{{ template.created_at }}</td>
          <td>
            <form method="post" action="/demos/{{ demo_id }}/review-form/template/attach">
              <input type="hidden" name="library_template_id" value="{{ template.library_note_id }}">
              <button type="submit">Attach</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="5">No saved templates yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Template Designer</h2>
  <p class="muted">Visual builder for weighted questions. Use scale, boolean, and multi-choice scoring blocks.</p>
  <form method="post" action="/demos/{{ demo_id }}/review-form/template" id="template-designer-form">
    <div class="grid grid-3">
      <label>Template Title
        <input type="text" name="template_title" value="{{ review_template.title if review_template else 'Demo Evaluation Form' }}" required>
      </label>
      <label class="full">Instructions
        <textarea name="instructions" rows="2" placeholder="Explain how reviewers should complete this form.">{% if review_template %}{{ review_template.instructions }}{% endif %}</textarea>
      </label>
      <label>
        <input type="checkbox" name="attach_now" value="1" checked>
        Attach to this demo after save
      </label>
    </div>

    <div class="designer-shell section-divider">
      <aside class="designer-palette">
        <h3>Question Blocks</h3>
        <button class="button-link subtle designer-block-btn" type="button" data-new-type="scale">Sliding Scale</button>
        <button class="button-link subtle designer-block-btn" type="button" data-new-type="boolean">Yes / No</button>
        <button class="button-link subtle designer-block-btn" type="button" data-new-type="multi_choice">Multi Choice</button>
      </aside>

      <div class="designer-canvas-wrap">
        <div class="designer-toolbar">
          <button class="button-link subtle" type="button" id="designer-preview-toggle">Preview</button>
          <span class="muted" id="designer-count-label">0 questions</span>
        </div>
        <div id="designer-canvas" class="designer-canvas"></div>
      </div>

      <aside class="designer-properties">
        <h3>Properties</h3>
        <div id="designer-empty-state" class="muted">Select a question to edit properties.</div>
        <div id="designer-props-panel" class="hidden">
          <label>Question Label
            <input type="text" id="prop-label" maxlength="160">
          </label>
          <label>Question Type
            <select id="prop-type">
              <option value="scale">Sliding Scale</option>
              <option value="boolean">Yes / No</option>
              <option value="multi_choice">Multi Choice</option>
            </select>
          </label>
          <label>Weight
            <input type="number" id="prop-weight" min="0.01" step="0.01">
          </label>
          <label>Help Text
            <textarea id="prop-help" rows="2" maxlength="240"></textarea>
          </label>
          <div id="prop-scale-fields">
            <label>Scale Min
              <input type="number" id="prop-scale-min" step="0.1">
            </label>
            <label>Scale Max
              <input type="number" id="prop-scale-max" step="0.1">
            </label>
            <label>Scale Step
              <input type="number" id="prop-scale-step" step="0.01">
            </label>
          </div>
          <div id="prop-option-fields">
            <label>Option Labels (comma separated)
              <input type="text" id="prop-options" placeholder="Yes, No">
            </label>
            <label>Option Weights (comma separated)
              <input type="text" id="prop-option-weights" placeholder="1, 0">
            </label>
          </div>
          <div class="button-group">
            <button type="button" id="prop-apply-btn">Apply</button>
          </div>
          <div class="button-group section-divider">
            <button type="button" id="prop-move-up" class="button-link subtle">Move Up</button>
            <button type="button" id="prop-move-down" class="button-link subtle">Move Down</button>
            <button type="button" id="prop-duplicate" class="button-link subtle">Duplicate</button>
            <button type="button" id="prop-delete" class="button-link subtle">Delete</button>
          </div>
        </div>
      </aside>
    </div>

    <div id="designer-hidden-inputs"></div>
    <div class="button-group section-divider">
      <button type="submit">Save Template</button>
    </div>
  </form>
</section>
{% endif %}

<section class="card">
  <h2>Current Attached Form</h2>
  {% if review_template %}
  <p class="muted"><strong>{{ review_template.title }}</strong></p>
  {% if review_template.instructions %}
  <p class="muted">{{ review_template.instructions }}</p>
  {% endif %}
  <div class="table-wrap">
    <table>
      <thead><tr><th>Question</th><th>Type</th><th>Weight</th><th>Answer Model</th></tr></thead>
      <tbody>
      {% for question in review_template.questions %}
      <tr>
        <td>{{ question.label }}</td>
        <td>{{ question.question_type }}</td>
        <td>{{ question.weight }}</td>
        <td>
          {% if question.question_type == "scale" %}
          {{ question.scale_min }} to {{ question.scale_max }} (step {{ question.scale_step }})
          {% elif question.options %}
            {% for option in question.options %}
            <div>{{ option.label }} (weight {{ option.weight }})</div>
            {% endfor %}
          {% else %}
          --
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="muted">No form is attached yet.</p>
  {% endif %}
</section>

<section class="card">
  <h2>Submit Your Review</h2>
  {% if my_submission %}
  <p class="muted">Your latest submission is loaded below. You can update it while the demo session is open.</p>
  {% endif %}
  {% if review_template and can_submit_review %}
  <form method="post" action="/demos/{{ demo_id }}/review-form/submit" class="grid grid-2">
    {% for question in review_template.questions %}
    {% set ns = namespace(existing_answer=None) %}
    {% if my_submission %}
      {% for answer in my_submission.answers %}
        {% if answer.code == question.code %}
          {% set ns.existing_answer = answer %}
        {% endif %}
      {% endfor %}
    {% endif %}
    <label class="full">
      {{ question.label }} (weight {{ question.weight }})
      {% if question.help_text %}
      <span class="muted">{{ question.help_text }}</span>
      {% endif %}
      {% if question.question_type == "scale" %}
        {% set default_value = ns.existing_answer.response_value if ns.existing_answer else question.scale_min %}
        <input
          type="range"
          name="answer_{{ question.code }}"
          min="{{ question.scale_min }}"
          max="{{ question.scale_max }}"
          step="{{ question.scale_step }}"
          value="{{ default_value }}"
          oninput="document.getElementById('range_output_{{ question.code }}').value=this.value"
          required
        >
        <div class="muted">
          <span>{{ question.scale_min }}</span>
          <output id="range_output_{{ question.code }}">{{ default_value }}</output>
          <span>{{ question.scale_max }}</span>
        </div>
      {% elif question.question_type == "boolean" %}
        <div class="button-group">
          {% for option in question.options %}
          {% set is_checked = ns.existing_answer and ns.existing_answer.response_value == option.value %}
          <label>
            <input type="radio" name="answer_{{ question.code }}" value="{{ option.value }}" {% if is_checked %}checked{% endif %} required>
            {{ option.label }} ({{ option.weight }})
          </label>
          {% endfor %}
        </div>
      {% else %}
        <select name="answer_{{ question.code }}" required>
          <option value="">Select...</option>
          {% for option in question.options %}
          {% set is_selected = ns.existing_answer and ns.existing_answer.response_value == option.value %}
          <option value="{{ option.value }}" {% if is_selected %}selected{% endif %}>{{ option.label }} (weight {{ option.weight }})</option>
          {% endfor %}
        </select>
      {% endif %}
    </label>
    {% endfor %}
    <label class="full">Reviewer Comment
      <textarea name="review_comment" rows="3">{% if my_submission %}{{ my_submission.comment }}{% endif %}</textarea>
    </label>
    <div><button type="submit">{% if my_submission %}Update My Review{% else %}Submit My Review{% endif %}</button></div>
  </form>
  {% elif not review_template %}
  <p class="muted">Attach a review form template first.</p>
  {% elif not is_demo_session_open %}
  <p class="muted">This demo session is closed. Review answers are read-only.</p>
  {% else %}
  <p class="muted">A valid signed-in identity is required to submit a review.</p>
  {% endif %}
</section>

<section class="card">
  <h2>Review Summary</h2>
  <div class="metrics">
    <div class="metric"><span>Submissions</span><strong>{{ review_summary.submission_count }}</strong></div>
    <div class="metric"><span>Average Score (0-10)</span><strong>{{ review_summary.overall_avg if review_summary.overall_avg is not none else '--' }}</strong></div>
  </div>
  <div class="grid grid-2">
    <div class="table-wrap">
      <table>
        <thead><tr><th>Question</th><th>Average</th><th>Responses</th></tr></thead>
        <tbody>
          {% for row in review_summary.criterion_stats %}
          <tr>
            <td>{{ row.label }}</td>
            <td>{{ row.avg_score if row.avg_score is not none else '--' }}</td>
            <td>{{ row.response_count }}</td>
          </tr>
          {% else %}
          <tr><td colspan="3">No question stats yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Reviewer</th><th>Submitted</th><th>Overall</th><th>Comment</th></tr></thead>
        <tbody>
          {% for row in review_summary.submissions %}
          <tr>
            <td>{{ row.reviewer }}</td>
            <td>{{ row.submitted_at }}</td>
            <td>{{ row.overall_score }}</td>
            <td>{{ row.comment or '--' }}</td>
          </tr>
          {% else %}
          <tr><td colspan="4">No submissions yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
{% if can_edit %}
<script>
(function () {
  const form = document.getElementById("template-designer-form");
  if (!form) return;
  const canvas = document.getElementById("designer-canvas");
  const hiddenInputs = document.getElementById("designer-hidden-inputs");
  const emptyState = document.getElementById("designer-empty-state");
  const propsPanel = document.getElementById("designer-props-panel");
  const previewToggle = document.getElementById("designer-preview-toggle");
  const countLabel = document.getElementById("designer-count-label");
  const propScaleFields = document.getElementById("prop-scale-fields");
  const propOptionFields = document.getElementById("prop-option-fields");
  let previewMode = false;
  let selectedIndex = -1;

  const initialQuestions = {{ (review_template.questions if review_template else []) | tojson }};

  function defaultOptionsForType(type) {
    if (type === "boolean") {
      return [
        { value: "yes", label: "Yes", weight: 1 },
        { value: "no", label: "No", weight: 0 }
      ];
    }
    if (type === "multi_choice") {
      return [
        { value: "option_1", label: "Option 1", weight: 1 },
        { value: "option_2", label: "Option 2", weight: 0.5 },
        { value: "option_3", label: "Option 3", weight: 0 }
      ];
    }
    return [];
  }

  function normalizeQuestion(question, index) {
    const type = (question.question_type || question.type || "scale").toString().trim();
    const parsedType = ["scale", "boolean", "multi_choice"].includes(type) ? type : "scale";
    const label = (question.label || `Question ${index + 1}`).toString().trim();
    const weight = Number(question.weight || 1) > 0 ? Number(question.weight) : 1;
    const scaleMin = Number(question.scale_min ?? 1);
    const scaleMax = Number(question.scale_max ?? 5);
    const scaleStep = Number(question.scale_step ?? 1);
    let options = Array.isArray(question.options) ? question.options : [];
    if (!options.length && parsedType !== "scale") {
      options = defaultOptionsForType(parsedType);
    }
    options = options.map((option, optionIndex) => {
      const labelValue = (option.label || `Option ${optionIndex + 1}`).toString().trim();
      const valueValue = ((option.value || labelValue.toLowerCase().replace(/[^a-z0-9]+/g, "_")) + "").trim() || `option_${optionIndex + 1}`;
      const weightValue = Number(option.weight ?? 1);
      return {
        value: valueValue,
        label: labelValue,
        weight: Number.isFinite(weightValue) ? weightValue : 1
      };
    });
    return {
      label,
      question_type: parsedType,
      weight,
      help_text: (question.help_text || "").toString(),
      scale_min: Number.isFinite(scaleMin) ? scaleMin : 1,
      scale_max: Number.isFinite(scaleMax) && scaleMax > scaleMin ? scaleMax : Math.max(scaleMin + 1, 5),
      scale_step: Number.isFinite(scaleStep) && scaleStep > 0 ? scaleStep : 1,
      options
    };
  }

  let questions = (initialQuestions || []).map(normalizeQuestion);
  if (!questions.length) {
    questions = [normalizeQuestion({ label: "Business Fit", question_type: "scale" }, 0)];
  }

  function optionSummary(question) {
    if (question.question_type === "scale") {
      return `${question.scale_min} to ${question.scale_max} (step ${question.scale_step})`;
    }
    return (question.options || []).map((option) => `${option.label} (${option.weight})`).join("  |  ");
  }

  function renderCanvas() {
    canvas.innerHTML = "";
    questions.forEach((question, index) => {
      const card = document.createElement("article");
      card.className = `designer-question-card${index === selectedIndex ? " selected" : ""}`;
      card.dataset.index = String(index);
      card.innerHTML = `
        <header>
          <strong>Q${index + 1}. ${question.label}</strong>
          <span class="designer-chip">${question.question_type}</span>
          <span class="designer-chip">weight ${question.weight}</span>
        </header>
        <p class="muted">${question.help_text || "No help text"}</p>
        <p class="designer-option-preview">${optionSummary(question)}</p>
      `;
      card.addEventListener("click", function () {
        if (previewMode) return;
        selectedIndex = index;
        renderCanvas();
        updatePropertyPanel();
      });
      canvas.appendChild(card);
    });
    countLabel.textContent = `${questions.length} question${questions.length === 1 ? "" : "s"}`;
  }

  function updatePropertyPanel() {
    if (selectedIndex < 0 || selectedIndex >= questions.length) {
      emptyState.classList.remove("hidden");
      propsPanel.classList.add("hidden");
      return;
    }
    const question = questions[selectedIndex];
    emptyState.classList.add("hidden");
    propsPanel.classList.remove("hidden");
    document.getElementById("prop-label").value = question.label;
    document.getElementById("prop-type").value = question.question_type;
    document.getElementById("prop-weight").value = question.weight;
    document.getElementById("prop-help").value = question.help_text;
    document.getElementById("prop-scale-min").value = question.scale_min;
    document.getElementById("prop-scale-max").value = question.scale_max;
    document.getElementById("prop-scale-step").value = question.scale_step;
    document.getElementById("prop-options").value = (question.options || []).map((option) => option.label).join(", ");
    document.getElementById("prop-option-weights").value = (question.options || []).map((option) => option.weight).join(", ");
    const isScale = question.question_type === "scale";
    propScaleFields.classList.toggle("hidden", !isScale);
    propOptionFields.classList.toggle("hidden", isScale);
  }

  function slugify(value) {
    return (value || "").toLowerCase().trim().replace(/[^a-z0-9]+/g, "_").replace(/^_+|_+$/g, "") || "option";
  }

  function applyPropertyChanges() {
    if (selectedIndex < 0 || selectedIndex >= questions.length) return;
    const question = questions[selectedIndex];
    question.label = document.getElementById("prop-label").value.trim() || `Question ${selectedIndex + 1}`;
    question.question_type = document.getElementById("prop-type").value;
    const newWeight = Number(document.getElementById("prop-weight").value);
    question.weight = Number.isFinite(newWeight) && newWeight > 0 ? newWeight : 1;
    question.help_text = document.getElementById("prop-help").value.trim();
    question.scale_min = Number(document.getElementById("prop-scale-min").value || 1);
    question.scale_max = Number(document.getElementById("prop-scale-max").value || 5);
    question.scale_step = Number(document.getElementById("prop-scale-step").value || 1);
    if (!(question.scale_max > question.scale_min)) {
      question.scale_max = question.scale_min + 1;
    }
    if (!(question.scale_step > 0)) {
      question.scale_step = 1;
    }
    if (question.question_type !== "scale") {
      const labels = document.getElementById("prop-options").value.split(",").map((value) => value.trim()).filter(Boolean);
      const weights = document.getElementById("prop-option-weights").value.split(",").map((value) => value.trim()).filter(Boolean);
      question.options = labels.map((label, idx) => {
        const parsed = Number(weights[idx] || (question.question_type === "boolean" ? (idx === 0 ? 1 : 0) : 1));
        return {
          value: slugify(label) || `option_${idx + 1}`,
          label,
          weight: Number.isFinite(parsed) ? parsed : 1
        };
      });
      if (!question.options.length) {
        question.options = defaultOptionsForType(question.question_type);
      }
    } else {
      question.options = [];
    }
    renderCanvas();
    updatePropertyPanel();
  }

  function addQuestion(type) {
    questions.push(normalizeQuestion({ label: "New Question", question_type: type }, questions.length));
    selectedIndex = questions.length - 1;
    renderCanvas();
    updatePropertyPanel();
  }

  function moveSelected(delta) {
    if (selectedIndex < 0) return;
    const target = selectedIndex + delta;
    if (target < 0 || target >= questions.length) return;
    const temp = questions[selectedIndex];
    questions[selectedIndex] = questions[target];
    questions[target] = temp;
    selectedIndex = target;
    renderCanvas();
    updatePropertyPanel();
  }

  function duplicateSelected() {
    if (selectedIndex < 0 || selectedIndex >= questions.length) return;
    const clone = JSON.parse(JSON.stringify(questions[selectedIndex]));
    questions.splice(selectedIndex + 1, 0, clone);
    selectedIndex += 1;
    renderCanvas();
    updatePropertyPanel();
  }

  function deleteSelected() {
    if (selectedIndex < 0 || selectedIndex >= questions.length) return;
    questions.splice(selectedIndex, 1);
    if (!questions.length) {
      questions.push(normalizeQuestion({ label: "Business Fit", question_type: "scale" }, 0));
    }
    selectedIndex = Math.min(selectedIndex, questions.length - 1);
    renderCanvas();
    updatePropertyPanel();
  }

  function createHidden(name, value) {
    const input = document.createElement("input");
    input.type = "hidden";
    input.name = name;
    input.value = value;
    return input;
  }

  function syncHiddenInputs() {
    hiddenInputs.innerHTML = "";
    questions.forEach((question) => {
      hiddenInputs.appendChild(createHidden("question_label[]", question.label));
      hiddenInputs.appendChild(createHidden("question_type[]", question.question_type));
      hiddenInputs.appendChild(createHidden("question_weight[]", String(question.weight)));
      hiddenInputs.appendChild(createHidden("scale_min[]", String(question.scale_min)));
      hiddenInputs.appendChild(createHidden("scale_max[]", String(question.scale_max)));
      hiddenInputs.appendChild(createHidden("scale_step[]", String(question.scale_step)));
      hiddenInputs.appendChild(createHidden("option_labels[]", (question.options || []).map((option) => option.label).join(", ")));
      hiddenInputs.appendChild(createHidden("option_weights[]", (question.options || []).map((option) => option.weight).join(", ")));
      hiddenInputs.appendChild(createHidden("question_help_text[]", question.help_text || ""));
    });
  }

  document.querySelectorAll(".designer-block-btn").forEach((button) => {
    button.addEventListener("click", function () {
      addQuestion(button.dataset.newType || "scale");
    });
  });
  document.getElementById("prop-apply-btn").addEventListener("click", applyPropertyChanges);
  document.getElementById("prop-move-up").addEventListener("click", function () { moveSelected(-1); });
  document.getElementById("prop-move-down").addEventListener("click", function () { moveSelected(1); });
  document.getElementById("prop-duplicate").addEventListener("click", duplicateSelected);
  document.getElementById("prop-delete").addEventListener("click", deleteSelected);
  previewToggle.addEventListener("click", function () {
    previewMode = !previewMode;
    previewToggle.textContent = previewMode ? "Back To Edit" : "Preview";
    canvas.classList.toggle("preview", previewMode);
    propsPanel.classList.toggle("hidden", previewMode || selectedIndex < 0);
    emptyState.classList.toggle("hidden", previewMode);
  });

  form.addEventListener("submit", function (event) {
    if (!questions.length) {
      event.preventDefault();
      return;
    }
    syncHiddenInputs();
  });

  selectedIndex = questions.length ? 0 : -1;
  renderCanvas();
  updatePropertyPanel();
})();
</script>
{% endif %}
{% endblock %}
