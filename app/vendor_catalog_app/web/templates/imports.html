
{% extends "base.html" %}

{% block head %}
  <link rel="stylesheet" href="/static/css/imports_wizard.css">
{% endblock %}

{% block content %}
{% set has_preview = has_preview_rows %}
{% set has_results = has_import_results %}
{% set bundle_active = bundle_mode|default(false) %}
{% set summary = namespace(error_count=0, review_count=0, blocked_count=0, ready_count=0, suggested_merge=0, suggested_new=0) %}
{% for row in preview_rows %}
  {% if row.row_status == "error" %}
    {% set summary.error_count = summary.error_count + 1 %}
  {% elif row.row_status == "blocked" %}
    {% set summary.blocked_count = summary.blocked_count + 1 %}
  {% elif row.row_status == "review" %}
    {% set summary.review_count = summary.review_count + 1 %}
  {% else %}
    {% set summary.ready_count = summary.ready_count + 1 %}
  {% endif %}
  {% if row.suggested_action == "merge" %}
    {% set summary.suggested_merge = summary.suggested_merge + 1 %}
  {% else %}
    {% set summary.suggested_new = summary.suggested_new + 1 %}
  {% endif %}
{% endfor %}

<div class="section-header">
  <div>
    <h1>Data Imports</h1>
    <p>Upload source files, configure parsing only when needed, map fields, validate, then stage and ingest.</p>
  </div>
</div>

<section
  class="card section-divider imports-wizard-shell"
  id="imports-wizard"
  data-imports-wizard
  data-has-preview="{{ 'true' if has_preview else 'false' }}"
  data-has-results="{{ 'true' if has_results else 'false' }}"
  data-bundle-mode="{{ 'true' if bundle_active else 'false' }}"
  data-initial-step="{{ wizard_initial_step }}"
>
  <header class="imports-stepper sticky">
    <ol class="imports-stepper-list">
      <li><button type="button" class="imports-step" data-step-jump="1">1. Upload</button></li>
      <li><button type="button" class="imports-step" data-step-jump="2">2. Identify &amp; Configure</button></li>
      <li><button type="button" class="imports-step" data-step-jump="3">3. Map Fields</button></li>
      <li><button type="button" class="imports-step" data-step-jump="4">4. Validate</button></li>
      <li><button type="button" class="imports-step" data-step-jump="5">5. Stage / Ingest</button></li>
    </ol>
    <div class="imports-stepper-nav">
      <button type="button" class="button-link subtle" id="imports-step-back">Back</button>
      <button type="button" id="imports-step-next">Next</button>
    </div>
  </header>

  <section class="imports-step-panel" data-step-panel="1">
    <div class="section-header compact">
      <div>
        <h2>Upload</h2>
        <p>Choose one or more files. ZIP bundles are supported.</p>
      </div>
    </div>

    <form method="post" action="/imports/preview" enctype="multipart/form-data" id="import-start-form">
      <input type="hidden" name="flow_mode" id="flow-mode-input" value="{{ selected_flow_mode }}">
      <div class="grid grid-4">
        <label>
          Files
          <input type="file" name="files" id="ingestion-files-input" multiple accept=".csv,.tsv,.txt,.json,.xml,.zip,application/zip,application/json,application/xml,text/csv,text/plain">
        </label>

        <label>
          Layout
          <select name="layout" id="layout-select" required>
            {% for option in layout_options %}
            <option value="{{ option.key }}" {% if option.key == selected_layout %}selected{% endif %}>{{ option.label }}</option>
            {% endfor %}
          </select>
        </label>

        <label>
          Source System
          <select name="source_system">
            {% for option in source_system_options %}
            <option value="{{ option.key }}" {% if option.key == selected_source_system %}selected{% endif %}>{{ option.label }}</option>
            {% endfor %}
          </select>
        </label>

        <label>
          Source Object
          <input type="text" name="source_object" value="{{ source_object }}" placeholder="table/feed/file group">
        </label>
      </div>

      <div class="imports-mode-bar">
        <div class="button-group">
          <button type="button" class="button-link subtle" id="mode-quick-button">Strict Layout</button>
          <button type="button" class="button-link subtle" id="mode-wizard-button">Flexible Wizard</button>
        </div>
        <span class="muted" id="mode-label"></span>
      </div>

      <div id="ingestion-route-hint" class="flash info" style="display:none;"></div>

      <div class="imports-inline-actions">
        <button type="button" id="go-to-identify">Continue To Identify</button>
      </div>

      <section class="imports-step-panel nested" data-step-panel="2">
        <div class="section-header compact">
          <div>
            <h2>Identify &amp; Configure</h2>
            <p>Parser settings stay hidden unless the format needs them.</p>
          </div>
        </div>

        <div class="grid grid-4">
          <label>
            Parser Mode
            <select name="format_hint" id="format-hint-select">
              {% for option in file_format_options %}
              <option value="{{ option.key }}" {% if option.key == parser_options.format_hint %}selected{% endif %}>{{ option.label }}</option>
              {% endfor %}
            </select>
          </label>

          <label>
            Saved Mapping
            <select name="mapping_profile_id" id="mapping-profile-select">
              <option value="">No saved mapping</option>
              {% for profile in mapping_profiles %}
              <option value="{{ profile.profile_id }}" {% if selected_mapping_profile_id == profile.profile_id %}selected{% endif %}>
                {{ profile.profile_name }}{% if profile.file_format %} ({{ profile.file_format|upper }}){% endif %}
              </option>
              {% endfor %}
            </select>
          </label>

          <div class="imports-advanced-toggle-cell">
            <button type="button" class="button-link subtle" id="toggle-advanced-options">Show Advanced Parse Options</button>
          </div>
        </div>

        <div class="imports-advanced" id="advanced-options-panel" hidden>
          <div class="grid grid-3">
            <label data-format-option="delimiter">
              Delimiter
              <input type="text" name="delimiter" value="{{ parser_options.delimiter }}" placeholder=", | ; or \t">
            </label>

            <label data-format-option="json">
              JSON Record Path
              <input type="text" name="json_record_path" value="{{ parser_options.json_record_path }}" placeholder="records.items">
            </label>

            <label data-format-option="xml">
              XML Record Tag
              <input type="text" name="xml_record_tag" value="{{ parser_options.xml_record_tag }}" placeholder="vendor">
            </label>
          </div>
        </div>

        <div class="imports-parser-meta">
          <p class="muted">{{ selected_layout_spec.description }}</p>
          <p class="muted">Columns: {{ selected_layout_spec.fields|join(", ") }}</p>
          {% if source_file_name %}
          <p class="muted">
            File: <strong>{{ source_file_name }}</strong>
            {% if detected_file_type %}| detected={{ detected_file_type }}{% endif %}
            {% if effective_file_type %}| parser={{ effective_file_type }}{% endif %}
          </p>
          {% endif %}
          {% for warning in parser_warnings %}
          <div class="flash info">{{ warning }}</div>
          {% endfor %}
          {% if staging_warning %}
          <div class="flash info">{{ staging_warning }}</div>
          {% endif %}
          {% if staging_job_id %}
          <p class="muted">Staging job: <strong>{{ staging_job_id }}</strong> | staged rows: <strong>{{ staged_row_count }}</strong></p>
          {% endif %}
        </div>

        <div class="button-group imports-inline-actions">
          <button type="submit" id="detect-submit-button">Detect, Stage, And Continue</button>
          <a class="button-link subtle" href="/imports">Reset Wizard</a>
        </div>
      </section>

      <section class="imports-templates">
        <h3>Sample Templates</h3>
        <div class="button-group">
          {% for option in layout_options %}
          <a class="button-link subtle" href="/imports/templates/{{ option.key }}.csv">{{ option.label }} Template</a>
          {% endfor %}
        </div>
      </section>
    </form>
  </section>

  <section class="imports-step-panel" data-step-panel="3">
    <div class="section-header compact">
      <div>
        <h2>Preview And Mapping</h2>
        {% if preview_hidden_count %}
        <p>Showing {{ preview_rows|length }} of {{ preview_total_rows }} parsed row(s) for {{ selected_layout_spec.label }}.</p>
        {% elif has_preview %}
        <p>{{ preview_total_rows or (preview_rows|length) }} row(s) parsed for {{ selected_layout_spec.label }}.</p>
        {% else %}
        <p>Run steps 1 and 2 to generate a preview.</p>
        {% endif %}
      </div>
    </div>

    {% if has_preview %}
    <div class="imports-mapping-metrics" data-mapping-progress data-required-targets='{{ mapping_required_target_keys|tojson }}'>
      <span class="status-badge status-ready">Mapped: <strong id="mapped-count">{{ mapping_mapped_source_fields }}</strong> / {{ mapping_total_source_fields }}</span>
      <span class="status-badge status-review">Unmapped: <strong id="unmapped-count">{{ mapping_unmapped_source_fields }}</strong></span>
      <span class="status-badge {{ 'status-error' if mapping_required_remaining_count else 'status-ready' }}">
        Required fields remaining: <strong id="required-remaining-count">{{ mapping_required_remaining_count }}</strong>
      </span>
    </div>
    {% endif %}

    {% if bundle_active %}
    <div class="flash info">Bundle remap is disabled in this view. Upload a single file if you need interactive remapping.</div>
    {% endif %}

    {% if mapping_profile_saved %}
    <div class="flash success">Saved mapping profile: <strong>{{ mapping_profile_saved }}</strong></div>
    {% endif %}

    {% if has_preview and not bundle_active %}
    <form method="post" action="/imports/remap" id="mapping-form">
      <input type="hidden" name="preview_token" value="{{ preview_token }}">
      <div class="grid grid-3 mapping-toolbar">
        <label>
          Mapping Profile
          <select name="mapping_profile_id">
            <option value="">Use current mapping</option>
            {% for profile in mapping_profiles %}
            <option value="{{ profile.profile_id }}" {% if selected_mapping_profile_id == profile.profile_id %}selected{% endif %}>
              {{ profile.profile_name }}{% if profile.file_format %} ({{ profile.file_format|upper }}){% endif %}{% if profile.compatible is defined and not profile.compatible %} - signature differs{% endif %}
            </option>
            {% endfor %}
          </select>
        </label>
        <label>
          Save Mapping As
          <input type="text" name="mapping_profile_name" placeholder="optional profile name">
        </label>
        <label>
          Search Target Fields
          <input type="search" id="mapping-target-search" placeholder="filter target options across rows">
        </label>
      </div>

      <div class="table-wrap table-scroll mapping-table-wrap">
        <table>
          <thead>
            <tr>
              <th>Source Tag / Column (Static)</th>
              <th>Sample Values</th>
              <th>Map To Destination Field</th>
            </tr>
          </thead>
          <tbody>
            {% for source in source_field_map %}
            <tr data-source-key="{{ source.key }}" id="map-row-{{ loop.index }}">
              <td><strong>{{ source.key }}</strong></td>
              <td>
                {% if source.sample_values %}
                  {% for sample in source.sample_values %}
                  <div class="muted">{{ sample }}</div>
                  {% endfor %}
                {% else %}
                  <span class="muted">(no sample)</span>
                {% endif %}
              </td>
              <td>
                <input type="hidden" name="source_field_keys" value="{{ source.key }}">
                <select name="source_target_keys" class="mapping-target-select" data-source-key="{{ source.key }}">
                  <option value="">(unmapped)</option>
                  {% for group in target_field_groups %}
                  <optgroup label="{{ group.area_label }} -> {{ group.stage_table }}">
                    {% for option in group.options %}
                    <option
                      value="{{ option.key }}"
                      data-option-group="{{ group.area_label }}"
                      data-option-label="{{ option.label }}"
                      {% if selected_source_target_mapping.get(source.key, "") == option.key %}selected{% endif %}
                    >
                      {{ option.label }}
                    </option>
                    {% endfor %}
                  </optgroup>
                  {% endfor %}
                </select>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="button-group imports-inline-actions">
        <button type="submit">Rebuild Preview With Mapping</button>
      </div>
    </form>
    {% endif %}

    {% if has_preview and source_field_map %}
    <section class="bulk-defaults-card">
      <h3>Detected Source Fields</h3>
      <div class="table-wrap table-scroll">
        <table>
          <thead>
            <tr>
              <th>Tag / Column</th>
              <th>Sample Value</th>
              <th>Rows With Value</th>
            </tr>
          </thead>
          <tbody>
            {% for source in source_field_map %}
            <tr>
              <td>{{ source.key }}</td>
              <td>{{ source.sample_value }}</td>
              <td>{{ source.non_empty_count }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    {% endif %}
  </section>

  <section class="imports-step-panel" data-step-panel="4">
    <div class="section-header compact">
      <div>
        <h2>Validate</h2>
        <p>Filter status outcomes and fix mapping before staging and ingest.</p>
      </div>
    </div>

    {% if has_preview %}
    <div class="import-preview-summary">
      <span class="status-badge status-{{ 'error' if summary.error_count else 'ready' }}">Errors: {{ summary.error_count }}</span>
      <span class="status-badge status-review">Needs Review: {{ summary.review_count }}</span>
      <span class="status-badge status-blocked">Blocked: {{ summary.blocked_count }}</span>
      <span class="status-badge status-ready">Ready: {{ summary.ready_count }}</span>
      <span class="status-badge status-merged">Suggested Merge: {{ summary.suggested_merge }}</span>
      <span class="status-badge status-new">Suggested New: {{ summary.suggested_new }}</span>
    </div>

    {% if summary.error_count %}
    <div class="flash error">{{ summary.error_count }} row(s) have validation errors. Resolve these before apply.</div>
    {% endif %}

    <div class="button-group validation-filters">
      <button type="button" class="button-link subtle" data-status-filter="all">All</button>
      <button type="button" class="button-link subtle" data-status-filter="error">Errors</button>
      <button type="button" class="button-link subtle" data-status-filter="blocked">Blocked</button>
      <button type="button" class="button-link subtle" data-status-filter="review">Needs Review</button>
      <button type="button" class="button-link subtle" data-status-filter="ready">Ready</button>
      <button type="button" id="validate-go-to-mapping">Go Back To Mapping</button>
    </div>

    <div class="table-wrap preview-table-wrap validation-table-wrap">
      <table>
        <thead>
          <tr>
            <th>Line</th>
            <th>Status</th>
            <th>Match / Notes</th>
            <th>Suggested Action</th>
          </tr>
        </thead>
        <tbody id="validation-rows">
          {% for row in preview_rows %}
          <tr data-validation-row data-status="{{ row.row_status }}" data-row-index="{{ row.row_index }}">
            <td>{{ row.line_number or row.row_index }}</td>
            <td>
              {% if row.row_status == "error" %}
              <span class="status-badge status-error">error</span>
              {% elif row.row_status == "blocked" %}
              <span class="status-badge status-blocked">blocked</span>
              {% elif row.row_status == "review" %}
              <span class="status-badge status-review">review</span>
              {% else %}
              <span class="status-badge status-ready">ready</span>
              {% endif %}
            </td>
            <td>
              {% if row.suggested_target_label %}
              <div>{{ row.suggested_target_label }}</div>
              {% else %}
              <div>None</div>
              {% endif %}
              {% for note in row.notes %}
              <div><small class="status-badge status-review">{{ note }}</small></div>
              {% endfor %}
              {% for err in row.errors %}
              <div><small class="status-badge status-error">{{ err }}</small></div>
              {% endfor %}
            </td>
            <td>
              <span class="muted">{{ row.suggested_action }}</span>
              <button type="button" class="button-link subtle go-map">Fix Mapping</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="flash info">No preview available yet.</div>
    {% endif %}
  </section>

  <section class="imports-step-panel" data-step-panel="5">
    <div class="section-header compact">
      <div>
        <h2>Stage / Ingest</h2>
        <p>Set bulk defaults, review row actions, and run apply.</p>
      </div>
    </div>

    {% if bundle_active and bundle_files %}
    <section class="bulk-defaults-card">
      <h3>Bundle Files</h3>
      <p class="muted">Bundle summary: total={{ bundle_totals.total }}, ready={{ bundle_totals.ready }}, review={{ bundle_totals.review }}, blocked={{ bundle_totals.blocked }}, error={{ bundle_totals.error }}</p>
      <div class="table-wrap table-scroll">
        <table>
          <thead>
            <tr>
              <th>File</th>
              <th>Layout</th>
              <th>Rows</th>
              <th>Ready</th>
              <th>Review</th>
              <th>Blocked</th>
              <th>Error</th>
              <th>Stage Job</th>
            </tr>
          </thead>
          <tbody>
            {% for file in bundle_files %}
            <tr>
              <td>{{ file.file_name }}</td>
              <td>{{ file.layout_key }}</td>
              <td>{{ file.row_count }}</td>
              <td>{{ file.status_counts.ready }}</td>
              <td>{{ file.status_counts.review }}</td>
              <td>{{ file.status_counts.blocked }}</td>
              <td>{{ file.status_counts.error }}</td>
              <td>{{ file.import_job_id }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    {% endif %}

    {% if has_preview %}
    <form method="post" action="/imports/apply" id="apply-form">
      <input type="hidden" name="preview_token" value="{{ preview_token }}">

      <label>
        Merge Reason
        <select name="reason">
          <option value="">Select reason (required for merge actions)</option>
          {% for option in import_merge_reason_options %}
          <option value="{{ option }}" {% if import_reason == option %}selected{% endif %}>{{ option|replace('_', ' ')|title }}</option>
          {% endfor %}
        </select>
      </label>

      <section class="bulk-defaults-card">
        <h3>Bulk Action Defaults</h3>
        <div class="bulk-defaults-row">
          <label>
            Set Action For Rows Without Errors
            <select id="bulk-action-default" name="bulk_default_action">
              <option value="">Keep Suggested Actions</option>
              <option value="new">Set to new</option>
              <option value="merge">Set to merge</option>
              <option value="skip">Set to skip</option>
            </select>
          </label>
          <div class="button-group">
            <button type="button" id="bulk-action-all-new">All New</button>
            <button type="button" id="bulk-action-all-merge">All Merge</button>
            <button type="button" id="bulk-action-all-skip">All Skip</button>
          </div>
        </div>
      </section>

      <div class="table-wrap preview-table-wrap">
        <table>
          <thead>
            <tr>
              <th>Line</th>
              <th>Row Status</th>
              {% for field in selected_layout_spec.fields %}
              <th>{{ field }}</th>
              {% endfor %}
              <th>Match</th>
              <th>Action</th>
              <th>Merge Target</th>
            </tr>
          </thead>
          <tbody>
            {% for row in preview_rows %}
            <tr data-row-status="{{ row.row_status }}" class="import-row-status-{{ row.row_status }}" data-row-index="{{ row.row_index }}">
              <td>{{ row.line_number or row.row_index }}</td>
              <td>
                {% if row.row_status == "error" %}
                <span class="status-badge status-error">error</span>
                {% elif row.row_status == "blocked" %}
                <span class="status-badge status-blocked">blocked</span>
                {% elif row.row_status == "review" %}
                <span class="status-badge status-review">review</span>
                {% else %}
                <span class="status-badge status-ready">ready</span>
                {% endif %}
              </td>
              {% for field in selected_layout_spec.fields %}
              <td>{{ row.row_data.get(field, "") }}</td>
              {% endfor %}
              <td>
                {% if row.suggested_target_label %}
                <div>{{ row.suggested_target_label }}</div>
                {% else %}
                <div>None</div>
                {% endif %}
                {% for note in row.notes %}
                <div><small class="status-badge status-review">{{ note }}</small></div>
                {% endfor %}
                {% for err in row.errors %}
                <div><small class="status-badge status-error">{{ err }}</small></div>
                {% endfor %}
              </td>
              <td>
                <select name="action_{{ row.row_index }}" data-import-action-select>
                  <option value="new" {% if row.suggested_action == "new" %}selected{% endif %}>new</option>
                  <option value="merge" {% if row.suggested_action == "merge" %}selected{% endif %}>merge</option>
                  <option value="skip">skip</option>
                </select>
              </td>
              <td>
                <div class="import-merge-target">
                  <input type="hidden" name="target_{{ row.row_index }}" value="{{ row.suggested_target_id }}" data-merge-target-hidden>
                  <input
                    type="text"
                    value="{{ row.suggested_target_label or '' }}"
                    list="merge-target-options-{{ row.row_index }}"
                    placeholder="Search and select merge target"
                    data-merge-target-label-input
                  >
                  <datalist id="merge-target-options-{{ row.row_index }}">
                    {% for option in row.merge_options or [] %}
                    <option value="{{ option.label }}" data-target-id="{{ option.id }}"></option>
                    {% endfor %}
                  </datalist>
                  {% if not (row.merge_options or []) %}
                  <small class="muted">No suggestions yet; adjust row data or keep as new.</small>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="button-group imports-inline-actions">
        {% if bundle_active %}
        <button type="submit" name="apply_mode" value="stage_only">Stage Only</button>
        <button type="submit" name="apply_mode" value="apply_eligible">Apply Eligible Now</button>
        <button type="submit" name="apply_mode" value="reprocess">Reprocess Blocked</button>
        {% else %}
        <button type="submit">Apply Import</button>
        {% endif %}
        <a class="button-link subtle" href="/imports">Discard Preview</a>
      </div>
    </form>
    {% else %}
    <div class="flash info">No staged preview yet. Complete steps 1-4 first.</div>
    {% endif %}
  </section>
</section>

{% if import_results %}
<section class="card section-divider">
  <h2>Import Results</h2>
  {% if staging_job_id %}
  <p class="muted">Staging job: <strong>{{ staging_job_id }}</strong> finalized.</p>
  {% endif %}
  <table>
    <thead>
      <tr>
        <th>Row</th>
        <th>Status</th>
        <th>Message</th>
      </tr>
    </thead>
    <tbody>
      {% for result in import_results %}
      <tr>
        <td>{{ result.row_index }}</td>
        <td>{{ result.status }}</td>
        <td>{{ result.message }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
(() => {
  const wizardRoot = document.querySelector("[data-imports-wizard]");
  if (!wizardRoot) {
    return;
  }

  const hasPreview = wizardRoot.dataset.hasPreview === "true";
  const hasResults = wizardRoot.dataset.hasResults === "true";
  const maxStep = (hasPreview || hasResults) ? 5 : 2;
  const minStep = 1;
  const stepButtons = Array.from(wizardRoot.querySelectorAll("[data-step-jump]"));
  const stepPanels = Array.from(wizardRoot.querySelectorAll(".imports-step-panel[data-step-panel]"));
  const backButton = document.getElementById("imports-step-back");
  const nextButton = document.getElementById("imports-step-next");
  const filesInput = document.getElementById("ingestion-files-input");
  const layoutSelect = document.getElementById("layout-select");
  const goToIdentifyButton = document.getElementById("go-to-identify");
  const validateGoToMappingButton = document.getElementById("validate-go-to-mapping");

  let currentStep = Number.parseInt(String(wizardRoot.dataset.initialStep || "1"), 10);
  if (!Number.isFinite(currentStep)) {
    currentStep = 1;
  }
  if (currentStep > maxStep) {
    currentStep = maxStep;
  }
  if (currentStep < minStep) {
    currentStep = minStep;
  }

  const selectedUploadCount = () => {
    if (!filesInput || !filesInput.files) {
      return 0;
    }
    return filesInput.files.length;
  };

  const stepCanAdvance = (stepNumber) => {
    if (stepNumber === 1) {
      const hasLayout = !!(layoutSelect && String(layoutSelect.value || "").trim());
      return selectedUploadCount() > 0 && hasLayout;
    }
    if (stepNumber === 2) {
      return hasPreview;
    }
    if (stepNumber >= 3 && stepNumber < 5) {
      return hasPreview;
    }
    return true;
  };

  const showStep = (stepNumber) => {
    currentStep = Math.min(maxStep, Math.max(minStep, stepNumber));
    wizardRoot.setAttribute("data-current-step", String(currentStep));
    stepPanels.forEach((panel) => {
      const panelStep = Number.parseInt(String(panel.getAttribute("data-step-panel") || "0"), 10);
      if (panelStep === 1) {
        panel.hidden = !(currentStep === 1 || currentStep === 2);
      } else if (panelStep === 2) {
        panel.hidden = currentStep !== 2;
      } else {
        panel.hidden = panelStep !== currentStep;
      }
      panel.classList.toggle("is-active", panelStep === currentStep);
    });

    stepButtons.forEach((button) => {
      const step = Number.parseInt(String(button.getAttribute("data-step-jump") || "0"), 10);
      const disabled = step > maxStep;
      button.disabled = disabled;
      button.classList.toggle("is-complete", step < currentStep && !disabled);
      button.classList.toggle("is-active", step === currentStep);
    });

    if (backButton) {
      backButton.disabled = currentStep <= minStep;
    }
    if (nextButton) {
      const canGoForward = currentStep < maxStep && stepCanAdvance(currentStep);
      nextButton.disabled = !canGoForward;
      nextButton.textContent = currentStep >= maxStep ? "Complete" : "Next";
    }
  };

  if (backButton) {
    backButton.addEventListener("click", () => {
      if (currentStep > minStep) {
        showStep(currentStep - 1);
      }
    });
  }

  if (nextButton) {
    nextButton.addEventListener("click", () => {
      if (currentStep < maxStep && stepCanAdvance(currentStep)) {
        showStep(currentStep + 1);
      }
    });
  }

  stepButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const target = Number.parseInt(String(button.getAttribute("data-step-jump") || "0"), 10);
      if (!Number.isFinite(target) || target < minStep || target > maxStep) {
        return;
      }
      showStep(target);
    });
  });

  if (goToIdentifyButton) {
    goToIdentifyButton.addEventListener("click", () => {
      if (!stepCanAdvance(1)) {
        showStep(1);
        return;
      }
      showStep(2);
    });
  }

  if (filesInput) {
    filesInput.addEventListener("change", () => showStep(currentStep));
  }
  if (layoutSelect) {
    layoutSelect.addEventListener("change", () => showStep(currentStep));
  }

  const modeQuickButton = document.getElementById("mode-quick-button");
  const modeWizardButton = document.getElementById("mode-wizard-button");
  const modeLabel = document.getElementById("mode-label");
  const flowModeInput = document.getElementById("flow-mode-input");
  const routeHint = document.getElementById("ingestion-route-hint");
  const formatSelect = document.getElementById("format-hint-select");
  const advancedToggleButton = document.getElementById("toggle-advanced-options");
  const advancedOptionsPanel = document.getElementById("advanced-options-panel");
  const delimiterBlock = document.querySelector("[data-format-option='delimiter']");
  const jsonBlock = document.querySelector("[data-format-option='json']");
  const xmlBlock = document.querySelector("[data-format-option='xml']");

  const setModeLabel = (mode) => {
    if (!modeLabel) {
      return;
    }
    modeLabel.textContent = mode === "quick"
      ? "Strict mode: approved CSV/TSV template layout must match exactly."
      : "Wizard mode: flexible parser with optional mapping profiles.";
  };

  const setRouteHint = (message) => {
    if (!routeHint) {
      return;
    }
    const text = String(message || "").trim();
    routeHint.style.display = text ? "" : "none";
    routeHint.textContent = text;
  };

  const setMode = (mode) => {
    const selected = String(mode || "quick").toLowerCase() === "wizard" ? "wizard" : "quick";
    if (flowModeInput) {
      flowModeInput.value = selected;
    }
    setModeLabel(selected);
    if (modeQuickButton) {
      modeQuickButton.classList.toggle("active", selected === "quick");
    }
    if (modeWizardButton) {
      modeWizardButton.classList.toggle("active", selected === "wizard");
    }
  };

  const extensionFromFileName = (name) => {
    const raw = String(name || "").trim().toLowerCase();
    const idx = raw.lastIndexOf(".");
    if (idx <= -1 || idx === raw.length - 1) {
      return "";
    }
    return raw.slice(idx + 1);
  };

  const detectModeForSelection = () => {
    if (!filesInput || !filesInput.files || !filesInput.files.length) {
      return;
    }
    const ext = extensionFromFileName(filesInput.files[0].name || "");
    if (["csv", "tsv"].includes(ext)) {
      setMode("quick");
      setRouteHint(`Detected .${ext}. Strict mode is available.`);
      return;
    }
    setMode("wizard");
    if (formatSelect && ["json", "xml", "csv", "tsv", "delimited"].includes(ext)) {
      formatSelect.value = ext;
    }
    setRouteHint(ext ? `Detected .${ext}. Wizard mode enabled for guided parsing.` : "Wizard mode enabled.");
  };

  const toggleParserBlocks = () => {
    if (!formatSelect) {
      return;
    }
    const value = String(formatSelect.value || "auto").toLowerCase();
    const showDelimiter = value === "auto" || value === "csv" || value === "tsv" || value === "delimited";
    const showJson = value === "auto" || value === "json";
    const showXml = value === "auto" || value === "xml";

    if (delimiterBlock) delimiterBlock.style.display = showDelimiter ? "" : "none";
    if (jsonBlock) jsonBlock.style.display = showJson ? "" : "none";
    if (xmlBlock) xmlBlock.style.display = showXml ? "" : "none";

    if (advancedOptionsPanel) {
      const shouldOpen = ["json", "xml", "delimited", "tsv"].includes(value);
      if (shouldOpen) {
        advancedOptionsPanel.hidden = false;
        if (advancedToggleButton) {
          advancedToggleButton.textContent = "Hide Advanced Parse Options";
        }
      }
    }
  };

  if (modeQuickButton) {
    modeQuickButton.addEventListener("click", () => {
      setMode("quick");
      if (formatSelect) {
        formatSelect.value = "auto";
      }
      toggleParserBlocks();
      setRouteHint("Strict layout mode selected.");
    });
  }

  if (modeWizardButton) {
    modeWizardButton.addEventListener("click", () => {
      setMode("wizard");
      toggleParserBlocks();
      setRouteHint("Wizard mode selected.");
    });
  }

  if (advancedToggleButton && advancedOptionsPanel) {
    advancedToggleButton.addEventListener("click", () => {
      const nextHidden = !advancedOptionsPanel.hidden;
      advancedOptionsPanel.hidden = nextHidden;
      advancedToggleButton.textContent = nextHidden ? "Show Advanced Parse Options" : "Hide Advanced Parse Options";
    });
  }

  if (filesInput) {
    filesInput.addEventListener("change", () => {
      detectModeForSelection();
      toggleParserBlocks();
    });
  }
  if (formatSelect) {
    formatSelect.addEventListener("change", toggleParserBlocks);
  }

  const initialMode = String((flowModeInput && flowModeInput.value) || "quick").toLowerCase() === "wizard" ? "wizard" : "quick";
  setMode(initialMode);
  toggleParserBlocks();

  const mappingSelects = Array.from(document.querySelectorAll(".mapping-target-select"));
  const mappingSearchInput = document.getElementById("mapping-target-search");
  const requiredTargetsRaw = wizardRoot.querySelector("[data-mapping-progress]");
  let requiredTargets = [];
  if (requiredTargetsRaw) {
    try {
      requiredTargets = JSON.parse(String(requiredTargetsRaw.getAttribute("data-required-targets") || "[]"));
    } catch (_err) {
      requiredTargets = [];
    }
  }

  const refreshMappingMetrics = () => {
    if (!mappingSelects.length) {
      return;
    }
    const selectedValues = mappingSelects
      .map((select) => String(select.value || "").trim())
      .filter((value) => !!value);
    const mappedCount = selectedValues.length;
    const unmappedCount = Math.max(0, mappingSelects.length - mappedCount);
    const selectedSet = new Set(selectedValues);
    const requiredRemaining = requiredTargets.reduce((count, key) => {
      const target = String(key || "").trim();
      if (!target) {
        return count;
      }
      return selectedSet.has(target) ? count : count + 1;
    }, 0);

    const mappedEl = document.getElementById("mapped-count");
    const unmappedEl = document.getElementById("unmapped-count");
    const requiredEl = document.getElementById("required-remaining-count");
    if (mappedEl) mappedEl.textContent = String(mappedCount);
    if (unmappedEl) unmappedEl.textContent = String(unmappedCount);
    if (requiredEl) requiredEl.textContent = String(requiredRemaining);
  };

  const applyTargetOptionFilter = (query) => {
    const text = String(query || "").trim().toLowerCase();
    mappingSelects.forEach((select) => {
      const optgroups = Array.from(select.querySelectorAll("optgroup"));
      optgroups.forEach((group) => {
        let groupHasVisible = false;
        const options = Array.from(group.querySelectorAll("option"));
        options.forEach((option) => {
          const label = String(option.dataset.optionLabel || option.textContent || "").toLowerCase();
          const section = String(option.dataset.optionGroup || "").toLowerCase();
          const visible = !text || label.includes(text) || section.includes(text);
          option.hidden = !visible;
          if (visible) {
            groupHasVisible = true;
          }
        });
        group.hidden = !groupHasVisible;
      });
    });
  };

  mappingSelects.forEach((select) => {
    select.addEventListener("change", refreshMappingMetrics);
  });
  if (mappingSearchInput) {
    mappingSearchInput.addEventListener("input", () => {
      applyTargetOptionFilter(mappingSearchInput.value || "");
    });
  }
  refreshMappingMetrics();

  const validationRows = Array.from(document.querySelectorAll("[data-validation-row]"));
  const filterButtons = Array.from(document.querySelectorAll("[data-status-filter]"));
  const applyValidationFilter = (status) => {
    const selected = String(status || "all").toLowerCase();
    validationRows.forEach((row) => {
      const rowStatus = String(row.getAttribute("data-status") || "").toLowerCase();
      row.hidden = selected !== "all" && rowStatus !== selected;
    });
  };

  filterButtons.forEach((button) => {
    button.addEventListener("click", () => {
      applyValidationFilter(button.getAttribute("data-status-filter") || "all");
    });
  });

  if (validateGoToMappingButton) {
    validateGoToMappingButton.addEventListener("click", () => showStep(3));
  }
  Array.from(document.querySelectorAll(".go-map")).forEach((button) => {
    button.addEventListener("click", () => showStep(3));
  });

  const previewRows = Array.from(document.querySelectorAll("tr[data-row-index]"));
  const getRows = () => previewRows.map((row) => ({
    row,
    select: row.querySelector("[data-import-action-select]"),
  })).filter((item) => !!item.row && !!item.select);

  const syncMergeTargetForRow = (row) => {
    const labelInput = row.querySelector("[data-merge-target-label-input]");
    const hiddenInput = row.querySelector("[data-merge-target-hidden]");
    if (!labelInput || !hiddenInput) {
      return;
    }
    const listId = labelInput.getAttribute("list");
    const datalist = listId ? document.getElementById(listId) : null;
    const options = datalist ? Array.from(datalist.querySelectorAll("option")) : [];
    const entered = String(labelInput.value || "").trim();
    const matched = options.find((opt) => String(opt.value || "").trim() === entered);
    hiddenInput.value = matched ? String(matched.getAttribute("data-target-id") || "").trim() : "";
  };

  const hydrateMergeLabelFromHidden = (row) => {
    const labelInput = row.querySelector("[data-merge-target-label-input]");
    const hiddenInput = row.querySelector("[data-merge-target-hidden]");
    if (!labelInput || !hiddenInput) {
      return;
    }
    if (String(labelInput.value || "").trim()) {
      return;
    }
    const currentId = String(hiddenInput.value || "").trim();
    if (!currentId) {
      return;
    }
    const listId = labelInput.getAttribute("list");
    const datalist = listId ? document.getElementById(listId) : null;
    const options = datalist ? Array.from(datalist.querySelectorAll("option")) : [];
    const matched = options.find((opt) => String(opt.getAttribute("data-target-id") || "").trim() === currentId);
    if (matched) {
      labelInput.value = String(matched.value || "").trim();
    }
  };

  const refreshMergeTargetAvailability = (row) => {
    const actionSelect = row.querySelector("[data-import-action-select]");
    const labelInput = row.querySelector("[data-merge-target-label-input]");
    if (!actionSelect || !labelInput) {
      return;
    }
    const mergeEnabled = String(actionSelect.value || "").toLowerCase() === "merge";
    labelInput.disabled = !mergeEnabled;
    labelInput.setAttribute("aria-disabled", mergeEnabled ? "false" : "true");
  };

  const setAllActions = (value, onlyWithoutErrors) => {
    getRows().forEach((item) => {
      const rowStatus = item.row.getAttribute("data-row-status") || "";
      if (onlyWithoutErrors && rowStatus === "error") {
        return;
      }
      item.select.value = value;
      item.select.dispatchEvent(new Event("change", { bubbles: true }));
    });
  };

  const defaultsSelect = document.getElementById("bulk-action-default");
  if (defaultsSelect) {
    defaultsSelect.addEventListener("change", () => {
      const value = defaultsSelect.value;
      if (!value) {
        return;
      }
      setAllActions(value, true);
    });
  }

  const allNew = document.getElementById("bulk-action-all-new");
  if (allNew) {
    allNew.addEventListener("click", () => setAllActions("new", false));
  }
  const allMerge = document.getElementById("bulk-action-all-merge");
  if (allMerge) {
    allMerge.addEventListener("click", () => setAllActions("merge", false));
  }
  const allSkip = document.getElementById("bulk-action-all-skip");
  if (allSkip) {
    allSkip.addEventListener("click", () => setAllActions("skip", false));
  }

  previewRows.forEach((row) => {
    const actionSelect = row.querySelector("[data-import-action-select]");
    const labelInput = row.querySelector("[data-merge-target-label-input]");
    hydrateMergeLabelFromHidden(row);
    refreshMergeTargetAvailability(row);
    if (actionSelect) {
      actionSelect.addEventListener("change", () => refreshMergeTargetAvailability(row));
    }
    if (labelInput) {
      labelInput.addEventListener("input", () => syncMergeTargetForRow(row));
      labelInput.addEventListener("change", () => syncMergeTargetForRow(row));
      labelInput.addEventListener("blur", () => syncMergeTargetForRow(row));
    }
  });

  if (hasResults) {
    showStep(5);
  } else {
    showStep(currentStep);
  }
})();
</script>
{% endblock %}
