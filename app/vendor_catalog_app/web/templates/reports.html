{% extends "base.html" %}
{% block content %}
<div class="section-header">
  <div>
    <h1>Reports</h1>
    <p>Build custom extracts, preview on screen, download CSV, or queue email delivery requests.</p>
  </div>
</div>

<form method="get" action="/reports" class="card grid grid-3">
  <input type="hidden" name="run" value="1">
  <label>
    Report Type
    <select name="report_type">
      {% for key, info in report_types.items() %}
      <option value="{{ key }}" {% if key == filters.report_type %}selected{% endif %}>{{ info.label }}</option>
      {% endfor %}
    </select>
    <small class="muted">{{ selected_report.description }}</small>
  </label>
  <label>
    Search
    <input type="text" name="search" value="{{ filters.search }}" placeholder="Name, id, contract, owner, notes...">
  </label>
  <label>
    Vendor
    <select name="vendor">
      {% for option in vendor_options %}
      <option value="{{ option.vendor_id }}" {% if option.vendor_id == filters.vendor %}selected{% endif %}>{{ option.label }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Lifecycle
    <select name="lifecycle_state">
      {% for option in vendor_lifecycle_states %}
      <option value="{{ option }}" {% if option == filters.lifecycle_state %}selected{% endif %}>{{ option }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Project Status
    <select name="project_status">
      {% for option in project_statuses %}
      <option value="{{ option }}" {% if option == filters.project_status %}selected{% endif %}>{{ option }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Demo Outcome
    <select name="outcome">
      {% for option in demo_outcomes %}
      <option value="{{ option }}" {% if option == filters.outcome %}selected{% endif %}>{{ option }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Owner Principal
    <input type="text" name="owner_principal" value="{{ filters.owner_principal }}" placeholder="bob.smith@example.com">
  </label>
  <label>
    Org Scope
    <select name="org">
      {% for option in orgs %}
      <option value="{{ option }}" {% if option == filters.org %}selected{% endif %}>{{ "all" if option == "all" else option }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Renewal Horizon (days)
    <input type="number" name="horizon_days" value="{{ filters.horizon_days }}" min="30" max="730">
  </label>
  <label>
    Max Rows
    <select name="limit">
      {% for option in row_limits %}
      <option value="{{ option }}" {% if option == filters.limit %}selected{% endif %}>{{ option }}</option>
      {% endfor %}
    </select>
  </label>
  <div class="button-group">
    <button type="submit">Run Report</button>
    {% if download_url %}
    <a class="button-link subtle" href="{{ download_url }}">Download CSV</a>
    {% endif %}
  </div>
</form>

{% if columns %}
<section class="card section-divider">
  <details>
    <summary><strong>Column Matrix</strong> (select visible/downloaded columns)</summary>
    <form method="get" action="/reports" style="margin-top:10px;" data-columns-form>
      <input type="hidden" name="run" value="1">
      <input type="hidden" name="report_type" value="{{ filters.report_type }}">
      <input type="hidden" name="search" value="{{ filters.search }}">
      <input type="hidden" name="vendor" value="{{ filters.vendor }}">
      <input type="hidden" name="lifecycle_state" value="{{ filters.lifecycle_state }}">
      <input type="hidden" name="project_status" value="{{ filters.project_status }}">
      <input type="hidden" name="outcome" value="{{ filters.outcome }}">
      <input type="hidden" name="owner_principal" value="{{ filters.owner_principal }}">
      <input type="hidden" name="org" value="{{ filters.org }}">
      <input type="hidden" name="horizon_days" value="{{ filters.horizon_days }}">
      <input type="hidden" name="limit" value="{{ filters.limit }}">
      <input type="hidden" name="cols" value="{{ selected_columns|join(',') }}" data-cols-target>
      <div class="grid grid-5">
        {% for column in columns %}
        <label>
          <input type="checkbox" value="{{ column }}" data-column-toggle {% if column in selected_columns %}checked{% endif %}>
          {{ column }}
        </label>
        {% endfor %}
      </div>
      <div class="button-group" style="margin-top:8px;">
        <button type="submit">Apply Columns</button>
      </div>
    </form>
  </details>
</section>
{% endif %}

{% if filters.run == 1 %}
<section class="card section-divider">
  <div class="section-header">
    <div>
      <h2>Results</h2>
      <p>{{ row_count }} total rows. Showing {{ preview_count }} row preview.</p>
    </div>
  </div>
  <table>
    <thead>
      <tr>
        {% for column in selected_columns %}
        <th>{{ column }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
      <tr>
        {% for column in selected_columns %}
        <td>{{ row[column] }}</td>
        {% endfor %}
      </tr>
      {% else %}
      <tr><td colspan="{{ selected_columns|length if selected_columns else 1 }}">No rows found for selected filters.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="card section-divider">
  <h2>Email Extract Request</h2>
  <p>Queue a delivery request. The request metadata is captured for downstream email processing.</p>
  <form method="post" action="/reports/email" class="grid grid-3">
    <input type="hidden" name="report_type" value="{{ filters.report_type }}">
    <input type="hidden" name="search" value="{{ filters.search }}">
    <input type="hidden" name="vendor" value="{{ filters.vendor }}">
    <input type="hidden" name="lifecycle_state" value="{{ filters.lifecycle_state }}">
    <input type="hidden" name="project_status" value="{{ filters.project_status }}">
    <input type="hidden" name="outcome" value="{{ filters.outcome }}">
    <input type="hidden" name="owner_principal" value="{{ filters.owner_principal }}">
    <input type="hidden" name="org" value="{{ filters.org }}">
    <input type="hidden" name="horizon_days" value="{{ filters.horizon_days }}">
    <input type="hidden" name="limit" value="{{ filters.limit }}">
    <input type="hidden" name="cols" value="{{ selected_columns|join(',') }}">
    <label>
      To
      <input type="email" name="email_to" placeholder="recipient@example.com" required>
    </label>
    <label>
      Subject
      <input type="text" name="email_subject" placeholder="{{ selected_report.label }} Extract">
    </label>
    <div style="display:flex; align-items:flex-end;">
      <button type="submit">Queue Email Request</button>
    </div>
  </form>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll("[data-columns-form]").forEach((form) => {
  const target = form.querySelector("[data-cols-target]");
  if (!target) return;
  form.addEventListener("submit", () => {
    const selected = Array.from(form.querySelectorAll("[data-column-toggle]:checked")).map((el) => el.value);
    target.value = selected.join(",");
  });
});
</script>
{% endblock %}
