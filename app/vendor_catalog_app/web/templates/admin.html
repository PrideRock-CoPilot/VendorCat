{% extends "base.html" %}
{% block content %}
<h1>Admin Permissions</h1>

<section class="card">
  <h2>Role Catalog</h2>
  <table>
    <thead>
      <tr>
        <th>Role Code</th>
        <th>Name</th>
        <th>Approval</th>
        <th>Edit</th>
        <th>Report</th>
        <th>Direct Apply</th>
        <th>Change Permissions</th>
      </tr>
    </thead>
    <tbody>
      {% for row in role_definitions %}
      <tr>
        <td>{{ row.role_code }}</td>
        <td>{{ row.role_name }}</td>
        <td>{{ row.approval_level }}</td>
        <td>{{ row.can_edit }}</td>
        <td>{{ row.can_report }}</td>
        <td>{{ row.can_direct_apply }}</td>
        <td>{{ row.actions_summary }}</td>
      </tr>
      {% else %}
      <tr><td colspan="7">No roles configured.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="card">
  <h2>Create Or Update Role</h2>
  <form method="post" action="/admin/roles/save" class="grid grid-2">
    <label>Role Code
      <input list="role-code-options" type="text" name="role_code" placeholder="vendor_editor" required>
      <datalist id="role-code-options">
        {% for role_code in role_code_options %}
        <option value="{{ role_code }}"></option>
        {% endfor %}
      </datalist>
    </label>
    <label>Role Name
      <input type="text" name="role_name" placeholder="Vendor Editor" required>
    </label>
    <label class="full">Description
      <input type="text" name="description" placeholder="Describe what this role can do.">
    </label>
    <label>Approval Level
      <select name="approval_level">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
      </select>
    </label>
    <div class="full inline-form">
      <label><input type="checkbox" name="can_edit"> Can Edit</label>
      <label><input type="checkbox" name="can_report"> Can Report</label>
      <label><input type="checkbox" name="can_direct_apply"> Can Direct Apply</label>
    </div>
    <div class="full">
      <h3>Per-Action Change Permissions</h3>
      <div class="role-permission-grid">
        {% for action in change_actions %}
        <label class="role-permission-option">
          <input type="checkbox" name="perm_{{ action }}">
          <span>{{ action }}</span>
        </label>
        {% endfor %}
      </div>
    </div>
    <div><button type="submit">Save Role</button></div>
  </form>
</section>

<div class="grid grid-2">
  <section class="card">
    <h2>Role Grants</h2>
    <table>
      <thead><tr><th>User</th><th>Role</th><th>Active</th><th>Granted By</th><th>Granted At</th></tr></thead>
      <tbody>
        {% for row in role_rows %}
        <tr>
          <td>{{ row.user_principal }}</td>
          <td>{{ row.role_code }}</td>
          <td>{{ row.active_flag }}</td>
          <td>{{ row.granted_by }}</td>
          <td>{{ row.granted_at }}</td>
        </tr>
        {% else %}
        <tr><td colspan="5">No role grants</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
  <section class="card">
    <h2>Org Scope Grants</h2>
    <table>
      <thead><tr><th>User</th><th>Org</th><th>Scope</th><th>Active</th><th>Granted At</th></tr></thead>
      <tbody>
        {% for row in scope_rows %}
        <tr>
          <td>{{ row.user_principal }}</td>
          <td>{{ row.org_id }}</td>
          <td>{{ row.scope_level }}</td>
          <td>{{ row.active_flag }}</td>
          <td>{{ row.granted_at }}</td>
        </tr>
        {% else %}
        <tr><td colspan="5">No scope grants</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<div class="grid grid-2">
  <section class="card">
    <h2>Grant Role</h2>
    <form method="post" action="/admin/grant-role" class="grid grid-1">
      <label>User Principal<input type="text" name="target_user" required></label>
      <label>Role
        <select name="role_code">
          {% for role in grantable_roles %}
          <option value="{{ role }}">{{ role }}</option>
          {% endfor %}
        </select>
      </label>
      <div><button type="submit">Grant Role</button></div>
    </form>
  </section>
  <section class="card">
    <h2>Grant Org Scope</h2>
    <form method="post" action="/admin/grant-scope" class="grid grid-1">
      <label>User Principal<input type="text" name="target_user" required></label>
      <label>Org ID<input type="text" name="org_id" required></label>
      <label>Scope Level
        <select name="scope_level">
          <option value="read">read</option>
          <option value="edit">edit</option>
          <option value="full">full</option>
        </select>
      </label>
      <div><button type="submit">Grant Scope</button></div>
    </form>
  </section>
</div>
{% endblock %}
