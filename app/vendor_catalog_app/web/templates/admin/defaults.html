{% extends "base.html" %}

{% block head %}
  <link rel="stylesheet" href="/static/css/admin_portal.css">
{% endblock %}

{% block content %}
<div class="section-header">
  <div>
    <h1>Defaults Catalog</h1>
    <p>Manage controlled option lists with history and effective-date support.</p>
  </div>
</div>

{% include "admin/_nav.html" %}

<section class="card">
  <h2>Filter Catalog</h2>
  <form method="get" action="/admin/defaults" class="inline-form" style="margin-top:8px;">
    <label>Category
      <select name="lookup_type" required>
        {% for lookup_type in lookup_type_options %}
        <option value="{{ lookup_type }}" {% if lookup_type == selected_lookup_type %}selected{% endif %}>{{ lookup_type_labels.get(lookup_type, lookup_type) }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Status
      <select name="status">
        <option value="active" {% if selected_lookup_status == 'active' %}selected{% endif %}>active</option>
        <option value="historical" {% if selected_lookup_status == 'historical' %}selected{% endif %}>historical</option>
        <option value="future" {% if selected_lookup_status == 'future' %}selected{% endif %}>future</option>
        <option value="all" {% if selected_lookup_status == 'all' %}selected{% endif %}>all</option>
      </select>
    </label>
    <label>As Of
      <input type="date" name="as_of" value="{{ selected_as_of }}">
    </label>
    <label>Page Size
      <select name="page_size">
        {% for size in [10, 25, 50, 100] %}
        <option value="{{ size }}" {% if defaults_pager.page_size == size %}selected{% endif %}>{{ size }}</option>
        {% endfor %}
      </select>
    </label>
    <button type="submit">View</button>
  </form>
</section>

<section class="card">
  <h2>{{ lookup_type_labels.get(selected_lookup_type, selected_lookup_type) }}</h2>
  <p>Sort order auto-resequences only options active in the same date window.</p>
  {% set pager = defaults_pager %}
  {% include "admin/_pagination.html" %}
  <table>
    <thead>
      <tr>
        <th>Label</th>
        <th>Sort</th>
        <th>Status</th>
        <th>Valid From</th>
        <th>Valid To</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for row in selected_lookup_rows %}
      <tr>
        <td>
          <input type="text" name="option_label" value="{{ row.option_label }}" aria-label="Label for {{ row.option_code }}" form="save-opt-{{ loop.index }}">
        </td>
        <td>
          <input type="number" name="sort_order" min="1" step="1" value="{{ row.sort_order }}" aria-label="Sort for {{ row.option_code }}" form="save-opt-{{ loop.index }}">
        </td>
        <td>{{ row.status }}</td>
        <td><input type="date" name="valid_from_ts" value="{{ row.valid_from_ts }}" form="save-opt-{{ loop.index }}"></td>
        <td><input type="date" name="valid_to_ts" value="{{ row.valid_to_ts }}" form="save-opt-{{ loop.index }}"></td>
        <td>
          <div class="inline-form">
            <form id="save-opt-{{ loop.index }}" method="post" action="/admin/lookup/save" class="inline-form">
              <input type="hidden" name="lookup_type" value="{{ selected_lookup_type }}">
              <input type="hidden" name="lookup_status" value="{{ selected_lookup_status }}">
              <input type="hidden" name="as_of" value="{{ selected_as_of }}">
              <input type="hidden" name="option_id" value="{{ row.option_id }}">
              <input type="hidden" name="option_code" value="{{ row.option_code }}">
              <button type="submit">Save</button>
            </form>
            <form method="post" action="/admin/lookup/delete" class="inline-form">
              <input type="hidden" name="lookup_type" value="{{ selected_lookup_type }}">
              <input type="hidden" name="lookup_status" value="{{ selected_lookup_status }}">
              <input type="hidden" name="as_of" value="{{ selected_as_of }}">
              <input type="hidden" name="option_id" value="{{ row.option_id }}">
              <button type="submit">Remove</button>
            </form>
          </div>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6">No options found for this category.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="card" style="margin-top:12px;">
  <h2>Add Option</h2>
  <form method="post" action="/admin/lookup/save" class="inline-form">
    <input type="hidden" name="lookup_type" value="{{ selected_lookup_type }}">
    <input type="hidden" name="lookup_status" value="{{ selected_lookup_status }}">
    <input type="hidden" name="as_of" value="{{ selected_as_of }}">
    <input type="hidden" name="option_id" value="">
    <input type="hidden" name="option_code" value="">
    <input type="text" name="option_label" placeholder="New label" aria-label="New option label">
    <input type="number" name="sort_order" value="{{ next_lookup_sort_order }}" min="1" step="1" aria-label="New option sort order">
    <input type="date" name="valid_from_ts" value="{{ selected_as_of }}" aria-label="New option valid from">
    <input type="date" name="valid_to_ts" value="9999-12-31" aria-label="New option valid to">
    <button type="submit">Add Option</button>
  </form>
</section>
{% endblock %}
