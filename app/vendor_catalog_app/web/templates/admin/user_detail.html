{% extends "base.html" %}

{% block head %}
  <link rel="stylesheet" href="/static/css/admin_portal.css">
{% endblock %}

{% block content %}
<div class="section-header">
  <div>
    <h1>User Access Detail</h1>
    <p>{{ subject_display_name }} ({{ subject_principal }})</p>
  </div>
</div>

{% include "admin/_nav.html" %}

<section class="card">
  <h2>Effective Access Summary</h2>
  <p><strong>Roles:</strong> {{ effective_role_summary }}</p>
  <p><strong>Line of Business Access:</strong> {{ effective_scope_summary }}</p>
</section>

<div class="grid grid-2 admin-grants-grid">
  <section class="card">
    <h2>User Role Grants</h2>
    {% set pager = role_pager %}
    {% include "admin/_pagination.html" %}
    <table>
      <thead><tr><th>Role</th><th>Active</th><th>Granted By</th><th>Granted At</th><th>Actions</th></tr></thead>
      <tbody>
        {% for row in role_rows %}
        {% set is_active = row.active_flag in [True, 1, "1", "true", "True"] %}
        <tr>
          <td><a href="/admin/roles/{{ row.role_code }}">{{ row.role_code }}</a></td>
          <td>{{ row.active_flag }}</td>
          <td>{{ row.granted_by }}</td>
          <td>{{ row.granted_at }}</td>
          <td>
            {% if is_active %}
            <div class="inline-form">
              <form method="post" action="/admin/change-role" class="inline-form">
                <input type="hidden" name="target_user" value="{{ subject_principal }}">
                <input type="hidden" name="current_role_code" value="{{ row.role_code }}">
                <select name="new_role_code">
                  {% for role in grantable_roles %}
                  <option value="{{ role }}" {% if role == row.role_code %}selected{% endif %}>{{ role }}</option>
                  {% endfor %}
                </select>
                <button type="submit">Change</button>
              </form>
              <form method="post" action="/admin/revoke-role" class="inline-form">
                <input type="hidden" name="target_user" value="{{ subject_principal }}">
                <input type="hidden" name="role_code" value="{{ row.role_code }}">
                <button type="submit">Revoke</button>
              </form>
            </div>
            {% else %}
            <span class="muted">revoked</span>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr><td colspan="5">No role grants for this user.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <h3 style="margin-top:10px;">Grant Role</h3>
    <form method="post" action="/admin/grant-role" class="inline-form" style="margin-top:10px;">
      <input type="hidden" name="target_user" value="{{ subject_principal }}">
      <label>Role
        <select name="role_code">
          {% for role in grantable_roles %}
          <option value="{{ role }}">{{ role }}</option>
          {% endfor %}
        </select>
      </label>
      <button type="submit">Grant Role</button>
    </form>
  </section>

  <section class="card">
    <h2>Line of Business Access</h2>
    {% set pager = scope_pager %}
    {% include "admin/_pagination.html" %}
    <table>
      <thead><tr><th>Line of Business</th><th>Access Level</th><th>Active</th><th>Granted At</th><th>Actions</th></tr></thead>
      <tbody>
        {% for row in scope_rows %}
        {% set is_active = row.active_flag in [True, 1, "1", "true", "True"] %}
        <tr>
          <td>{{ row.org_id }}</td>
          <td>{{ row.scope_level }}</td>
          <td>{{ row.active_flag }}</td>
          <td>{{ row.granted_at }}</td>
          <td>
            {% if is_active %}
            <form method="post" action="/admin/revoke-scope" class="inline-form">
              <input type="hidden" name="target_user" value="{{ subject_principal }}">
              <input type="hidden" name="org_id" value="{{ row.org_id }}">
              <input type="hidden" name="scope_level" value="{{ row.scope_level }}">
              <button type="submit">Revoke</button>
            </form>
            {% else %}
            <span class="muted">revoked</span>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr><td colspan="5">No Line of Business access grants for this user.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <h3 style="margin-top:10px;">Grant Line of Business Access</h3>
    <form method="post" action="/admin/grant-scope" class="grid grid-1" style="margin-top:10px;">
      <input type="hidden" name="target_user" value="{{ subject_principal }}">
      <label>Line of Business
        <input type="text" name="lob_id" required>
      </label>
      <label>Access Level
        <select name="scope_level">
          <option value="none">None</option>
          <option value="read">View</option>
          <option value="edit">Edit</option>
          <option value="full">Full</option>
        </select>
      </label>
      <button type="submit">Grant Access</button>
    </form>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/admin_portal.js"></script>
{% endblock %}
