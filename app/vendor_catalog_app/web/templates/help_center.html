{% extends "base.html" %}
{% block content %}
<div class="help-layout">
  <aside class="help-nav" aria-label="Help navigation">
    <form method="get" action="/help" class="help-search">
      <label>
        Search Help
        <input type="text" name="q" value="{{ search_query or '' }}" placeholder="Search help topics" aria-label="Search help">
      </label>
      <button type="submit">Search</button>
    </form>
    <a class="help-all-link {% if not help_active_slug %}active{% endif %}" href="/help">All Articles</a>
    {% for section in nav_sections %}
    <div class="help-section">
      <div class="help-section-title">{{ section.section }}</div>
      <ul>
        {% for item in section["items"] %}
        <li>
          <a class="{% if help_active_slug == item.slug %}active{% endif %}" href="/help/{{ item.slug }}">{{ item.title }}</a>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endfor %}
  </aside>

  <section class="help-main">
    {% if article_missing %}
    <div class="card help-card">
      <h1>Article Not Found</h1>
      <p>We could not find this help page. Try search or open the list on the left.</p>
    </div>
    {% elif article_forbidden %}
    <div class="card help-card">
      <h1>Limited Access</h1>
      <p>This help page needs a higher role. Ask your admin for access.</p>
      <p>If you think this is a mistake, open a help issue from another page.</p>
    </div>
    {% elif article %}
    <article class="card help-card">
      <div class="help-article-header">
        <div>
          <h1>{{ article.title }}</h1>
          <div class="help-article-meta">
            <span>Section: {{ article.section }}</span>
            <span>Owned by: {{ article.owned_by }}</span>
            <span>Last updated: {{ article.updated_at }}</span>
          </div>
        </div>
        <div class="help-article-actions">
          <button type="button" class="button-link subtle" data-help-copy-link data-help-link="/help/{{ article.slug }}">Copy link</button>
        </div>
      </div>
      <div class="help-callout">
        <h3>Training shortcuts</h3>
        <ul>
          <li><a href="/help/quick-start">Quick Start</a></li>
          <li><a href="/help/troubleshooting-common-issues">Troubleshooting common issues</a></li>
          <li><a href="/help/demo-outcomes-overview">Track demo outcomes</a></li>
        </ul>
        <p class="muted">Tip: Use search to jump to role-specific steps.</p>
      </div>
      <div class="help-article-body">
        {{ article_html | safe }}
      </div>
      <div class="help-article-feedback">
        <h2>Was this helpful?</h2>
        <form method="post" action="/help/feedback" class="help-feedback-form">
          <input type="hidden" name="article_id" value="{{ article.article_id }}">
          <input type="hidden" name="article_slug" value="{{ article.slug }}">
          <input type="hidden" name="page_path" value="{{ request.url.path }}">
          <input type="hidden" name="return_to" value="{{ request.url.path }}">
          <div class="help-feedback-actions">
            <button type="submit" name="was_helpful" value="1">Thumb up</button>
            <button type="submit" name="was_helpful" value="0" class="button-link subtle">Thumb down</button>
          </div>
          <label>Optional comment
            <input type="text" name="comment" placeholder="Tell us what was missing">
          </label>
        </form>
      </div>
      <div class="help-article-issue">
        <details>
          <summary>Report an issue</summary>
          <form method="post" action="/help/report" class="help-issue-form">
            <input type="hidden" name="article_id" value="{{ article.article_id }}">
            <input type="hidden" name="article_slug" value="{{ article.slug }}">
            <input type="hidden" name="page_path" value="{{ request.url.path }}">
            <input type="hidden" name="return_to" value="{{ request.url.path }}">
            <label>Title
              <input type="text" name="issue_title" placeholder="Short issue title" required>
            </label>
            <label>Description
              <textarea name="issue_description" rows="4" placeholder="What is wrong or missing?" required></textarea>
            </label>
            <div>
              <button type="submit">Send Issue</button>
            </div>
          </form>
        </details>
      </div>
    </article>
    {% elif search_query %}
    <div class="card help-card">
      <h1>Search Results</h1>
      {% if search_results %}
      <ul class="help-search-results">
        {% for row in search_results %}
        <li data-help-result data-help-result-slug="{{ row.slug }}">
          <a href="/help/{{ row.slug }}">{{ row.title }}</a>
          <div class="help-search-meta">{{ row.section }}</div>
          {% if row.snippet %}<p>{{ row.snippet }}</p>{% endif %}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p>No matches found. Try shorter words or a different phrase.</p>
      {% endif %}
    </div>
    {% elif show_index %}
    <div class="card help-card">
      <h1>Help Center</h1>
      <p>Pick a topic from the left or start with Quick Start.</p>
      <div class="help-training">
        <h2>Training paths</h2>
        <p class="muted">Follow a guided sequence to build skills fast.</p>
        <div class="help-training-grid">
          <article class="help-training-card">
            <div class="help-training-header">Onboard a vendor</div>
            <p>From first record to a complete profile.</p>
            <ol class="help-path-list">
              <li><a href="/help/add-vendor">Add a new vendor</a></li>
              <li><a href="/help/add-offering">Add an offering</a></li>
              <li><a href="/help/add-document-link">Add a document link</a></li>
              <li><a href="/help/edit-vendor-details">Edit vendor details</a></li>
            </ol>
          </article>
          <article class="help-training-card">
            <div class="help-training-header">Deliver a project</div>
            <p>Plan, link, and track demos end-to-end.</p>
            <ol class="help-path-list">
              <li><a href="/help/create-project">Create a project</a></li>
              <li><a href="/help/link-vendors-offerings-to-project">Link vendors and offerings</a></li>
              <li><a href="/help/add-project-demo">Add a demo to a project</a></li>
              <li><a href="/help/project-detail">Read a project detail page</a></li>
            </ol>
          </article>
          <article class="help-training-card">
            <div class="help-training-header">Admin essentials</div>
            <p>Manage roles and keep data clean.</p>
            <ol class="help-path-list">
              <li><a href="/help/admin-portal-overview">Admin portal overview</a></li>
              <li><a href="/help/admin-manage-permissions">Manage user permissions</a></li>
              <li><a href="/help/admin-manage-lookups">Add or edit lookup values</a></li>
              <li><a href="/help/admin-audit-logs">View audit logs</a></li>
            </ol>
          </article>
        </div>
      </div>
      <div class="help-index">
        {% for section in nav_sections %}
        <div class="help-index-section">
          <h2>{{ section.section }}</h2>
          <ul>
              {% for item in section["items"] %}
            <li><a href="/help/{{ item.slug }}">{{ item.title }}</a></li>
            {% endfor %}
          </ul>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </section>
</div>
{% endblock %}
