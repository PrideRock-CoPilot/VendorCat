{% extends "base.html" %}
{% block content %}
<h1>Contracts Hub</h1>
<p class="muted">Cross-vendor contract summary with drill-down views for vendor-level and offering-level agreements.</p>

<section class="metrics">
  <div class="metric"><span>Total Contracts</span><strong>{{ metrics.total_contracts }}</strong></div>
  <div class="metric"><span>Active Contracts</span><strong>{{ metrics.active_contracts }}</strong></div>
  <div class="metric"><span>Vendor-Level</span><strong>{{ metrics.vendor_level_contracts }}</strong></div>
  <div class="metric"><span>Offering-Level</span><strong>{{ metrics.offering_level_contracts }}</strong></div>
  <div class="metric"><span>Expiring ({{ expiring_window_days }}d)</span><strong>{{ metrics.expiring_window_contracts }}</strong></div>
  <div class="metric"><span>Cancelled</span><strong>{{ metrics.cancelled_contracts }}</strong></div>
</section>

<section class="card">
  <form method="get" class="grid grid-5 form-grid">
    <input type="hidden" name="tab" value="{{ active_tab }}">
    <label>
      Search
      <input type="search" name="q" value="{{ search_text }}" placeholder="Contract, vendor, offering">
    </label>
    <label>
      Status
      <select name="status">
        {% for code in status_options %}
        <option value="{{ code }}" {% if code == selected_status %}selected{% endif %}>{{ code }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      Scope
      <select name="scope">
        {% for code in scope_options %}
        <option value="{{ code }}" {% if code == selected_scope %}selected{% endif %}>{{ code }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      Max Rows
      <input type="number" name="limit" min="25" max="5000" step="25" value="{{ selected_limit }}">
    </label>
    <div class="form-actions button-group">
      <button type="submit">Apply</button>
      <a class="button-link subtle" href="/contracts?tab={{ active_tab }}">Reset</a>
    </div>
  </form>
  <p class="muted">Annual value total: ${{ "{:,.2f}".format(metrics.annual_value_total) }}</p>
</section>

<section class="card section-nav-card">
  <div class="section-nav-links">
    {% for tab in tab_links %}
    <a href="{{ tab.href }}" class="{{ 'active' if tab.active else '' }}">{{ tab.label }}</a>
    {% endfor %}
  </div>
</section>

{% if active_tab == 'overview' %}
<section class="grid grid-2">
  <article class="card">
    <h2>Status Snapshot</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Status</th><th>Count</th></tr></thead>
        <tbody>
          {% for row in status_rows %}
          <tr>
            <td>{{ row.status }}</td>
            <td>{{ row.count }}</td>
          </tr>
          {% else %}
          <tr><td colspan="2">No data</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </article>

  <article class="card">
    <h2>Expiring Within {{ expiring_window_days }} Days</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Contract</th><th>Vendor</th><th>End Date</th><th>Days</th></tr></thead>
        <tbody>
          {% for row in overview_rows %}
          <tr>
            <td>{{ row.contract_number if row.contract_number else row.contract_id }}</td>
            <td>{{ row.vendor_display_name }}</td>
            <td>{{ row.end_date }}</td>
            <td>{{ row.days_to_end if row.days_to_end is not none else '--' }}</td>
          </tr>
          {% else %}
          <tr><td colspan="4">No contracts in the expiring window.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </article>
</section>

<section class="grid grid-2">
  <article class="card">
    <h2>Top Vendors By Contract Count</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Vendor</th><th>Contracts</th><th>Annual Value</th></tr></thead>
        <tbody>
          {% for row in vendor_summary_rows %}
          <tr>
            <td>{{ row.vendor_display_name }}</td>
            <td>{{ row.contract_count }}</td>
            <td>${{ "{:,.2f}".format(row.annual_value or 0) }}</td>
          </tr>
          {% else %}
          <tr><td colspan="3">No data</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </article>

  <article class="card">
    <h2>Top Offerings By Contract Count</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Offering</th><th>Vendor</th><th>Contracts</th><th>Annual Value</th></tr></thead>
        <tbody>
          {% for row in offering_summary_rows %}
          <tr>
            <td>{{ row.offering_name }}</td>
            <td>{{ row.vendor_display_name }}</td>
            <td>{{ row.contract_count }}</td>
            <td>${{ "{:,.2f}".format(row.annual_value or 0) }}</td>
          </tr>
          {% else %}
          <tr><td colspan="4">No offering-level contracts found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </article>
</section>

<section class="card">
  <h2>Recent Cancellations</h2>
  <div class="table-wrap">
    <table>
      <thead><tr><th>Contract</th><th>Vendor</th><th>Offering</th><th>Cancelled At</th><th>Reason</th><th>Notes</th><th></th></tr></thead>
      <tbody>
        {% for row in cancellation_rows %}
        <tr>
          <td>{{ row.contract_id }}</td>
          <td>{{ row.vendor_id }}</td>
          <td>{{ row.offering_id }}</td>
          <td>{{ row.cancelled_at }}</td>
          <td>{{ row.reason_code }}</td>
          <td>{{ row.notes }}</td>
          <td>{% if row.vendor_contract_url %}<a href="{{ row.vendor_contract_url }}">Open</a>{% endif %}</td>
        </tr>
        {% else %}
        <tr><td colspan="7">No contract cancellations found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% else %}
<section class="card">
  <h2>{{ tab_title }}</h2>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Contract</th>
          <th>Vendor</th>
          <th>Offering</th>
          <th>Scope</th>
          <th>Status</th>
          <th>Start</th>
          <th>End</th>
          <th>Days To End</th>
          <th>Annual Value</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for row in selected_rows %}
        <tr>
          <td>{{ row.contract_number if row.contract_number else row.contract_id }}<br><span class="muted">{{ row.contract_id }}</span></td>
          <td>{{ row.vendor_display_name }}<br><span class="muted">{{ row.vendor_id }}</span></td>
          <td>{{ row.offering_name if row.offering_id else 'Unassigned' }}</td>
          <td>{{ row.contract_scope }}</td>
          <td>{{ row.contract_status if row.contract_status else 'unknown' }}</td>
          <td>{{ row.start_date }}</td>
          <td>{{ row.end_date }}</td>
          <td>{{ row.days_to_end if row.days_to_end is not none else '--' }}</td>
          <td>${{ "{:,.2f}".format(row.annual_value or 0) }}</td>
          <td>{% if row.vendor_contract_url %}<a href="{{ row.vendor_contract_url }}">Open</a>{% endif %}</td>
        </tr>
        {% else %}
        <tr><td colspan="10">No contracts found for the selected filters.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

{% if active_tab == 'cancelled' %}
<section class="card">
  <h2>Cancellation Events</h2>
  <div class="table-wrap">
    <table>
      <thead><tr><th>Contract</th><th>Vendor</th><th>Offering</th><th>Cancelled At</th><th>Reason</th><th>Notes</th></tr></thead>
      <tbody>
        {% for row in cancellation_rows %}
        <tr>
          <td>{{ row.contract_id }}</td>
          <td>{{ row.vendor_id }}</td>
          <td>{{ row.offering_id }}</td>
          <td>{{ row.cancelled_at }}</td>
          <td>{{ row.reason_code }}</td>
          <td>{{ row.notes }}</td>
        </tr>
        {% else %}
        <tr><td colspan="6">No cancellation events found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}
{% endif %}

<section class="card">
  <h2>Manage Contracts In Vendor 360</h2>
  <p class="muted">
    Contract creation, updates, and cancellation actions are managed under each vendor and offering.
    Use <strong>Vendor 360 -> Contracts</strong> or <strong>Vendor 360 -> Offerings -> Delivery</strong>.
  </p>
</section>
{% endblock %}
