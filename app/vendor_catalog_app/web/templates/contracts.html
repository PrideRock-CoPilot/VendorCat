{% extends "base.html" %}
{% block content %}
<h1>Contract Cancellations</h1>

<section class="card">
  <table>
    <thead><tr><th>Contract</th><th>Vendor</th><th>Offering</th><th>Cancelled At</th><th>Reason</th><th>Notes</th></tr></thead>
    <tbody>
      {% for row in rows %}
      <tr>
        <td>{{ row.contract_id }}</td>
        <td>{{ row.vendor_id }}</td>
        <td>{{ row.offering_id }}</td>
        <td>{{ row.cancelled_at }}</td>
        <td>{{ row.reason_code }}</td>
        <td>{{ row.notes }}</td>
      </tr>
      {% else %}
      <tr><td colspan="6">No contract cancellations</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

{% if can_edit %}
<section class="card">
  <h2>Record Contract Cancellation</h2>
  <form method="post" action="/contracts/cancel" class="grid grid-2">
    <label>Contract ID
      <div class="typeahead-block">
        <input type="text" name="contract_id" required autocomplete="off" data-contract-search placeholder="Search contract number, id, vendor, or offering...">
        <div class="typeahead-results hidden" data-contract-results></div>
      </div>
      <small class="muted">Selecting a result auto-fills the contract ID.</small>
    </label>
    <label>Reason Code<input type="text" name="reason_code" required></label>
    <label class="full">Notes<textarea name="notes" rows="2"></textarea></label>
    <div><button type="submit">Record Cancellation</button></div>
  </form>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
(() => {
  const input = document.querySelector("input[data-contract-search]");
  const results = document.querySelector("[data-contract-results]");
  if (!input || !results) return;

  let timer = null;
  let requestSeq = 0;

  const hideResults = () => {
    results.innerHTML = "";
    results.classList.add("hidden");
  };

  const renderResults = (items) => {
    results.innerHTML = "";
    if (!items.length) {
      hideResults();
      return;
    }
    items.forEach((item) => {
      const contractId = String(item.contract_id || "").trim();
      if (!contractId) return;
      const option = document.createElement("button");
      option.type = "button";
      option.className = "typeahead-option";
      option.textContent = String(item.label || contractId).trim();
      option.addEventListener("click", () => {
        input.value = contractId;
        hideResults();
      });
      results.appendChild(option);
    });
    if (!results.children.length) {
      hideResults();
      return;
    }
    results.classList.remove("hidden");
  };

  const search = async () => {
    const query = String(input.value || "").trim();
    if (!query) {
      hideResults();
      return;
    }
    const seq = requestSeq + 1;
    requestSeq = seq;
    try {
      const response = await fetch(`/api/contracts/search?q=${encodeURIComponent(query)}&limit=15`);
      if (!response.ok) {
        hideResults();
        return;
      }
      const payload = await response.json();
      if (seq !== requestSeq) return;
      renderResults(Array.isArray(payload.items) ? payload.items : []);
    } catch {
      hideResults();
    }
  };

  input.addEventListener("input", () => {
    if (timer) window.clearTimeout(timer);
    timer = window.setTimeout(search, 180);
  });

  document.addEventListener("click", (event) => {
    if (!results.contains(event.target) && event.target !== input) {
      hideResults();
    }
  });
})();
</script>
{% endblock %}

